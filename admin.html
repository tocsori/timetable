<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê´€ë¦¬ì í˜ì´ì§€ - ì‹œê°„í‘œ ì‹œìŠ¤í…œ</title>
    <style>
        :root { --accent: #4a90e2; }
        body { font-family: 'Malgun Gothic', sans-serif; padding: 20px; background: #f0f2f5; color: #333; line-height: 1.5; }
        .section { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 30px; max-width: 800px; margin-left: auto; margin-right: auto; }
        .btn { padding: 8px 16px; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin: 5px; }
        .btn:hover { opacity: 0.8; }
        .btn-danger { background: #dc3545; }
        .btn-success { background: #28a745; }
        input, select { border: 1px solid #ddd; border-radius: 4px; padding: 8px; font-family: inherit; font-size: 14px; margin: 5px; }
        .nav-buttons { text-align: right; margin-bottom: 20px; }
        .info-box { background: #e7f3ff; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid var(--accent); }
        .warning-box { background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #ffc107; }
        .preference-settings { margin-top: 5px; padding: 15px; background: #f8f9fa; border-radius: 8px; }
        .preference-item { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; flex-wrap: wrap; }
        .preference-item select { width: 200px; }
        .preference-item strong { min-width: 60px; }
    </style>
</head>
<body>

<div class="nav-buttons">
    <button class="btn" onclick="history.back()">ì´ì „ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</button>
</div>

<div class="section">
    <h2>âš™ï¸ ê´€ë¦¬ì ì„¤ì •</h2>
    
    <div class="info-box">
        <h3>í•™ê¸‰ ìˆ˜ ì„¤ì •</h3>
        <p>ì‹œê°„í‘œ ì‹œìŠ¤í…œì—ì„œ ì‚¬ìš©í•  í•™ê¸‰ ìˆ˜ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. í•™ê¸‰ ìˆ˜ë¥¼ ë³€ê²½í•˜ë©´ í•´ë‹¹í•˜ëŠ” ëª¨ë“  í•™ê¸‰ì˜ ì‹œê°„í‘œê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.</p>
        <div style="margin-top: 15px;">
            <label><strong>í•™ê¸‰ ìˆ˜:</strong></label>
            <input type="number" id="classCount" value="5" min="1" max="20" style="width:80px">
            <button class="btn btn-success" onclick="updateClassCount()">í•™ê¸‰ ìˆ˜ ë³€ê²½</button>
        </div>
    </div>
    
    <div class="info-box">
        <h3>êµì‹œ ìˆ˜ ì„¤ì •</h3>
        <p>ì‹œê°„í‘œì—ì„œ ì‚¬ìš©í•  êµì‹œ ìˆ˜ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. êµì‹œ ìˆ˜ë¥¼ ë³€ê²½í•˜ë©´ ëª¨ë“  ì‹œê°„í‘œê°€ ì¬êµ¬ì„±ë©ë‹ˆë‹¤.</p>
        <div style="margin-top: 15px;">
            <label><strong>êµì‹œ ìˆ˜:</strong></label>
            <input type="number" id="periodCount" value="6" min="1" max="8" style="width:80px">
            <button class="btn btn-success" onclick="updatePeriodCount()">êµì‹œ ìˆ˜ ë³€ê²½</button>
        </div>
    </div>
    
    <div class="warning-box">
        <h3>âš ï¸ ì£¼ì˜ì‚¬í•­</h3>
        <ul>
            <li>í•™ê¸‰ ìˆ˜ë¥¼ ì¤„ì´ë©´ ì‚­ì œëœ í•™ê¸‰ì˜ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>
            <li>í•™ê¸‰ ìˆ˜ë¥¼ ëŠ˜ë¦¬ë©´ ìƒˆ í•™ê¸‰ì˜ ì‹œê°„í‘œëŠ” ë¹„ì–´ìˆëŠ” ìƒíƒœë¡œ ìƒì„±ë©ë‹ˆë‹¤.</li>
            <li>ë³€ê²½ ì‚¬í•­ì€ ì¦‰ì‹œ ì €ì¥ë˜ë©°, ë©”ì¸ í˜ì´ì§€ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        </ul>
    </div>
    
    <div class="info-box">
        <h3>ğŸ“Œ ê³¼ëª©ë³„ ì„ í˜¸êµì‹œ ì„¤ì •</h3>
        <p>ê° ê³¼ëª©ì˜ ì„ í˜¸í•˜ëŠ” êµì‹œë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìë™ ì±„ìš°ê¸° ê¸°ëŠ¥ ì‚¬ìš© ì‹œ ì´ ì„¤ì •ì„ ìš°ì„ ì ìœ¼ë¡œ ê³ ë ¤í•©ë‹ˆë‹¤.</p>
        <div class="preference-settings">
            <div id="preferenceContainer"></div>
        </div>
    </div>
    
    <div class="info-box">
        <h3>ë°ì´í„° ê´€ë¦¬</h3>
        <p>ì „ì²´ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ê±°ë‚˜ ë°±ì—…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        <div style="margin-top: 15px;">
            <button class="btn btn-danger" onclick="resetAllData()">ì „ì²´ ë°ì´í„° ì´ˆê¸°í™”</button>
            <button class="btn" onclick="exportAllData()">ì „ì²´ ë°ì´í„° ë°±ì—…</button>
            <button class="btn" onclick="document.getElementById('backupInput').click()">ë°±ì—… ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <input type="file" id="backupInput" accept=".json" onchange="importBackup(event)" style="display:none">
        </div>
    </div>
</div>

<script>
const allSubjects = ["êµ­ì–´", "ì‚¬íšŒ", "ë„ë•", "ìˆ˜í•™", "ê³¼í•™", "ì‹¤ê³¼", "ì²´ìœ¡", "ìŒì•…", "ë¯¸ìˆ ", "ì˜ì–´", "ì°½ì²´(ì)", "ì°½ì²´(ë™)", "ì°½ì²´(ë´‰)", "ì°½ì²´(ì§„)"];

function init() {
    // ë¡œê·¸ì¸ ì²´í¬
    const loginInfo = localStorage.getItem('timetable_login');
    if (!loginInfo) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        window.location.href = 'login.html';
        return;
    }
    
    // ì„œë²„ì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    loadDataFromServer();
}

// ì„œë²„ì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
function loadDataFromServer() {
    const loginInfo = JSON.parse(localStorage.getItem('timetable_login'));
    const nickname = loginInfo.nickname;
    
    fetch(`${window.location.origin}/api/data?nickname=${encodeURIComponent(nickname)}`)
        .then(response => response.json())
        .then(result => {
            if (result.success && result.data) {
                const state = result.data;
                document.getElementById('classCount').value = state.classCount || 5;
                document.getElementById('periodCount').value = state.periodCount || 6;
            } else {
                document.getElementById('classCount').value = 5;
                document.getElementById('periodCount').value = 6;
            }
            renderPreferences();
        })
        .catch(error => {
            console.error('ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
            document.getElementById('classCount').value = 5;
            document.getElementById('periodCount').value = 6;
            renderPreferences();
        });
}

// ì„œë²„ì— ë°ì´í„° ì €ì¥
function saveDataToServer(state) {
    const loginInfo = JSON.parse(localStorage.getItem('timetable_login'));
    const nickname = loginInfo.nickname;
    
    return fetch(`${window.location.origin}/api/data`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            nickname: nickname,
            state: state
        })
    })
    .then(response => response.json())
    .then(result => {
        if (!result.success) {
            throw new Error(result.message || 'ì €ì¥ ì‹¤íŒ¨');
        }
        return result;
    });
}

function updatePeriodCount() {
    const newCount = parseInt(document.getElementById('periodCount').value);
    if (isNaN(newCount) || newCount < 1 || newCount > 10) {
        alert('ì˜¬ë°”ë¥¸ êµì‹œ ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (1-10)');
        return;
    }
    
    if (!confirm(`êµì‹œ ìˆ˜ë¥¼ ${newCount}ê°œë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê¸°ì¡´ ë°ì´í„°ê°€ ì˜í–¥ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`)) {
        return;
    }
    
    // ì„œë²„ì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    const loginInfo = JSON.parse(localStorage.getItem('timetable_login'));
    const nickname = loginInfo.nickname;
    
    fetch(`${window.location.origin}/api/data?nickname=${encodeURIComponent(nickname)}`)
        .then(response => response.json())
        .then(result => {
            let state;
            if (result.success && result.data) {
                state = result.data;
            } else {
                state = {
                    classCount: 5,
                    periodCount: 6,
                    subjectSheets: [],
                    classData: {},
                    preferences: {},
                    currentWeek: new Date().toISOString(),
                    annualHours: {},
                    weeklyData: {}
                };
            }
            
            const oldCount = state.periodCount || 6;
            state.periodCount = newCount;
            
            // êµì‹œ ìˆ˜ê°€ ì¤„ì–´ë“  ê²½ìš° í•´ë‹¹ êµì‹œ ë°ì´í„° ì‚­ì œ
            if (newCount < oldCount) {
                // ê³ ì • ì‹œíŠ¸ì˜ ê·œì¹™ì—ì„œ ì‚­ì œëœ êµì‹œ ì œê±°
                if (state.subjectSheets) {
                    state.subjectSheets.forEach(sheet => {
                        const newRules = {};
                        Object.keys(sheet.rules || {}).forEach(key => {
                            const [r, c] = key.split('-').map(Number);
                            if (r < newCount) {
                                newRules[key] = sheet.rules[key];
                            }
                        });
                        sheet.rules = newRules;
                    });
                }
                
                // í•™ê¸‰ë³„ ì‹œê°„í‘œì—ì„œ ì‚­ì œëœ êµì‹œ ì œê±°
                Object.keys(state.classData || {}).forEach(classNum => {
                    const data = state.classData[classNum];
                    if (data.timetable) {
                        data.timetable = data.timetable.slice(0, newCount);
                    }
                });
            } else {
                // êµì‹œ ìˆ˜ê°€ ëŠ˜ì–´ë‚œ ê²½ìš° ìƒˆ êµì‹œ ì¶”ê°€
                Object.keys(state.classData || {}).forEach(classNum => {
                    const data = state.classData[classNum];
                    if (!data.timetable) {
                        data.timetable = [];
                    }
                    while (data.timetable.length < newCount) {
                        data.timetable.push(Array(5).fill(""));
                    }
                });
            }
            
            // ì„œë²„ì— ì €ì¥
            return saveDataToServer(state);
        })
        .then(() => {
            alert(`êµì‹œ ìˆ˜ê°€ ${newCount}ê°œë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            setTimeout(() => {
                if (confirm('ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    history.back();
                }
            }, 500);
        })
        .catch(error => {
            console.error('ì˜¤ë¥˜:', error);
            alert('êµì‹œ ìˆ˜ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        });
}

// ì„ í˜¸êµì‹œ ì„¤ì • ë Œë”ë§
function renderPreferences() {
    const loginInfo = JSON.parse(localStorage.getItem('timetable_login'));
    const nickname = loginInfo.nickname;
    
    fetch(`${window.location.origin}/api/data?nickname=${encodeURIComponent(nickname)}`)
        .then(response => response.json())
        .then(result => {
            let preferences = {};
            let periodCount = 6;
            
            if (result.success && result.data) {
                preferences = result.data.preferences || {};
                periodCount = result.data.periodCount || 6;
            }
            
            const container = document.getElementById('preferenceContainer');
            container.innerHTML = '';
            
            allSubjects.forEach(sub => {
                if (!preferences[sub]) preferences[sub] = [];
                const div = document.createElement('div');
                div.className = 'preference-item';
                div.innerHTML = `
                    <strong>${sub}:</strong>
                    <select multiple size="3" id="pref-${sub}" onchange="updatePreference('${sub}')" style="width:200px;">
                        ${Array.from({length: periodCount}, (_, i) => i + 1).map(h => 
                            `<option value="${h}" ${preferences[sub].includes(h) ? 'selected' : ''}>${h}êµì‹œ</option>`
                        ).join('')}
                    </select>
                    <small>(Ctrl+í´ë¦­ìœ¼ë¡œ ë‹¤ì¤‘ ì„ íƒ)</small>
                `;
                container.appendChild(div);
            });
        })
        .catch(error => {
            console.error('ì„ í˜¸êµì‹œ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
            // ê¸°ë³¸ê°’ìœ¼ë¡œ ë Œë”ë§
            const container = document.getElementById('preferenceContainer');
            container.innerHTML = '';
            allSubjects.forEach(sub => {
                const div = document.createElement('div');
                div.className = 'preference-item';
                div.innerHTML = `
                    <strong>${sub}:</strong>
                    <select multiple size="3" id="pref-${sub}" onchange="updatePreference('${sub}')" style="width:200px;">
                        ${Array.from({length: 6}, (_, i) => i + 1).map(h => 
                            `<option value="${h}">${h}êµì‹œ</option>`
                        ).join('')}
                    </select>
                    <small>(Ctrl+í´ë¦­ìœ¼ë¡œ ë‹¤ì¤‘ ì„ íƒ)</small>
                `;
                container.appendChild(div);
            });
        });
}

function updatePreference(subject) {
    const select = document.getElementById(`pref-${subject}`);
    const selected = Array.from(select.selectedOptions).map(opt => parseInt(opt.value));
    
    // ì„œë²„ì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    const loginInfo = JSON.parse(localStorage.getItem('timetable_login'));
    const nickname = loginInfo.nickname;
    
    fetch(`${window.location.origin}/api/data?nickname=${encodeURIComponent(nickname)}`)
        .then(response => response.json())
        .then(result => {
            let state;
            if (result.success && result.data) {
                state = result.data;
            } else {
                state = {
                    classCount: 5,
                    periodCount: 6,
                    subjectSheets: [],
                    classData: {},
                    preferences: {},
                    currentWeek: new Date().toISOString(),
                    annualHours: {},
                    weeklyData: {}
                };
            }
            
            if (!state.preferences) state.preferences = {};
            state.preferences[subject] = selected;
            
            // ì„œë²„ì— ì €ì¥
            return saveDataToServer(state);
        })
        .catch(error => {
            console.error('ì„ í˜¸êµì‹œ ì €ì¥ ì˜¤ë¥˜:', error);
            alert('ì„ í˜¸êµì‹œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
}

function updateClassCount() {
    const newCount = parseInt(document.getElementById('classCount').value);
    if (isNaN(newCount) || newCount < 1) {
        alert('ì˜¬ë°”ë¥¸ í•™ê¸‰ ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    if (!confirm(`í•™ê¸‰ ìˆ˜ë¥¼ ${newCount}ê°œë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê¸°ì¡´ ë°ì´í„°ê°€ ì˜í–¥ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`)) {
        return;
    }
    
    // ì„œë²„ì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    const loginInfo = JSON.parse(localStorage.getItem('timetable_login'));
    const nickname = loginInfo.nickname;
    
    fetch(`${window.location.origin}/api/data?nickname=${encodeURIComponent(nickname)}`)
        .then(response => response.json())
        .then(result => {
            let state;
            if (result.success && result.data) {
                state = result.data;
            } else {
                state = {
                    classCount: 5,
                    periodCount: 6,
                    subjectSheets: [],
                    classData: {},
                    preferences: {},
                    currentWeek: new Date().toISOString(),
                    annualHours: {},
                    weeklyData: {}
                };
            }
            
            const oldCount = state.classCount || 5;
            const periodCount = state.periodCount || 6;
            
            // í•™ê¸‰ ìˆ˜ ë³€ê²½
            state.classCount = newCount;
            
            // í•™ê¸‰ ë°ì´í„° ì´ˆê¸°í™”
            if (!state.classData) state.classData = {};
            
            // í•™ê¸‰ ìˆ˜ê°€ ì¤„ì–´ë“  ê²½ìš° í•´ë‹¹ í•™ê¸‰ ë°ì´í„° ì‚­ì œ
            if (newCount < oldCount) {
                for (let i = newCount + 1; i <= oldCount; i++) {
                    if (state.classData[i]) {
                        delete state.classData[i];
                    }
                }
            }
            
            // í•™ê¸‰ ìˆ˜ê°€ ëŠ˜ì–´ë‚œ ê²½ìš° ìƒˆ í•™ê¸‰ ë°ì´í„° ì´ˆê¸°í™”
            if (newCount > oldCount) {
                const allSubjects = ["êµ­ì–´", "ì‚¬íšŒ", "ë„ë•", "ìˆ˜í•™", "ê³¼í•™", "ì‹¤ê³¼", "ì²´ìœ¡", "ìŒì•…", "ë¯¸ìˆ ", "ì˜ì–´", "ì°½ì²´(ì)", "ì°½ì²´(ë™)", "ì°½ì²´(ë´‰)", "ì°½ì²´(ì§„)"];
                for (let i = oldCount + 1; i <= newCount; i++) {
                    if (!state.classData[i]) {
                        state.classData[i] = { 
                            timetable: Array(periodCount).fill().map(() => Array(5).fill("")), 
                            targetHours: Array(allSubjects.length).fill(0),
                            memo: ""
                        };
                    }
                }
            }
            
            // ì„œë²„ì— ì €ì¥
            return saveDataToServer(state);
        })
        .then(() => {
            alert(`í•™ê¸‰ ìˆ˜ê°€ ${newCount}ê°œë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            
            // ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
            setTimeout(() => {
                if (confirm('ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    history.back();
                }
            }, 500);
        })
        .catch(error => {
            console.error('ì˜¤ë¥˜:', error);
            alert('í•™ê¸‰ ìˆ˜ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        });
}

function resetAllData() {
    if (!confirm('ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        return;
    }
    
    if (!confirm('ë§ˆì§€ë§‰ í™•ì¸ì…ë‹ˆë‹¤. ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.')) {
        return;
    }
    
    localStorage.removeItem('school_v5_final');
    alert('ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
    init();
}

function exportAllData() {
    const loginInfo = JSON.parse(localStorage.getItem('timetable_login'));
    if (!loginInfo || !loginInfo.nickname) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
    }
    
    const nickname = loginInfo.nickname;
    
    // ì„œë²„ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    fetch(`${window.location.origin}/api/data?nickname=${encodeURIComponent(nickname)}`)
        .then(response => response.json())
        .then(result => {
            if (!result.success || !result.data) {
                alert('ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ë°ì´í„°ë¥¼ JSON ë¬¸ìì—´ë¡œ ë³€í™˜
            const data = JSON.stringify(result.data, null, 2);
            
            // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ì‹œê°„í‘œ_ë°±ì—…_${nickname}_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            alert('ë°±ì—… íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
        })
        .catch(error => {
            console.error('ë°±ì—… ì˜¤ë¥˜:', error);
            alert('ë°±ì—… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        });
}

function importBackup(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const loginInfo = JSON.parse(localStorage.getItem('timetable_login'));
    if (!loginInfo || !loginInfo.nickname) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
    }
    
    if (!confirm('ë°±ì—… íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ë©´ í˜„ì¬ ì„œë²„ì˜ ë°ì´í„°ê°€ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = e.target.result;
            const stateData = JSON.parse(data); // ìœ íš¨ì„± ê²€ì‚¬
            
            const nickname = loginInfo.nickname;
            
            // ì„œë²„ì— ë°ì´í„° ì—…ë¡œë“œ
            fetch(`${window.location.origin}/api/data`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    nickname: nickname,
                    state: stateData
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('ë°±ì—… íŒŒì¼ì„ ì„±ê³µì ìœ¼ë¡œ ì„œë²„ì— ì—…ë¡œë“œí–ˆìŠµë‹ˆë‹¤.');
                    init();
                } else {
                    alert('ë°±ì—… íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            })
            .catch(error => {
                console.error('ë°±ì—… ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
                alert('ë°±ì—… íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            });
        } catch (err) {
            alert('ë°±ì—… íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤: ' + err.message);
        }
    };
    reader.readAsText(file);
}

init();
</script>

</body>
</html>
