<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì´ˆë“± êµê³¼ë³„ ê³ ì • ë° ìë™ ë°°ì¹˜ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --fixed-bg: #e9ecef; --accent: #4a90e2; --sub-bg: #ffffff; --complete: #d4edda; }
        body { font-family: 'Malgun Gothic', sans-serif; padding: 20px; background: #f0f2f5; color: #333; line-height: 1.5; }
        
        /* ì£¼ì°¨ í‘œì‹œ */
        .week-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; font-size: 18px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .nav-buttons { text-align: right; margin-top: 10px; }
        
        .section { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 30px; }
        
        /* ê³ ì • êµê³¼ ì„¤ì • ìŠ¤íƒ€ì¼ */
        .subject-manager { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; flex-wrap: wrap; }
        #masterSheetsContainer { display: flex; flex-wrap: wrap; gap: 10px; }
        .master-sheet { border: 2px solid var(--accent); padding: 8px; border-radius: 8px; margin-bottom: 0; background: #f8fbff; width: fit-content; min-width: 280px; }
        .master-sheet h3 { margin-top: 0; margin-bottom: 5px; color: var(--accent); display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
        .master-sheet table { font-size: 10px; margin: 5px 0; width: auto; }
        .master-sheet th, .master-sheet td { padding: 3px; height: 20px; font-size: 9px; width: auto; min-width: 35px; }
        .master-sheet textarea { height: 30px; font-size: 11px; padding: 3px; margin-top: 3px; width: 100%; }
        
        /* í•™ê¸‰ ì„ íƒ íŒì—… */
        .class-selector { display: none; position: absolute; background: white; border: 1px solid #ccc; padding: 10px; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 8px; min-width: 120px; }
        .class-selector label { display: block; font-size: 13px; cursor: pointer; padding: 4px; border-radius: 4px; }
        .class-selector label:hover { background: #f0f0f0; }
        
        /* ê³¼ëª© ì„ íƒ íŒì—… */
        .subject-selector { display: none; position: absolute; background: white; border: 1px solid #ccc; padding: 10px; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 8px; min-width: 150px; max-height: 300px; overflow-y: auto; }
        .subject-selector label { display: block; font-size: 12px; cursor: pointer; padding: 4px; border-radius: 4px; }
        .subject-selector label:hover { background: #f0f0f0; }
        .subject-cell { cursor: pointer; position: relative; }
        .subject-cell:hover { background: #eef5ff; }

        /* í•™ê¸‰ ê·¸ë¦¬ë“œ */
        .class-grid { display: flex; flex-wrap: wrap; gap: 10px; }
        .class-card { background: white; padding: 8px; border-radius: 8px; border: 1px solid #dee2e6; position: relative; width: fit-content; min-width: 280px; }
        .class-card.completed { border: 2px solid #28a745; background: #f9fffb; }
        .class-card h3 { margin-top: 0; margin-bottom: 5px; font-size: 14px; }
        .class-card h4 { margin: 8px 0 5px 0; font-size: 12px; }
        
        table { width: 100%; border-collapse: collapse; margin: 5px 0; font-size: 10px; table-layout: fixed; }
        th, td { border: 1px solid #ced4da; padding: 3px; text-align: center; height: 20px; }
        th { background: #eee; font-weight: bold; font-size: 9px; }
        .class-card table { width: auto; }
        .class-card th, .class-card td { font-size: 9px; min-width: 35px; }
        
        /* í†µí•© ì£¼ê°„ ì‹œìˆ˜ í‘œ ìµœì†Œí™” */
        #unifiedHoursTable { width: fit-content; }
        #unifiedHoursTable table { width: auto; font-size: 9px; margin: 3px 0; }
        #unifiedHoursTable th, #unifiedHoursTable td { padding: 2px 4px; height: 18px; font-size: 8px; min-width: 30px; }
        #unifiedHoursTable th { font-size: 8px; }
        #unifiedHoursTable input { width: 35px; font-size: 8px; padding: 1px; }
        
        .master-td { cursor: pointer; background: white; font-size: 8px; transition: 0.2s; }
        .master-td:hover { background: #eef5ff; border: 1px solid var(--accent); }
        .selected-classes { color: var(--accent); font-weight: bold; display: block; font-size: 8px; }

        .fixed-cell { background-color: var(--fixed-bg); color: #666; font-weight: bold; font-size: 9px; }
        .selected-subject { font-size: 9px; display: block; }
        .target-zero { background-color: var(--complete); font-weight: bold; }
        
        /* ë“œë˜ê·¸ ì•¤ ë“œë¡­ */
        .draggable-cell { cursor: move; user-select: none; }
        .dragging { opacity: 0.5; }
        .drag-over { background-color: #fff3cd !important; border: 2px dashed #ffc107 !important; }
        
        input, select, textarea { border: 1px solid #ddd; border-radius: 4px; padding: 3px; font-family: inherit; }
        .class-card input, .class-card select { font-size: 10px; padding: 2px; }
        .class-card textarea { width: 100%; height: 35px; resize: none; margin-top: 3px; font-size: 10px; border-color: #eee; padding: 3px; }
        
        .btn { padding: 6px 12px; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; margin: 2px; }
        .btn:hover { opacity: 0.8; }
        .btn-auto { background: #6c757d; float: right; }
        .btn-del { background: #dc3545; font-size: 11px; padding: 3px 8px; }
        .btn-clear { background: #dc3545; float: right; margin-left: 5px; }
        .btn-export { background: #28a745; }
        .btn-import { background: #17a2b8; }
        .btn-save { background: #ffc107; color: #333; }
        .btn-load { background: #fd7e14; }
        
        .badge { position: absolute; right: 8px; top: 8px; display: none; background: #28a745; color: white; padding: 2px 6px; border-radius: 10px; font-size: 9px; }
        
        .toolbar { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; align-items: center; }
        
        /* ì¸ì‡„ ìµœì í™” */
        @media print {
            body { padding: 0; background: white; }
            .section { page-break-inside: avoid; box-shadow: none; border: 1px solid #ddd; }
            .btn, .nav-buttons, .toolbar, .subject-manager button, .master-sheet button { display: none !important; }
            .class-card { page-break-inside: avoid; }
            .week-header { page-break-after: avoid; }
            textarea { border: none; background: transparent; }
        }
        
        /* íŒŒì¼ ì…ë ¥ ìˆ¨ê¹€ */
        #fileInput { display: none; }
    </style>
</head>
<body>

<!-- ì£¼ì°¨ í‘œì‹œ -->
<div class="week-header">
    <div id="weekDisplay"></div>
    <div class="nav-buttons">
        <button class="btn" onclick="location.href='annual.html'">ì—°ê°„ì‹œìˆ˜í‘œ</button>
        <button class="btn" onclick="location.href='admin.html'">ê´€ë¦¬ì í˜ì´ì§€</button>
    </div>
</div>

<!-- íˆ´ë°” -->
<div class="section">
    <div class="toolbar">
        <button class="btn btn-save" onclick="saveToFile()">íŒŒì¼ë¡œ ì €ì¥</button>
        <button class="btn btn-load" onclick="document.getElementById('fileInput').click()">íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <input type="file" id="fileInput" accept=".json,.xlsx" onchange="loadFromFile(event)">
        <button class="btn btn-export" onclick="exportToExcel()">ì—‘ì…€ ë‚´ë³´ë‚´ê¸°</button>
        <button class="btn btn-import" onclick="document.getElementById('excelInput').click()">ì—‘ì…€ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <input type="file" id="excelInput" accept=".xlsx,.xls" onchange="importFromExcel(event)" style="display:none">
        <button class="btn" onclick="window.print()">ì¸ì‡„</button>
    </div>
</div>

<div class="section" style="padding: 15px;">
    <h2 style="font-size: 16px; margin-bottom: 10px;">âš™ï¸ ê³ ì • êµê³¼ ë° ì „ë‹´ êµì‚¬ ì„¤ì •</h2>
    <div class="subject-manager">
        <span><strong>ìƒˆ ê³ ì • ì‹œíŠ¸:</strong></span>
        <select id="newSubName" style="width:120px;"></select>
        <button class="btn" onclick="addSubjectSheet()">ì‹œíŠ¸ ìƒì„±</button>
    </div>

    <div id="masterSheetsContainer"></div>
</div>

<div class="section">
    <h2>ğŸ“Š ì „ì²´ í•™ê¸‰ ì£¼ê°„ ì‹œìˆ˜ ë° ë‹¬ì„±ë„</h2>
    <div id="unifiedHoursTable"></div>
</div>

<div class="section">
    <h2>ğŸ« í•™ê¸‰ë³„ ì‹œê°„í‘œ ê´€ë¦¬</h2>
    <div id="classGrid" class="class-grid"></div>
</div>

<div id="globalClassSelector" class="class-selector"></div>
<div id="globalSubjectSelector" class="subject-selector"></div>

<script>
const allSubjects = ["êµ­ì–´", "ì‚¬íšŒ", "ë„ë•", "ìˆ˜í•™", "ê³¼í•™", "ì‹¤ê³¼", "ì²´ìœ¡", "ìŒì•…", "ë¯¸ìˆ ", "ì˜ì–´", "ì°½ì²´(ì)", "ì°½ì²´(ë™)", "ì°½ì²´(ë´‰)", "ì°½ì²´(ì§„)"];
const days = ["ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ"];

let state = {
    classCount: 3,
    periodCount: 7, // êµì‹œ ìˆ˜
    subjectSheets: [], // { subName, memo: "", rules: { "0-0": [1, 2] } }
    classData: {}, // { classNum: { timetable: [], targetHours: [], memo: "" } }
    preferences: {}, // { subject: [1, 2, 3] } - ì„ í˜¸í•˜ëŠ” êµì‹œ ë°°ì—´
    currentWeek: new Date(), // í˜„ì¬ ì£¼ì°¨
    annualHours: {} // ì—°ê°„ì‹œìˆ˜í‘œ { subject: hours }
};

function init() {
    const saved = localStorage.getItem('school_v5_final');
    if (saved) {
        const parsed = JSON.parse(saved);
        Object.assign(state, parsed);
        if (parsed.currentWeek) state.currentWeek = new Date(parsed.currentWeek);
        // periodCountê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ 7 ì„¤ì •
        if (!state.periodCount) state.periodCount = 7;
        // annualHoursê°€ ì—†ìœ¼ë©´ ë¹ˆ ê°ì²´ ì„¤ì •
        if (!state.annualHours) state.annualHours = {};
    } else {
        // ì´ˆê¸° ìƒíƒœ ì„¤ì •
        state.periodCount = 7;
        state.annualHours = {};
    }
    
    // ê³¼ëª© ì„ íƒ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
    const subSelect = document.getElementById('newSubName');
    allSubjects.forEach(s => subSelect.add(new Option(s, s)));
    
    updateWeekDisplay();
    renderAll();
}

// ì£¼ì°¨ í‘œì‹œ ì—…ë°ì´íŠ¸
function updateWeekDisplay() {
    const date = state.currentWeek || new Date();
    const year = date.getFullYear();
    const month = date.getMonth() + 1;
    
    // í•´ë‹¹ ì›”ì˜ ì²« ë²ˆì§¸ ë‚ 
    const firstDay = new Date(year, month - 1, 1);
    const firstDayOfWeek = firstDay.getDay();
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDayOfWeek);
    
    // í˜„ì¬ ë‚ ì§œê°€ ì†í•œ ì£¼ ì°¾ê¸°
    const diffTime = date.getTime() - startDate.getTime();
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    const weekNumber = Math.floor(diffDays / 7) + 1;
    
    // í•´ë‹¹ ì£¼ì˜ ì‹œì‘ì¼
    const weekStart = new Date(startDate);
    weekStart.setDate(startDate.getDate() + (weekNumber - 1) * 7);
    const weekStartMonth = weekStart.getMonth() + 1;
    const weekStartDate = weekStart.getDate();
    
    document.getElementById('weekDisplay').innerHTML = 
        `${month}ì›” ${weekStartDate}ì¼ ì£¼ (${weekNumber}ì£¼ì°¨)`;
}


function saveAndRefresh(full = true) {
    localStorage.setItem('school_v5_final', JSON.stringify(state));
    if (full) { renderMasterSheets(); renderClassGrid(); }
}

// íŒŒì¼ë¡œ ì €ì¥
function saveToFile() {
    const dataStr = JSON.stringify(state, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `ì‹œê°„í‘œ_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    URL.revokeObjectURL(url);
}

// íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
function loadFromFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const loaded = JSON.parse(e.target.result);
            Object.assign(state, loaded);
            if (loaded.currentWeek) state.currentWeek = new Date(loaded.currentWeek);
            updateWeekDisplay();
            renderPreferences();
            renderAll();
            alert('íŒŒì¼ì„ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
        } catch (err) {
            alert('íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
        }
    };
    reader.readAsText(file);
}

// ì—‘ì…€ ë‚´ë³´ë‚´ê¸°
function exportToExcel() {
    const wb = XLSX.utils.book_new();
    
    // ê³ ì • êµê³¼ ì‹œíŠ¸
    const masterData = [];
    masterData.push(['ê³ ì • êµê³¼ ì„¤ì •']);
    state.subjectSheets.forEach(sheet => {
        masterData.push([`[${sheet.subName}] ì „ë‹´ ê³ ì •í‘œ`]);
        masterData.push(['êµì‹œ', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ']);
        for (let r = 0; r < state.periodCount; r++) {
            const row = [r + 1];
            for (let c = 0; c < 5; c++) {
                const key = `${r}-${c}`;
                const classes = sheet.rules[key] || [];
                row.push(classes.length > 0 ? classes.join(',') + 'ë°˜' : '');
            }
            masterData.push(row);
        }
        masterData.push([]);
    });
    const masterWs = XLSX.utils.aoa_to_sheet(masterData);
    XLSX.utils.book_append_sheet(wb, masterWs, 'ê³ ì •êµê³¼');
    
    // í•™ê¸‰ë³„ ì‹œê°„í‘œ ì‹œíŠ¸
    for (let i = 1; i <= state.classCount; i++) {
        if (!state.classData[i]) continue;
        const data = state.classData[i];
        const classData = [];
        classData.push([`${i}ë°˜ ì‹œê°„í‘œ`]);
        classData.push(['êµì‹œ', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ']);
        
        for (let r = 0; r < state.periodCount; r++) {
            const row = [r + 1];
            for (let c = 0; c < 5; c++) {
                const key = `${r}-${c}`;
                let fixedSub = null;
                state.subjectSheets.forEach(sheet => {
                    if (sheet.rules[key] && sheet.rules[key].includes(i)) fixedSub = sheet.subName;
                });
                row.push(fixedSub || data.timetable[r][c] || '');
            }
            classData.push(row);
        }
        
        classData.push([]);
        classData.push(['ê³¼ëª©', ...allSubjects]);
        classData.push(['ëª©í‘œì‹œìˆ˜', ...data.targetHours]);
        
        if (data.memo) {
            classData.push([]);
            classData.push(['ë©”ëª¨', data.memo]);
        }
        
        const ws = XLSX.utils.aoa_to_sheet(classData);
        XLSX.utils.book_append_sheet(wb, ws, `${i}ë°˜`);
    }
    
    XLSX.writeFile(wb, `ì‹œê°„í‘œ_${new Date().toISOString().split('T')[0]}.xlsx`);
}

// ì—‘ì…€ ë¶ˆëŸ¬ì˜¤ê¸°
function importFromExcel(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            
            // í•™ê¸‰ë³„ ì‹œíŠ¸ ì½ê¸°
            for (let i = 1; i <= state.classCount; i++) {
                const sheetName = `${i}ë°˜`;
                if (!workbook.Sheets[sheetName]) continue;
                
                const ws = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
                
                if (!state.classData[i]) {
                    state.classData[i] = { 
                        timetable: Array(state.periodCount).fill().map(() => Array(5).fill("")), 
                        targetHours: Array(allSubjects.length).fill(0),
                        memo: ""
                    };
                }
                
                // ì‹œê°„í‘œ ì½ê¸° (2í–‰ë¶€í„° ì‹œì‘)
                for (let r = 2; r < 2 + state.periodCount && r - 2 < state.periodCount; r++) {
                    if (!jsonData[r]) continue;
                    for (let c = 1; c < 6 && c - 1 < 5; c++) {
                        const val = jsonData[r][c];
                        if (val && typeof val === 'string') {
                            state.classData[i].timetable[r - 2][c - 1] = val;
                        }
                    }
                }
                
                // ëª©í‘œì‹œìˆ˜ ì½ê¸°
                const targetRow = jsonData.findIndex(row => row && row[0] === 'ëª©í‘œì‹œìˆ˜');
                if (targetRow >= 0 && jsonData[targetRow]) {
                    for (let idx = 0; idx < allSubjects.length && idx + 1 < jsonData[targetRow].length; idx++) {
                        const val = jsonData[targetRow][idx + 1];
                        if (typeof val === 'number') {
                            state.classData[i].targetHours[idx] = val;
                        }
                    }
                }
                
                // ë©”ëª¨ ì½ê¸°
                const memoRow = jsonData.findIndex(row => row && row[0] === 'ë©”ëª¨');
                if (memoRow >= 0 && jsonData[memoRow] && jsonData[memoRow][1]) {
                    state.classData[i].memo = String(jsonData[memoRow][1]);
                }
            }
            
            renderAll();
            alert('ì—‘ì…€ íŒŒì¼ì„ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
        } catch (err) {
            alert('ì—‘ì…€ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
        }
    };
    reader.readAsArrayBuffer(file);
}

function updateClassCount(val) {
    state.classCount = parseInt(val);
    saveAndRefresh();
}

function addSubjectSheet() {
    const name = document.getElementById('newSubName').value;
    if (!name) return alert("ê³¼ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    state.subjectSheets.push({ subName: name, memo: "", rules: {} });
    saveAndRefresh();
}

function deleteSheet(idx) {
    if(confirm("í•´ë‹¹ êµê³¼ ê³ ì • ì„¤ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        state.subjectSheets.splice(idx, 1);
        saveAndRefresh();
    }
}

// ê³ ì • ì‹œíŠ¸ ë Œë”ë§
function renderMasterSheets() {
    const container = document.getElementById('masterSheetsContainer');
    container.innerHTML = '';

    state.subjectSheets.forEach((sheet, sIdx) => {
        const div = document.createElement('div');
        div.className = 'master-sheet';
        let html = `<h3>[${sheet.subName}] ì „ë‹´ ê³ ì •í‘œ <button class="btn btn-del" onclick="deleteSheet(${sIdx})">ì‚­ì œ</button></h3>`;
        html += `<table><thead><tr><th>êµì‹œ</th>${days.map(d => `<th>${d}</th>`).join('')}</tr></thead><tbody>`;
        
        for (let r = 0; r < state.periodCount; r++) {
            html += `<tr><th>${r+1}</th>`;
            for (let c = 0; c < 5; c++) {
                const key = `${r}-${c}`;
                const selected = sheet.rules[key] || [];
                html += `<td class="master-td" onclick="showClassSelector(event, ${sIdx}, ${r}, ${c})">
                            <span class="selected-classes">${selected.length > 0 ? selected.join(',') + 'ë°˜' : '+'}</span>
                         </td>`;
            }
            html += `</tr>`;
        }
        html += `</tbody></table>`;
        html += `<textarea placeholder="${sheet.subName} êµê³¼ ê´€ë ¨ ê³µì§€/ë©”ëª¨..." onchange="updateSheetMemo(${sIdx}, this.value)">${sheet.memo || ""}</textarea>`;
        div.innerHTML = html;
        container.appendChild(div);
    });
}

function updateSheetMemo(idx, val) {
    state.subjectSheets[idx].memo = val;
    saveAndRefresh(false);
}

// í•™ê¸‰ ì„ íƒ íŒì—…
function showClassSelector(event, sIdx, r, c) {
    event.stopPropagation();
    const selector = document.getElementById('globalClassSelector');
    const key = `${r}-${c}`;
    const selectedClasses = state.subjectSheets[sIdx].rules[key] || [];

    let html = `<strong>ëŒ€ìƒ í•™ê¸‰</strong><hr>`;
    for (let i = 1; i <= state.classCount; i++) {
        const checked = selectedClasses.includes(i) ? 'checked' : '';
        html += `<label><input type="checkbox" value="${i}" ${checked} onchange="toggleRule(${sIdx}, ${r}, ${c}, ${i}, this.checked)"> ${i}ë°˜</label>`;
    }
    html += `<hr><button class="btn" style="width:100%; font-size:11px;" onclick="closeSelector()">ë‹«ê¸°</button>`;
    
    selector.innerHTML = html;
    selector.style.display = 'block';
    selector.style.left = (event.pageX + 10) + 'px';
    selector.style.top = (event.pageY + 10) + 'px';
}

function toggleRule(sIdx, r, c, classNum, isChecked) {
    const key = `${r}-${c}`;
    if (!state.subjectSheets[sIdx].rules[key]) state.subjectSheets[sIdx].rules[key] = [];
    
    if (isChecked) {
        if (!state.subjectSheets[sIdx].rules[key].includes(classNum)) state.subjectSheets[sIdx].rules[key].push(classNum);
    } else {
        state.subjectSheets[sIdx].rules[key] = state.subjectSheets[sIdx].rules[key].filter(n => n !== classNum);
    }
    saveAndRefresh();
}

function closeSelector() { document.getElementById('globalClassSelector').style.display = 'none'; }

// ê³¼ëª© ì„ íƒ íŒì—…
function showSubjectSelector(event, classNum, r, c) {
    event.stopPropagation();
    const selector = document.getElementById('globalSubjectSelector');
    const cellValue = state.classData[classNum].timetable[r][c] || '';

    let html = `<strong>ê³¼ëª© ì„ íƒ</strong><hr>`;
    html += `<label><input type="checkbox" value="" ${cellValue === '' ? 'checked' : ''} onchange="updateCellFromCheckbox(${classNum}, ${r}, ${c}, '', this.checked)"> (ì—†ìŒ)</label>`;
    allSubjects.forEach(sub => {
        const checked = cellValue === sub ? 'checked' : '';
        html += `<label><input type="checkbox" value="${sub}" ${checked} onchange="updateCellFromCheckbox(${classNum}, ${r}, ${c}, '${sub}', this.checked)"> ${sub}</label>`;
    });
    html += `<hr><button class="btn" style="width:100%; font-size:11px;" onclick="closeSubjectSelector()">ë‹«ê¸°</button>`;
    
    selector.innerHTML = html;
    selector.style.display = 'block';
    selector.style.left = (event.pageX + 10) + 'px';
    selector.style.top = (event.pageY + 10) + 'px';
}

function updateCellFromCheckbox(classNum, r, c, subject, isChecked) {
    // ë‹¤ë¥¸ ì²´í¬ë°•ìŠ¤ ëª¨ë‘ í•´ì œ
    const checkboxes = document.querySelectorAll('#globalSubjectSelector input[type="checkbox"]');
    checkboxes.forEach(cb => {
        if (cb.value !== subject) cb.checked = false;
    });
    
    if (isChecked) {
        state.classData[classNum].timetable[r][c] = subject;
    } else {
        state.classData[classNum].timetable[r][c] = '';
    }
    
    // ì…€ ì—…ë°ì´íŠ¸
    const cell = document.getElementById(`cell-${classNum}-${r}-${c}`);
    if (cell) {
        const span = cell.querySelector('.selected-subject');
        if (span) span.textContent = subject || '-';
    }
    
    saveAndRefresh(false);
    calculateUnifiedStatus(classNum);
    closeSubjectSelector();
}

function closeSubjectSelector() { 
    document.getElementById('globalSubjectSelector').style.display = 'none'; 
}

// í•™ê¸‰ ì‹œê°„í‘œ ë Œë”ë§
function renderClassGrid() {
    const grid = document.getElementById('classGrid');
    grid.innerHTML = '';

    for (let i = 1; i <= state.classCount; i++) {
        if (!state.classData[i]) {
            state.classData[i] = { timetable: Array(state.periodCount).fill().map(() => Array(5).fill("")), targetHours: Array(allSubjects.length).fill(0) };
        }
        grid.appendChild(createClassCard(i));
    }
}

function createClassCard(num) {
    const data = state.classData[num];
    if (!data.memo) data.memo = '';
    const card = document.createElement('div');
    card.className = 'class-card';
    card.id = `card-${num}`;
    
    let html = `<h3>${num}ë°˜ <button class="btn btn-auto" onclick="autoFill(${num})">ìë™ ì±„ìš°ê¸°</button> <button class="btn btn-clear" onclick="clearClassTimetable(${num})">ì‚­ì œ</button> <span class="badge" id="badge-${num}">ì™„ë£Œ</span></h3>`;
    html += `<table><thead><tr><th>êµì‹œ</th>${days.map(d => `<th>${d}</th>`).join('')}</tr></thead><tbody>`;

    for (let r = 0; r < state.periodCount; r++) {
        html += `<tr><th>${r+1}</th>`;
        for (let c = 0; c < 5; c++) {
            const key = `${r}-${c}`;
            let fixedSub = null;
            state.subjectSheets.forEach(sheet => {
                if (sheet.rules[key] && sheet.rules[key].includes(num)) fixedSub = sheet.subName;
            });

            if (fixedSub) {
                html += `<td class="fixed-cell">${fixedSub}</td>`;
                data.timetable[r][c] = fixedSub;
            } else {
                const cellId = `cell-${num}-${r}-${c}`;
                const cellValue = data.timetable[r][c] || '';
                html += `<td class="subject-cell draggable-cell" id="${cellId}" draggable="true" 
                    onclick="showSubjectSelector(event, ${num}, ${r}, ${c})"
                    ondragstart="handleDragStart(event, ${num}, ${r}, ${c})"
                    ondragover="handleDragOver(event)"
                    ondrop="handleDrop(event, ${num}, ${r}, ${c})"
                    ondragend="handleDragEnd(event)">
                    <span class="selected-subject">${cellValue || '-'}</span>
                </td>`;
            }
        }
        html += `</tr>`;
    }
    html += `</tbody></table>`;
    
    // í•™ê¸‰ë³„ ë©”ëª¨ ì¶”ê°€
    html += `<h4>ë©”ëª¨</h4><textarea placeholder="${num}ë°˜ ê´€ë ¨ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onchange="updateClassMemo(${num}, this.value)">${data.memo || ""}</textarea>`;

    card.innerHTML = html;
    setTimeout(() => {
        calculateUnifiedStatus(num);
    }, 0);
    return card;
}

function updateClassMemo(classNum, val) {
    if (!state.classData[classNum]) return;
    state.classData[classNum].memo = val;
    saveAndRefresh(false);
}

// ë“œë˜ê·¸ ì•¤ ë“œë¡­ í•¨ìˆ˜ë“¤
let dragSource = null;

function handleDragStart(e, classNum, r, c) {
    const key = `${r}-${c}`;
    let fixedSub = null;
    state.subjectSheets.forEach(sheet => {
        if (sheet.rules[key] && sheet.rules[key].includes(classNum)) fixedSub = sheet.subName;
    });
    
    if (fixedSub) {
        e.preventDefault();
        return false;
    }
    
    dragSource = { classNum, r, c, value: state.classData[classNum].timetable[r][c] };
    e.dataTransfer.effectAllowed = 'move';
    e.currentTarget.classList.add('dragging');
}

function handleDragOver(e) {
    if (dragSource) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        e.currentTarget.classList.add('drag-over');
    }
}

function handleDrop(e, classNum, r, c) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');
    
    if (!dragSource) return;
    
    const source = dragSource;
    const targetKey = `${r}-${c}`;
    
    // ê³ ì •ëœ ì…€ì¸ì§€ í™•ì¸
    let targetFixed = false;
    state.subjectSheets.forEach(sheet => {
        if (sheet.rules[targetKey] && sheet.rules[targetKey].includes(classNum)) targetFixed = true;
    });
    
    if (targetFixed || source.classNum !== classNum) return;
    
    // ê°’ êµí™˜
    const sourceValue = state.classData[classNum].timetable[source.r][source.c];
    const targetValue = state.classData[classNum].timetable[r][c];
    
    state.classData[classNum].timetable[source.r][source.c] = targetValue;
    state.classData[classNum].timetable[r][c] = sourceValue;
    
    saveAndRefresh();
}

function handleDragEnd(e) {
    e.currentTarget.classList.remove('dragging');
    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
    dragSource = null;
}

function updateCell(classNum, r, c, val) {
    state.classData[classNum].timetable[r][c] = val;
    saveAndRefresh(false);
    calculateStatus(classNum);
}

function updateHour(classNum, idx, val) {
    // ëª©í‘œì‹œìˆ˜ëŠ” ëª¨ë“  ë°˜ì— ë™ì¼í•˜ê²Œ ì ìš© (1ë°˜ ê²ƒë§Œ ì‚¬ìš©)
    const targetValue = parseInt(val) || 0;
    for (let i = 1; i <= state.classCount; i++) {
        if (state.classData[i]) {
            state.classData[i].targetHours[idx] = targetValue;
        }
    }
    saveAndRefresh(false);
    // ëª©í‘œì‹œìˆ˜ í•©ê³„ ì—…ë°ì´íŠ¸
    updateTargetHoursSum();
    // ëª¨ë“  ë°˜ì˜ ë‹¬ì„±ë„ ì¬ê³„ì‚°
    for (let i = 1; i <= state.classCount; i++) {
        if (state.classData[i]) {
            calculateUnifiedStatus(i);
        }
    }
}

// ìë™ ì±„ìš°ê¸° ë¡œì§ (ì„ í˜¸êµì‹œ ê³ ë ¤)
function autoFill(num) {
    const data = state.classData[num];
    const needed = [];

    // 1. ê° ê³¼ëª©ë³„ë¡œ ë” ì±„ì›Œì•¼ í•  ê°œìˆ˜ ë¦¬ìŠ¤íŠ¸ì—… (1ë°˜ì˜ ëª©í‘œì‹œìˆ˜ ì‚¬ìš©)
    const targetHoursRef = state.classData[1] ? state.classData[1].targetHours : data.targetHours;
    allSubjects.forEach((sub, idx) => {
        let count = 0;
        for(let r=0; r<state.periodCount; r++) {
            for(let c=0; c<5; c++) {
                const key = `${r}-${c}`;
                let fixed = false;
                state.subjectSheets.forEach(sheet => { if(sheet.rules[key] && sheet.rules[key].includes(num)) fixed=true; });
                if(fixed) { 
                    let fixedName = "";
                    state.subjectSheets.forEach(sheet => { if(sheet.rules[key] && sheet.rules[key].includes(num)) fixedName = sheet.subName; });
                    if(fixedName === sub) count++;
                } else if(data.timetable[r][c] === sub) count++;
            }
        }
        let diff = targetHoursRef[idx] - count;
        for(let k=0; k<diff; k++) needed.push({sub, idx});
    });

    // 2. ë¹„ì–´ìˆëŠ”(í™œì„±í™”ëœ) ì¹¸ ì°¾ê¸° (ì„ í˜¸êµì‹œ ìš°ì„ ìˆœìœ„ ì ìš©)
    const emptySlots = [];
    for(let r=0; r<state.periodCount; r++) {
        for(let c=0; c<5; c++) {
            const key = `${r}-${c}`;
            let fixed = false;
            state.subjectSheets.forEach(sheet => { if(sheet.rules[key] && sheet.rules[key].includes(num)) fixed=true; });
            if(!fixed && data.timetable[r][c] === "") {
                emptySlots.push({r, c, period: r+1});
            }
        }
    }

    // 3. ì„ í˜¸êµì‹œë¥¼ ê³ ë ¤í•œ ë°°ì¹˜
    // ì„ í˜¸êµì‹œê°€ ìˆëŠ” ê³¼ëª©ì„ ë¨¼ì € ë°°ì¹˜
    const preferred = [];
    const nonPreferred = [];
    
    needed.forEach(item => {
        const prefs = state.preferences[item.sub] || [];
        if (prefs.length > 0) {
            preferred.push(item);
        } else {
            nonPreferred.push(item);
        }
    });
    
    // ì„ í˜¸êµì‹œê°€ ìˆëŠ” ê³¼ëª© ë°°ì¹˜
    preferred.forEach(item => {
        const prefs = state.preferences[item.sub] || [];
        const availableSlots = emptySlots.filter(slot => prefs.includes(slot.period));
        if (availableSlots.length > 0) {
            const slot = availableSlots[Math.floor(Math.random() * availableSlots.length)];
            data.timetable[slot.r][slot.c] = item.sub;
            const idx = emptySlots.findIndex(s => s.r === slot.r && s.c === slot.c);
            if (idx >= 0) emptySlots.splice(idx, 1);
        }
    });
    
    // ë‚˜ë¨¸ì§€ ê³¼ëª© ëœë¤ ë°°ì¹˜ (1ë°˜ì˜ ëª©í‘œì‹œìˆ˜ ì‚¬ìš©)
    const remaining = [...preferred, ...nonPreferred].filter(item => {
        let count = 0;
        for(let r=0; r<state.periodCount; r++) {
            for(let c=0; c<5; c++) {
                const key = `${r}-${c}`;
                let fixedSub = null;
                state.subjectSheets.forEach(sheet => { 
                    if (sheet.rules[key] && sheet.rules[key].includes(num)) fixedSub = sheet.subName; 
                });
                const currentVal = fixedSub || data.timetable[r][c];
                if(currentVal === item.sub) count++;
            }
        }
        return count < targetHoursRef[item.idx];
    });
    
    remaining.sort(() => Math.random() - 0.5);
    emptySlots.forEach((slot, i) => {
        if(remaining[i]) data.timetable[slot.r][slot.c] = remaining[i].sub;
    });

    saveAndRefresh();
}

function calculateStatus(classNum) {
    // í†µí•© í‘œì˜ ë‹¬ì„±ë„ ê³„ì‚° í•¨ìˆ˜ ì‚¬ìš©
    calculateUnifiedStatus(classNum);
}

function renderAll() { renderMasterSheets(); renderClassGrid(); renderUnifiedHoursTable(); }

// í†µí•© ì£¼ê°„ ì‹œìˆ˜ ë° ë‹¬ì„±ë„ í‘œ ë Œë”ë§
function renderUnifiedHoursTable() {
    const container = document.getElementById('unifiedHoursTable');
    if (!container) return;
    
    // 1ë°˜ ë°ì´í„° ì‚¬ìš© (ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ í•™ê¸‰)
    const firstClass = state.classData[1] || state.classData[Object.keys(state.classData)[0]];
    if (!firstClass) {
        container.innerHTML = '<p>í•™ê¸‰ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }
    
    let html = '<table><thead><tr><th>êµ¬ë¶„</th>';
    html += allSubjects.map(s => `<th>${s}</th>`).join('');
    html += '<th>í•©ê³„</th></tr></thead><tbody>';
    
    // í–‰1: ëª©í‘œì‹œìˆ˜ (1ë°˜ ê²ƒ ì‚¬ìš©)
    html += '<tr id="target-hours-row"><th>ëª©í‘œì‹œìˆ˜</th>';
    html += allSubjects.map((s, idx) => {
        return `<td><input type="number" value="${firstClass.targetHours[idx]}" style="width:100%" onchange="updateHour(1, ${idx}, this.value)"></td>`;
    }).join('');
    html += '<td id="target-hours-sum" style="font-weight:bold">0</td>';
    html += '</tr>';
    
    // ê° ë°˜ì˜ ë‹¬ì„±ë„ í–‰
    for (let i = 1; i <= state.classCount; i++) {
        if (!state.classData[i]) continue;
        const remainId = `unified-remain-${i}`;
        html += `<tr id="${remainId}" style="font-weight:bold"><th>${i}ë°˜ ë‹¬ì„±ë„</th>`;
        html += allSubjects.map(() => `<td>0</td>`).join('');
        html += `<td id="remain-sum-${i}" style="font-weight:bold">0</td>`;
        html += '</tr>';
    }
    
    html += '</tbody></table>';
    container.innerHTML = html;
    
    // ëª©í‘œì‹œìˆ˜ í•©ê³„ ê³„ì‚°
    updateTargetHoursSum();
    
    // ê° ë°˜ì˜ ë‹¬ì„±ë„ ê³„ì‚°
    for (let i = 1; i <= state.classCount; i++) {
        if (state.classData[i]) {
            calculateUnifiedStatus(i);
        }
    }
}

function calculateUnifiedStatus(classNum) {
    const data = state.classData[classNum];
    const remainRow = document.getElementById(`unified-remain-${classNum}`);
    if (!remainRow) return;
    
    const cells = remainRow.cells;
    let allDone = true;
    let sum = 0;

    allSubjects.forEach((sub, idx) => {
        let count = 0;
        for(let r=0; r<state.periodCount; r++) {
            for(let c=0; c<5; c++) {
                const key = `${r}-${c}`;
                let fixedSub = null;
                state.subjectSheets.forEach(sheet => { 
                    if (sheet.rules[key] && sheet.rules[key].includes(classNum)) fixedSub = sheet.subName; 
                });
                const currentVal = fixedSub || data.timetable[r][c];
                if(currentVal === sub) count++;
            }
        }
        const target = state.classData[1] ? state.classData[1].targetHours[idx] : data.targetHours[idx];
        const remain = target - count;
        sum += remain;
        if (cells[idx + 1]) {
            cells[idx + 1].innerText = remain;
            // ëª¨ë“  ê³¼ëª©ì— ë™ì¼í•˜ê²Œ ì ìš©: ëª©í‘œì‹œìˆ˜ê°€ 0ë³´ë‹¤ í¬ê³  ë‹¬ì„±ë„ê°€ 0ì´ë©´ ìƒ‰ ë³€ê²½
            if(target > 0 && remain === 0) {
                cells[idx + 1].className = 'target-zero';
            } else { 
                cells[idx + 1].className = ''; 
                if(remain !== 0) allDone = false; 
            }
        }
    });
    
    // í•©ê³„ ì—…ë°ì´íŠ¸
    const sumCell = document.getElementById(`remain-sum-${classNum}`);
    if (sumCell) {
        sumCell.innerText = sum;
    }
    
    // ì¹´ë“œì˜ ì™„ë£Œ ìƒíƒœë„ ì—…ë°ì´íŠ¸
    const card = document.getElementById(`card-${classNum}`);
    const badge = document.getElementById(`badge-${classNum}`);
    if (card && badge) {
        badge.style.display = allDone ? 'inline' : 'none';
        card.classList.toggle('completed', allDone);
    }
}

// ëª©í‘œì‹œìˆ˜ í•©ê³„ ê³„ì‚°
function updateTargetHoursSum() {
    const firstClass = state.classData[1];
    if (!firstClass) return;
    
    const sum = firstClass.targetHours.reduce((a, b) => a + b, 0);
    const sumCell = document.getElementById('target-hours-sum');
    if (sumCell) {
        sumCell.innerText = sum;
    }
}

// í•™ê¸‰ ì‹œê°„í‘œ ì‚­ì œ í•¨ìˆ˜
function clearClassTimetable(classNum) {
    if (!confirm(`${classNum}ë°˜ì˜ ì‹œê°„í‘œë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê³ ì •ëœ êµê³¼ëŠ” ì‚­ì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`)) {
        return;
    }
    
    const data = state.classData[classNum];
    if (!data) return;
    
    // ê³ ì •ëœ êµê³¼ë¥¼ ì œì™¸í•˜ê³  ëª¨ë“  ì…€ ë¹„ìš°ê¸°
    for (let r = 0; r < state.periodCount; r++) {
        for (let c = 0; c < 5; c++) {
            const key = `${r}-${c}`;
            let isFixed = false;
            state.subjectSheets.forEach(sheet => {
                if (sheet.rules[key] && sheet.rules[key].includes(classNum)) {
                    isFixed = true;
                }
            });
            
            if (!isFixed) {
                data.timetable[r][c] = '';
            }
        }
    }
    
    saveAndRefresh();
    
    // í†µí•© í‘œì˜ ë‹¬ì„±ë„ ì¬ê³„ì‚°
    calculateUnifiedStatus(classNum);
    
    // ì¹´ë“œ ë‹¤ì‹œ ë Œë”ë§
    const card = document.getElementById(`card-${classNum}`);
    if (card) {
        const grid = document.getElementById('classGrid');
        const newCard = createClassCard(classNum);
        grid.replaceChild(newCard, card);
    }
}
document.addEventListener('click', function(e) {
    if (!e.target.closest('.class-selector') && !e.target.closest('.master-td')) {
        closeSelector();
    }
    if (!e.target.closest('.subject-selector') && !e.target.closest('.subject-cell')) {
        closeSubjectSelector();
    }
});
init();
</script>

</body>
</html>