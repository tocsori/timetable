<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì´ˆë“± êµê³¼ë³„ ê³ ì • ë° ìë™ ë°°ì¹˜ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --fixed-bg: #e9ecef; --accent: #4a90e2; --sub-bg: #ffffff; --complete: #d4edda; }
        body { font-family: 'Malgun Gothic', sans-serif; padding: 20px; background: #f0f2f5; color: #333; line-height: 1.5; }
        
        /* ì£¼ì°¨ í‘œì‹œ */
        .week-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; font-size: 18px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .nav-buttons { text-align: right; margin-top: 10px; }
        
        .section { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 30px; }
        .section h2 { margin-top: 0; margin-bottom: 15px; }
        #classTimetableSection h2 { margin-top: 10px; }
        
        /* ê³ ì • êµê³¼ ì„¤ì • ìŠ¤íƒ€ì¼ */
        .subject-manager { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; flex-wrap: wrap; }
        #masterSheetsContainer { display: flex; flex-wrap: wrap; gap: 10px; }
        .master-sheet { border: 2px solid var(--accent); padding: 8px; border-radius: 8px; margin-bottom: 0; background: #f8fbff; width: fit-content; min-width: 280px; }
        .master-sheet h3 { margin-top: 0; margin-bottom: 5px; color: var(--accent); display: flex; justify-content: space-between; align-items: center; font-size: 16px; }
        .master-sheet table { font-size: 12px; margin: 5px 0; width: auto; }
        .master-sheet th, .master-sheet td { padding: 3px; height: 20px; font-size: 11px; width: auto; min-width: 35px; }
        .master-sheet textarea { height: 30px; font-size: 13px; padding: 3px; margin-top: 3px; width: 100%; }
        
        /* í•™ê¸‰ ì„ íƒ íŒì—… */
        .class-selector { display: none; position: absolute; background: white; border: 1px solid #ccc; padding: 10px; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 8px; min-width: 120px; }
        .class-selector label { display: block; font-size: 13px; cursor: pointer; padding: 4px; border-radius: 4px; }
        .class-selector label:hover { background: #f0f0f0; }
        
        /* ê³¼ëª© ì„ íƒ íŒì—… */
        .subject-selector { display: none; position: absolute; background: white; border: 1px solid #ccc; padding: 10px; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 8px; min-width: 150px; max-height: 300px; overflow-y: auto; }
        .subject-selector label { display: block; font-size: 12px; cursor: pointer; padding: 4px; border-radius: 4px; }
        .subject-selector label:hover { background: #f0f0f0; }
        .subject-cell { cursor: pointer; position: relative; }
        .subject-cell:hover { background: #eef5ff; }

        /* í•™ê¸‰ ê·¸ë¦¬ë“œ */
        .class-grid { display: flex; flex-wrap: wrap; gap: 10px; }
        .class-card { background: white; padding: 8px; border-radius: 8px; border: 1px solid #dee2e6; position: relative; width: fit-content; min-width: 280px; }
        .class-card.completed { border: 2px solid #28a745; background: #f9fffb; }
        .class-card h3 { margin-top: 0; margin-bottom: 5px; font-size: 16px; }
        .class-card h4 { margin: 8px 0 5px 0; font-size: 14px; }
        
        table { width: 100%; border-collapse: collapse; margin: 5px 0; font-size: 12px; table-layout: fixed; }
        th, td { border: 1px solid #ced4da; padding: 3px; text-align: center; height: 20px; }
        th { background: #eee; font-weight: bold; font-size: 11px; }
        .class-card table { width: auto; }
        .class-card th, .class-card td { font-size: 11px; min-width: 35px; }
        
        /* í†µí•© ì£¼ê°„ ì‹œìˆ˜ í‘œ ìµœì†Œí™” */
        #unifiedHoursTable { width: fit-content; }
        #unifiedHoursTable table { width: auto; font-size: 11px; margin: 3px 0; }
        #unifiedHoursTable th, #unifiedHoursTable td { padding: 2px 4px; height: 18px; font-size: 10px; min-width: 30px; }
        #unifiedHoursTable th { font-size: 10px; }
        #unifiedHoursTable input { width: 35px; font-size: 10px; padding: 1px; }
        
        .master-td { cursor: move; background: white; font-size: 10px; transition: 0.2s; user-select: none; }
        .master-td:hover { background: #eef5ff; border: 1px solid var(--accent); }
        .master-td.dragging { opacity: 0.5; }
        .master-td.drag-over { background-color: #fff3cd !important; border: 2px dashed #ffc107 !important; }
        .selected-classes { color: var(--accent); font-weight: bold; display: block; font-size: 10px; }

        .fixed-cell { background-color: var(--fixed-bg); color: #666; font-weight: bold; font-size: 11px; }
        .day-header { background: #e3f2fd !important; cursor: pointer !important; }
        .day-header:hover { background: #bbdefb !important; }
        .disabled-day-header { background: #ffcdd2 !important; cursor: pointer !important; }
        .disabled-day-header:hover { background: #ef9a9a !important; }
        .disabled-cell { opacity: 0.3; pointer-events: none; cursor: not-allowed !important; }
        .selected-subject { font-size: 11px; display: block; }
        .target-zero { background-color: var(--complete); font-weight: bold; }
        
        /* ê³¼ëª©ë³„ ìƒ‰ìƒ */
        .subject-korean { color: #e74c3c; font-weight: bold; }
        .subject-social { color: #3498db; font-weight: bold; }
        .subject-ethics { color: #9b59b6; font-weight: bold; }
        .subject-math { color: #e67e22; font-weight: bold; }
        .subject-science { color: #1abc9c; font-weight: bold; }
        .subject-practical { color: #f39c12; font-weight: bold; }
        .subject-pe { color: #27ae60; font-weight: bold; }
        .subject-music { color: #e91e63; font-weight: bold; }
        .subject-art { color: #ff9800; font-weight: bold; }
        .subject-english { color: #2196f3; font-weight: bold; }
        
        /* ë“œë˜ê·¸ ì•¤ ë“œë¡­ */
        .draggable-cell { cursor: move; user-select: none; }
        .dragging { opacity: 0.5; }
        .drag-over { background-color: #fff3cd !important; border: 2px dashed #ffc107 !important; }
        
        input, select, textarea { border: 1px solid #ddd; border-radius: 4px; padding: 3px; font-family: inherit; }
        .class-card input, .class-card select { font-size: 10px; padding: 2px; }
        .class-card textarea { width: 100%; height: 35px; resize: none; margin-top: 3px; font-size: 10px; border-color: #eee; padding: 3px; }
        
        .btn { padding: 6px 12px; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; margin: 2px; }
        .btn:hover { opacity: 0.8; }
        .btn-auto { background: #6c757d; float: right; }
        .btn-del { background: #dc3545; font-size: 11px; padding: 3px 8px; }
        .btn-clear { background: #dc3545; float: right; margin-left: 5px; }
        .btn-export { background: #28a745; }
        .btn-import { background: #17a2b8; }
        .btn-save { background: #ffc107; color: #333; }
        .btn-load { background: #fd7e14; }
        
        .badge { position: absolute; right: 8px; top: 8px; display: none; background: #28a745; color: white; padding: 2px 6px; border-radius: 10px; font-size: 9px; }
        
        .toolbar { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; align-items: center; justify-content: flex-end; }
        
        /* ì¸ì‡„ ìµœì í™” */
        @media print {
            body { padding: 0; background: white; }
            .section { page-break-inside: avoid; box-shadow: none; border: 1px solid #ddd; }
            .btn, .nav-buttons, .toolbar, .subject-manager button, .master-sheet button { display: none !important; }
            .class-card { page-break-inside: avoid; }
            .week-header { page-break-after: avoid; }
            textarea { border: none; background: transparent; }
        }
        
        /* íŒŒì¼ ì…ë ¥ ìˆ¨ê¹€ */
        #fileInput { display: none; }
    </style>
</head>
<body>
    <body>
    <!--ë’¤ë¡œê°€ê¸°ì‹œ ìƒˆë¡œê³ ì¹¨ ë° ì—°ê°„ì‹œìˆ˜í‘œ ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°-->
    <script>
        let isInitialLoad = true;
        
        window.addEventListener("pageshow", function (event) {
          if (event.persisted) {
            // ë’¤ë¡œê°€ê¸°/ì•ìœ¼ë¡œê°€ê¸° ì‹œ ì „ì²´ ìƒˆë¡œê³ ì¹¨
            location.reload();
          } else if (!isInitialLoad) {
            // ì¼ë°˜ í˜ì´ì§€ ë¡œë“œê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸° (ì¤‘ë³µ ë°©ì§€)
            console.log('[ë©”ì¸í˜ì´ì§€] pageshow ì´ë²¤íŠ¸ - ì—°ê°„ì‹œìˆ˜í‘œ ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°');
            setTimeout(() => {
              if (typeof loadAnnualDataOnInit === 'function') {
                loadAnnualDataOnInit();
              }
            }, 500);
          }
          isInitialLoad = false;
        });
        
        // í˜ì´ì§€ í¬ì»¤ìŠ¤ ì‹œì—ë„ ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸° (ë‹¤ë¥¸ íƒ­ì—ì„œ ëŒì•„ì˜¬ ë•Œ)
        window.addEventListener('focus', function() {
          console.log('[ë©”ì¸í˜ì´ì§€] focus ì´ë²¤íŠ¸ - ì—°ê°„ì‹œìˆ˜í‘œ ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°');
          setTimeout(() => {
            if (typeof loadAnnualDataOnInit === 'function') {
              loadAnnualDataOnInit();
            }
          }, 300);
        });
            </script>
<!-- ì£¼ì°¨ í‘œì‹œ -->
<div class="week-header">
    <div id="weekDisplay"></div>
    <div class="nav-buttons">
        <button class="btn" onclick="localStorage.setItem('annual_semester', '2'); location.href='annual.html'">ì—°ê°„ì‹œìˆ˜í‘œ</button>
        <button class="btn" onclick="location.href='admin.html'">ê´€ë¦¬ì í˜ì´ì§€</button>
        <button class="btn" onclick="logout()" style="background: #dc3545;">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
</div>

<!-- ì—°ê°„ì‹œìˆ˜í‘œ ì„ íƒ ì„¹ì…˜ -->
<div class="section" style="padding: 15px; margin-bottom: 20px;">
    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; justify-content: space-between;">
        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <label><strong>2í•™ê¸°</strong></label>
            <button class="btn" onclick="localStorage.setItem('annual_semester', '1'); location.href='main1.html'" style="background: #17a2b8; margin-left: 10px;">1í•™ê¸°ë¡œ ì´ë™</button>
            <div id="weekSelectorContainer" style="display: none; margin-left: 20px; align-items: center;">
                <button class="btn" onclick="changeWeek(-1)" style="padding: 6px 12px; font-size: 16px;">&lt;</button>
                <span id="annualWeekDisplay" style="margin: 0 10px; font-weight: bold; min-width: 80px; text-align: center; display: inline-block;"></span>
                <button class="btn" onclick="changeWeek(1)" style="padding: 6px 12px; font-size: 16px;">&gt;</button>
                <span id="periodDisplay" style="margin-left: 15px; font-weight: bold; color: var(--accent);"></span>
            </div>
        </div>
        <div class="toolbar" style="margin-left: auto;">
            <button class="btn btn-save" onclick="saveToServer()">ì„œë²„ì— ì €ì¥</button>
            <button class="btn btn-export" onclick="exportToExcel()">ì—‘ì…€ ë‚´ë³´ë‚´ê¸°</button>
            <button class="btn btn-import" onclick="document.getElementById('excelInput').click()">ì—‘ì…€ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <input type="file" id="excelInput" accept=".xlsx,.xls" onchange="importFromExcel(event)" style="display:none">
            <button class="btn" onclick="window.print()">ì¸ì‡„</button>
        </div>
    </div>
</div>

<div class="section">
    <h2>ğŸ“Š ì „ì²´ í•™ê¸‰ ì£¼ê°„ ì‹œìˆ˜ ë° ë‹¬ì„±ë„</h2>
    <div id="unifiedHoursTable"></div>
</div>

<div class="section" style="padding: 15px;">
    <h2 style="font-size: 16px; margin-bottom: 10px;">âš™ï¸ ê³ ì • êµê³¼ ë° ì „ë‹´ êµì‚¬ ì„¤ì •(ê³ ì • ì‹œê°„í‘œë¥¼ ìˆ˜ì •í•œ í›„ì—ëŠ” ê¼­ ì‹œê°„í‘œë¥¼ í™•ì¸í•˜ì„¸ìš”.)</h2>
    <div class="subject-manager">
        <span><strong>ìƒˆ ê³ ì • ì‹œíŠ¸:</strong></span>
        <select id="newSubName" style="width:120px;"></select>
        <input type="text" id="newSubTag" placeholder="íƒœê·¸ (ì˜ˆ: ë‹´ì„)" style="width:100px; padding: 5px; margin-right: 5px; border: 1px solid #ccc; border-radius: 3px;">
        <button class="btn" onclick="addSubjectSheet()">ì‹œíŠ¸ ìƒì„±</button>
        <button class="btn" onclick="copyAllFixedTimetables()" style="background: #17a2b8;">ëª¨ë“  ê³ ì •ì‹œê°„í‘œ ë³µì‚¬</button>
    </div>

    <div id="masterSheetsContainer"></div>
</div>

<div class="section" id="classTimetableSection">
    <h2>ğŸ« í•™ê¸‰ë³„ ì‹œê°„í‘œ ê´€ë¦¬ <span id="weekPeriodInfo" style="font-size: 14px; color: #666; font-weight: normal;"></span></h2>
    <div id="classGrid" class="class-grid"></div>
    <div id="unifiedMemoContainer" style="margin-top: 20px;">
        <h3 style="font-size: 14px; margin-bottom: 10px;">ğŸ“ ë©”ëª¨</h3>
        <div id="unifiedMemoContent"></div>
    </div>
</div>


<div id="globalClassSelector" class="class-selector"></div>
<div id="globalSubjectSelector" class="subject-selector"></div>

<script>
const allSubjects = ["êµ­ì–´", "ì‚¬íšŒ", "ë„ë•", "ìˆ˜í•™", "ê³¼í•™", "ì‹¤ê³¼", "ì²´ìœ¡", "ìŒì•…", "ë¯¸ìˆ ", "ì˜ì–´", "ì°½ì²´(ì)", "ì°½ì²´(ë™)", "ì°½ì²´(ë´‰)", "ì°½ì²´(ì§„)"];
const days = ["ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ"];

// ê³¼ëª©ë³„ CSS í´ë˜ìŠ¤ ë§¤í•‘
function getSubjectClass(subject) {
    const classMap = {
        'êµ­ì–´': 'subject-korean',
        'ì‚¬íšŒ': 'subject-social',
        'ë„ë•': 'subject-ethics',
        'ìˆ˜í•™': 'subject-math',
        'ê³¼í•™': 'subject-science',
        'ì‹¤ê³¼': 'subject-practical',
        'ì²´ìœ¡': 'subject-pe',
        'ìŒì•…': 'subject-music',
        'ë¯¸ìˆ ': 'subject-art',
        'ì˜ì–´': 'subject-english'
    };
    return classMap[subject] || '';
}

let state = {
    classCount: 3,
    periodCount: 7, // êµì‹œ ìˆ˜
    subjectSheets: [], // { subName, memo: "", rules: { "0-0": [1, 2] } }
    classData: {}, // { classNum: { timetable: [], targetHours: [], memo: "" } }
    preferences: {}, // { subject: [1, 2, 3] } - ì„ í˜¸í•˜ëŠ” êµì‹œ ë°°ì—´
    currentWeek: new Date(), // í˜„ì¬ ì£¼ì°¨
    annualHours: {}, // ì—°ê°„ì‹œìˆ˜í‘œ { subject: hours }
    annualTableData: null, // ì„ íƒëœ ì—°ê°„ì‹œìˆ˜í‘œ ë°ì´í„°
    memo: "", // í†µí•© ë©”ëª¨
    weeklyData2: {}, // 2í•™ê¸° ì£¼ë³„ ë°ì´í„° { weekIndex: { subjectSheets: [], classData: {} } }
    disabledDays: {}, // { "ì›”": true, "í™”": false } - ë¹„í™œì„±í™”ëœ ìš”ì¼
    dayPeriodLimits: {} // { "ìˆ˜": 5 } - ìš”ì¼ë³„ ìˆ˜ì—… ìˆ˜ ì œí•œ (ì˜ˆ: ìˆ˜ìš”ì¼ì€ 5êµì‹œê¹Œì§€)
};

function init() {
    // ë¡œê·¸ì¸ ì²´í¬
    const loginInfo = localStorage.getItem('timetable_login');
    if (!loginInfo) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        window.location.href = 'login.html';
        return;
    }
    
    // ì„œë²„ì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    loadDataFromServer();
}

// ì„œë²„ì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
function loadDataFromServer() {
    const loginInfo = JSON.parse(localStorage.getItem('timetable_login'));
    const nickname = loginInfo.nickname;
    
    // ì—°ê°„ì‹œìˆ˜í‘œ ë°ì´í„°ëŠ” ë³„ë„ë¡œ ë¶ˆëŸ¬ì˜¤ë¯€ë¡œ ë³´í˜¸ (ëª…ì‹œì ìœ¼ë¡œ ë³´í˜¸)
    const preservedAnnualTableData = state.annualTableData;
    console.log('[ë©”ì¸í˜ì´ì§€ 2í•™ê¸°] loadDataFromServer ì‹œì‘ - ë³´ì¡´í•  ì—°ê°„ì‹œìˆ˜í‘œ ë°ì´í„°:', preservedAnnualTableData ? `${preservedAnnualTableData.length}í–‰` : 'null');
    
    fetch(`${window.location.origin}/api/data?nickname=${encodeURIComponent(nickname)}`)
        .then(response => response.json())
        .then(result => {
            if (result.success && result.data) {
                const parsed = result.data;
                
                // annualTableDataëŠ” ë³„ë„ APIì—ì„œ ë¶ˆëŸ¬ì˜¤ë¯€ë¡œ ë³´í˜¸
                const hadAnnualTableData1 = parsed.annualTableData1 !== undefined;
                const hadAnnualTableData2 = parsed.annualTableData2 !== undefined;
                
                delete parsed.annualTableData;
                delete parsed.annualTableData1;  // 1í•™ê¸° ì—°ê°„ì‹œìˆ˜í‘œ ë°ì´í„° ì œì™¸
                delete parsed.annualTableData2;  // 2í•™ê¸° ì—°ê°„ì‹œìˆ˜í‘œ ë°ì´í„° ì œì™¸
                
                if (hadAnnualTableData1 || hadAnnualTableData2) {
                    console.log(`[ë©”ì¸í˜ì´ì§€ 2í•™ê¸°] ì„œë²„ ë°ì´í„°ì—ì„œ ì—°ê°„ì‹œìˆ˜í‘œ ì œì™¸ - annualTableData1: ${hadAnnualTableData1}, annualTableData2: ${hadAnnualTableData2}`);
                }
                
                // Object.assign ì „ì— annualTableDataë¥¼ ëª…ì‹œì ìœ¼ë¡œ ë³´í˜¸
                const currentAnnualTableData = state.annualTableData;
                
                Object.assign(state, parsed);
                
                // annualTableDataëŠ” í•­ìƒ ë³´í˜¸ (ì„œë²„ ë°ì´í„°ì— í¬í•¨ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ)
                state.annualTableData = currentAnnualTableData || preservedAnnualTableData;
                
                if (parsed.currentWeek) state.currentWeek = new Date(parsed.currentWeek);
                // periodCountê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ 7 ì„¤ì •
                if (!state.periodCount) state.periodCount = 7;
                // annualHoursê°€ ì—†ìœ¼ë©´ ë¹ˆ ê°ì²´ ì„¤ì •
                if (!state.annualHours) state.annualHours = {};
                // weeklyData2ê°€ ì—†ìœ¼ë©´ ë¹ˆ ê°ì²´ ì„¤ì •
                if (!state.weeklyData2) state.weeklyData2 = {};
                
                console.log('[ë©”ì¸í˜ì´ì§€ 2í•™ê¸°] Object.assign í›„ annualTableData ìƒíƒœ:', state.annualTableData ? `${state.annualTableData.length}í–‰` : 'null');
            } else {
                // ì´ˆê¸° ìƒíƒœ ì„¤ì • (annualTableDataëŠ” ë³´í˜¸)
                const currentAnnualTableData = state.annualTableData;
                state.periodCount = 7;
                state.annualHours = {};
                state.weeklyData2 = {};
                state.annualTableData = currentAnnualTableData || preservedAnnualTableData;
            }
            
            // ê³¼ëª© ì„ íƒ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
            const subSelect = document.getElementById('newSubName');
            allSubjects.forEach(s => subSelect.add(new Option(s, s)));
            
            updateWeekDisplay();
            renderAll();
            
            // ê¸°ë³¸ê°’ìœ¼ë¡œ 2í•™ê¸° 1ì£¼ ìë™ ë¡œë“œ (í•­ìƒ ì„œë²„ì—ì„œ ìµœì‹  ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°)
            console.log('[ë©”ì¸í˜ì´ì§€] ì¼ë°˜ ë°ì´í„° ë¡œë“œ ì™„ë£Œ, ì—°ê°„ì‹œìˆ˜í‘œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹œì‘');
            loadAnnualDataOnInit();
        })
        .catch(error => {
            console.error('ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
            alert('ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            // ì´ˆê¸° ìƒíƒœë¡œ ì§„í–‰ (annualTableDataëŠ” ë³´í˜¸)
            const currentAnnualTableData = state.annualTableData;
            state.periodCount = 7;
            state.annualHours = {};
            state.weeklyData2 = {};
            state.annualTableData = currentAnnualTableData || preservedAnnualTableData;
            
            const subSelect = document.getElementById('newSubName');
            allSubjects.forEach(s => subSelect.add(new Option(s, s)));
            
            updateWeekDisplay();
            renderAll();
            
            // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ì—°ê°„ì‹œìˆ˜í‘œ ë°ì´í„°ëŠ” ë¶ˆëŸ¬ì˜¤ê¸° ì‹œë„
            console.log('[ë©”ì¸í˜ì´ì§€ 2í•™ê¸°] ì¼ë°˜ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨, ì—°ê°„ì‹œìˆ˜í‘œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹œë„');
            loadAnnualDataOnInit();
        });
}

// ì´ˆê¸°í™” ì‹œ 2í•™ê¸° 1ì£¼ ìë™ ë¡œë“œ
function loadAnnualDataOnInit() {
    const semester = '2'; // main2.htmlì€ 2í•™ê¸° í˜ì´ì§€
    const loginInfoStr = localStorage.getItem('timetable_login');
    
    if (!loginInfoStr) {
        console.log('[ë©”ì¸í˜ì´ì§€] ë¡œê·¸ì¸ ì •ë³´ ì—†ìŒ');
        return;
    }
    
    let loginInfo;
    try {
        loginInfo = JSON.parse(loginInfoStr);
    } catch (e) {
        console.error('[ë©”ì¸í˜ì´ì§€] ë¡œê·¸ì¸ ì •ë³´ íŒŒì‹± ì˜¤ë¥˜:', e);
        return;
    }
    
    const nickname = loginInfo.nickname;
    if (!nickname) {
        console.log('[ë©”ì¸í˜ì´ì§€] ë‹‰ë„¤ì„ ì—†ìŒ');
        return;
    }
    
    console.log(`[ë©”ì¸í˜ì´ì§€ 2í•™ê¸°] ì—°ê°„ì‹œìˆ˜í‘œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹œì‘ - ë‹‰ë„¤ì„: ${nickname}, í•™ê¸°: ${semester}`);
    console.log(`[ë©”ì¸í˜ì´ì§€ 2í•™ê¸°] í˜„ì¬ state.annualTableData ìƒíƒœ:`, state.annualTableData ? `${state.annualTableData.length}í–‰` : 'null');
    
    fetch(`${window.location.origin}/api/annual-data?nickname=${encodeURIComponent(nickname)}&semester=${semester}`)
        .then(response => {
            console.log(`[ë©”ì¸í˜ì´ì§€] ì„œë²„ ì‘ë‹µ ìƒíƒœ: ${response.status}`);
            if (!response.ok) {
                return response.json().then(err => {
                    console.error(`[ë©”ì¸í˜ì´ì§€] ì„œë²„ ì˜¤ë¥˜: ${err.message || `HTTP ${response.status}`}`);
                    return null;
                });
            }
            return response.json();
        })
        .then(result => {
            if (!result || !result.success) {
                console.log(`[ë©”ì¸í˜ì´ì§€] ì—°ê°„ì‹œìˆ˜í‘œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨ - success: ${result ? result.success : 'null'}`);
                const weekContainer = document.getElementById('weekSelectorContainer');
                if (weekContainer) {
                    weekContainer.innerHTML = '<span style="color: #dc3545; font-weight: bold;">ì—°ê°„ì‹œìˆ˜í‘œë¥¼ ë¨¼ì € ì…ë ¥ í•´ì£¼ì„¸ìš”.</span>';
                    weekContainer.style.display = 'flex';
                }
                return;
            }
            
            const data = result.data;
            if (!data || !Array.isArray(data) || data.length === 0) {
                console.log(`[ë©”ì¸í˜ì´ì§€] ì—°ê°„ì‹œìˆ˜í‘œ ë°ì´í„° ì—†ìŒ - data:`, data);
                const weekContainer = document.getElementById('weekSelectorContainer');
                if (weekContainer) {
                    weekContainer.innerHTML = '<span style="color: #dc3545; font-weight: bold;">ì—°ê°„ì‹œìˆ˜í‘œë¥¼ ë¨¼ì € ì…ë ¥ í•´ì£¼ì„¸ìš”.</span>';
                    weekContainer.style.display = 'flex';
                }
                return;
            }
            
            console.log(`[ë©”ì¸í˜ì´ì§€ 2í•™ê¸°] ì—°ê°„ì‹œìˆ˜í‘œ ë¶ˆëŸ¬ì˜¤ê¸° ì„±ê³µ - ë°ì´í„° í–‰ ìˆ˜: ${data.length}`);
            
            // ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë°˜ë“œì‹œ stateì— ì €ì¥
            if (data && Array.isArray(data) && data.length > 0) {
                state.annualTableData = data;
                console.log(`[ë©”ì¸í˜ì´ì§€ 2í•™ê¸°] state.annualTableDataì— ë°ì´í„° ì €ì¥ ì™„ë£Œ - ${data.length}í–‰`);
                console.log(`[ë©”ì¸í˜ì´ì§€ 2í•™ê¸°] ì €ì¥ í›„ state.annualTableData í™•ì¸:`, state.annualTableData ? `${state.annualTableData.length}í–‰` : 'null');
                
                // ì£¼ ì„ íƒ ì»¨í…Œì´ë„ˆ í‘œì‹œ
                const weekContainer = document.getElementById('weekSelectorContainer');
                
                // ì²« ë²ˆì§¸ ì£¼ë¡œ ì´ˆê¸°í™”
                currentWeekIndex = 0;
                
                // ì²« ë²ˆì§¸ ì£¼ì˜ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
                loadWeekDataFromStorage(currentWeekIndex);
                
                // í™”ë©´ ì—…ë°ì´íŠ¸
                updateAnnualWeekDisplay();
                updateWeekPeriodInfo();
                renderAll();
                
                // ëª©í‘œì‹œìˆ˜ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
                loadWeekData();
                
                if (weekContainer) {
                    weekContainer.style.display = 'flex';
                }
                console.log(`[ë©”ì¸í˜ì´ì§€ 2í•™ê¸°] ì—°ê°„ì‹œìˆ˜í‘œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ - ì£¼/ê¸°ê°„ í‘œì‹œ í™œì„±í™”`);
            } else {
                // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ state.annualTableDataë¥¼ nullë¡œ ì„¤ì •í•˜ì—¬ ëª…í™•íˆ í•¨
                state.annualTableData = null;
                console.log(`[ë©”ì¸í˜ì´ì§€ 2í•™ê¸°] ì—°ê°„ì‹œìˆ˜í‘œ ë°ì´í„° ì—†ìŒ - state.annualTableDataë¥¼ nullë¡œ ì„¤ì •`);
                const weekContainer = document.getElementById('weekSelectorContainer');
                if (weekContainer) {
                    weekContainer.innerHTML = '<span style="color: #dc3545; font-weight: bold;">ì—°ê°„ì‹œìˆ˜í‘œë¥¼ ë¨¼ì € ì…ë ¥ í•´ì£¼ì„¸ìš”.</span>';
                    weekContainer.style.display = 'flex';
                }
            }
        })
        .catch(error => {
            console.error('[ë©”ì¸í˜ì´ì§€] ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            console.error('[ë©”ì¸í˜ì´ì§€] ì˜¤ë¥˜ ìƒì„¸:', error.stack);
            // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ state.annualTableDataë¥¼ ëª…í™•íˆ ì„¤ì •
            state.annualTableData = null;
        });
}

function logout() {
    if (confirm('ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        localStorage.removeItem('timetable_login');
        window.location.href = 'login.html';
    }
}

// ì£¼ì°¨ í‘œì‹œ ì—…ë°ì´íŠ¸ (ë¡œê·¸ì¸ ì •ë³´ë¡œ ë³€ê²½)
function updateWeekDisplay() {
    const loginInfo = localStorage.getItem('timetable_login');
    if (loginInfo) {
        try {
            const login = JSON.parse(loginInfo);
            if (login.schoolName && login.grade) {
                document.getElementById('weekDisplay').innerHTML = 
                    `${login.schoolName} ${login.grade}í•™ë…„ ì‹œê°„í‘œ - 2í•™ê¸°`;
                return;
            }
        } catch (e) {
            // íŒŒì‹± ì˜¤ë¥˜ ì‹œ ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©
        }
    }
    
    // ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìœ¼ë©´ ê¸°ì¡´ ì£¼ì°¨ í‘œì‹œ
    const date = state.currentWeek || new Date();
    const year = date.getFullYear();
    const month = date.getMonth() + 1;
    
    // í•´ë‹¹ ì›”ì˜ ì²« ë²ˆì§¸ ë‚ 
    const firstDay = new Date(year, month - 1, 1);
    const firstDayOfWeek = firstDay.getDay();
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDayOfWeek);
    
    // í˜„ì¬ ë‚ ì§œê°€ ì†í•œ ì£¼ ì°¾ê¸°
    const diffTime = date.getTime() - startDate.getTime();
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    const weekNumber = Math.floor(diffDays / 7) + 1;
    
    // í•´ë‹¹ ì£¼ì˜ ì‹œì‘ì¼
    const weekStart = new Date(startDate);
    weekStart.setDate(startDate.getDate() + (weekNumber - 1) * 7);
    const weekStartMonth = weekStart.getMonth() + 1;
    const weekStartDate = weekStart.getDate();
    
    document.getElementById('weekDisplay').innerHTML = 
        `${month}ì›” ${weekStartDate}ì¼ ì£¼ (${weekNumber}ì£¼ì°¨) - 2í•™ê¸°`;
}

// ì£¼ì™€ ê¸°ê°„ ì •ë³´ ì—…ë°ì´íŠ¸
function updateWeekPeriodInfo() {
    const weekPeriodInfo = document.getElementById('weekPeriodInfo');
    if (!weekPeriodInfo) return;
    
    if (!state.annualTableData || state.annualTableData.length === 0) {
        console.log('[ë©”ì¸í˜ì´ì§€] updateWeekPeriodInfo - ì—°ê°„ì‹œìˆ˜í‘œ ë°ì´í„° ì—†ìŒ');
        weekPeriodInfo.textContent = '';
        return;
    }
    
    if (currentWeekIndex >= 0 && currentWeekIndex < state.annualTableData.length) {
        const weekData = state.annualTableData[currentWeekIndex];
        if (weekData) {
            const week = currentWeekIndex + 1;
            const period = weekData['ê¸°ê°„'] || '';
            weekPeriodInfo.textContent = `(${week}ì£¼${period ? `, ê¸°ê°„: ${period}` : ''})`;
            console.log(`[ë©”ì¸í˜ì´ì§€] ì£¼/ê¸°ê°„ ì •ë³´ ì—…ë°ì´íŠ¸: ${week}ì£¼${period ? `, ê¸°ê°„: ${period}` : ''}`);
        } else {
            weekPeriodInfo.textContent = '';
        }
    } else {
        console.log(`[ë©”ì¸í˜ì´ì§€] updateWeekPeriodInfo - ìœ íš¨í•˜ì§€ ì•Šì€ ì£¼ ì¸ë±ìŠ¤: ${currentWeekIndex}`);
        weekPeriodInfo.textContent = '';
    }
}


function saveAndRefresh(full = true) {
    // í˜„ì¬ ì£¼ì˜ ë°ì´í„°ë¥¼ ì£¼ë³„ ë°ì´í„°ì— ì €ì¥
    if (currentWeekIndex >= 0) {
        saveCurrentWeekData();
    }
    
    // ì„œë²„ì— ë°ì´í„° ì €ì¥
    saveDataToServer();
    
    if (full) { renderMasterSheets(); renderClassGrid(); renderUnifiedMemo(); }
}

// ì„œë²„ì— ë°ì´í„° ì €ì¥
function saveDataToServer() {
    const loginInfo = localStorage.getItem('timetable_login');
    if (!loginInfo) return;
    
    const login = JSON.parse(loginInfo);
    const nickname = login.nickname;
    
    fetch(`${window.location.origin}/api/data`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            nickname: nickname,
            state: state
        })
    })
    .then(response => response.json())
    .then(result => {
        if (!result.success) {
            console.error('ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', result.message);
        }
    })
    .catch(error => {
        console.error('ë°ì´í„° ì €ì¥ ì˜¤ë¥˜:', error);
    });
}

// í˜„ì¬ ì£¼ì˜ ë°ì´í„°ë¥¼ ì €ì¥
function saveCurrentWeekData() {
    if (currentWeekIndex < 0) return;
    
    if (!state.weeklyData2) state.weeklyData2 = {};
    
    // í˜„ì¬ ì£¼ì˜ subjectSheetsì™€ classDataë¥¼ ê¹Šì€ ë³µì‚¬ë¡œ ì €ì¥
    state.weeklyData2[currentWeekIndex] = {
        subjectSheets: JSON.parse(JSON.stringify(state.subjectSheets)),
        classData: JSON.parse(JSON.stringify(state.classData))
    };
}

// íŠ¹ì • ì£¼ì˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê¸°
function loadWeekDataFromStorage(weekIndex) {
    if (!state.weeklyData2 || !state.weeklyData2[weekIndex]) {
        // ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
        state.subjectSheets = [];
        state.classData = {};
        
        // í•™ê¸‰ ë°ì´í„° ì´ˆê¸°í™”
        for (let i = 1; i <= state.classCount; i++) {
            if (!state.classData[i]) {
                state.classData[i] = { 
                    timetable: Array(state.periodCount).fill().map(() => Array(5).fill("")), 
                    targetHours: Array(allSubjects.length).fill(0),
                    memo: ""
                };
            }
        }
    } else {
        // ì €ì¥ëœ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        const weekData = state.weeklyData2[weekIndex];
        state.subjectSheets = JSON.parse(JSON.stringify(weekData.subjectSheets));
        state.classData = JSON.parse(JSON.stringify(weekData.classData));
    }
}

// ì„œë²„ì— ì €ì¥
function saveToServer() {
    saveDataToServer();
    alert('ì„œë²„ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

// íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
function loadFromFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const loaded = JSON.parse(e.target.result);
            Object.assign(state, loaded);
            if (loaded.currentWeek) state.currentWeek = new Date(loaded.currentWeek);
            updateWeekDisplay();
            renderPreferences();
            renderAll();
            alert('íŒŒì¼ì„ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
        } catch (err) {
            alert('íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
        }
    };
    reader.readAsText(file);
}

// ì—‘ì…€ ë‚´ë³´ë‚´ê¸°
function exportToExcel() {
    const wb = XLSX.utils.book_new();
    
    // ê³ ì • êµê³¼ ì‹œíŠ¸
    const masterData = [];
    masterData.push(['ê³ ì • êµê³¼ ì„¤ì •']);
    state.subjectSheets.forEach(sheet => {
        masterData.push([`[${sheet.subName}] ê³ ì • ì‹œê°„í‘œ`]);
        masterData.push(['êµì‹œ', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ']);
        for (let r = 0; r < state.periodCount; r++) {
            const row = [r + 1];
            for (let c = 0; c < 5; c++) {
                const key = `${r}-${c}`;
                const classes = sheet.rules[key] || [];
                row.push(classes.length > 0 ? classes.join(',') + 'ë°˜' : '');
            }
            masterData.push(row);
        }
        masterData.push([]);
    });
    const masterWs = XLSX.utils.aoa_to_sheet(masterData);
    XLSX.utils.book_append_sheet(wb, masterWs, 'ê³ ì •êµê³¼');
    
    // í•™ê¸‰ë³„ ì‹œê°„í‘œ ì‹œíŠ¸
    for (let i = 1; i <= state.classCount; i++) {
        if (!state.classData[i]) continue;
        const data = state.classData[i];
        const classData = [];
        classData.push([`${i}ë°˜ ì‹œê°„í‘œ`]);
        classData.push(['êµì‹œ', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ']);
        
        for (let r = 0; r < state.periodCount; r++) {
            const row = [r + 1];
            for (let c = 0; c < 5; c++) {
                const key = `${r}-${c}`;
                let fixedSub = null;
                state.subjectSheets.forEach(sheet => {
                    if (sheet.rules[key] && sheet.rules[key].includes(i)) fixedSub = sheet.subName;
                });
                row.push(fixedSub || data.timetable[r][c] || '');
            }
            classData.push(row);
        }
        
        classData.push([]);
        classData.push(['ê³¼ëª©', ...allSubjects]);
        classData.push(['ëª©í‘œì‹œìˆ˜', ...data.targetHours]);
        
        if (data.memo) {
            classData.push([]);
            classData.push(['ë©”ëª¨', data.memo]);
        }
        
        const ws = XLSX.utils.aoa_to_sheet(classData);
        XLSX.utils.book_append_sheet(wb, ws, `${i}ë°˜`);
    }
    
    XLSX.writeFile(wb, `ì‹œê°„í‘œ_${new Date().toISOString().split('T')[0]}.xlsx`);
}

// ì—‘ì…€ ë¶ˆëŸ¬ì˜¤ê¸°
function importFromExcel(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            
            // í•™ê¸‰ë³„ ì‹œíŠ¸ ì½ê¸°
            for (let i = 1; i <= state.classCount; i++) {
                const sheetName = `${i}ë°˜`;
                if (!workbook.Sheets[sheetName]) continue;
                
                const ws = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
                
                if (!state.classData[i]) {
                    state.classData[i] = { 
                        timetable: Array(state.periodCount).fill().map(() => Array(5).fill("")), 
                        targetHours: Array(allSubjects.length).fill(0),
                        memo: ""
                    };
                }
                
                // ì‹œê°„í‘œ ì½ê¸° (2í–‰ë¶€í„° ì‹œì‘)
                for (let r = 2; r < 2 + state.periodCount && r - 2 < state.periodCount; r++) {
                    if (!jsonData[r]) continue;
                    for (let c = 1; c < 6 && c - 1 < 5; c++) {
                        const val = jsonData[r][c];
                        if (val && typeof val === 'string') {
                            state.classData[i].timetable[r - 2][c - 1] = val;
                        }
                    }
                }
                
                // ëª©í‘œì‹œìˆ˜ ì½ê¸°
                const targetRow = jsonData.findIndex(row => row && row[0] === 'ëª©í‘œì‹œìˆ˜');
                if (targetRow >= 0 && jsonData[targetRow]) {
                    for (let idx = 0; idx < allSubjects.length && idx + 1 < jsonData[targetRow].length; idx++) {
                        const val = jsonData[targetRow][idx + 1];
                        if (typeof val === 'number') {
                            state.classData[i].targetHours[idx] = val;
                        }
                    }
                }
                
                // ë©”ëª¨ ì½ê¸°
                const memoRow = jsonData.findIndex(row => row && row[0] === 'ë©”ëª¨');
                if (memoRow >= 0 && jsonData[memoRow] && jsonData[memoRow][1]) {
                    state.classData[i].memo = String(jsonData[memoRow][1]);
                }
            }
            
            renderAll();
            alert('ì—‘ì…€ íŒŒì¼ì„ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
        } catch (err) {
            alert('ì—‘ì…€ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
        }
    };
    reader.readAsArrayBuffer(file);
}

function updateClassCount(val) {
    state.classCount = parseInt(val);
    saveAndRefresh();
}

function addSubjectSheet() {
    const name = document.getElementById('newSubName').value;
    if (!name) return alert("ê³¼ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    state.subjectSheets.push({ subName: name, memo: "", rules: {} });
    saveAndRefresh();
}

function deleteSheet(idx) {
    if(confirm("í•´ë‹¹ êµê³¼ ê³ ì • ì„¤ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        const sheet = state.subjectSheets[idx];
        
        // ì‚­ì œë  ê³ ì • ì‹œíŠ¸ì˜ ëª¨ë“  ê·œì¹™ì— ëŒ€í•´ í•´ë‹¹ ì…€ì˜ ë‚´ìš© ì‚­ì œ
        Object.keys(sheet.rules || {}).forEach(key => {
            const [r, c] = key.split('-').map(Number);
            const classNums = sheet.rules[key] || [];
            
            classNums.forEach(classNum => {
                // ë‹¤ë¥¸ ê³ ì • ì‹œíŠ¸ì—ì„œë„ ê°™ì€ ì…€ì„ ì‚¬ìš©í•˜ëŠ”ì§€ í™•ì¸
                let isStillFixed = false;
                state.subjectSheets.forEach((otherSheet, otherIdx) => {
                    if (otherIdx !== idx && otherSheet.rules[key] && otherSheet.rules[key].includes(classNum)) {
                        isStillFixed = true;
                    }
                });
                
                // ë” ì´ìƒ ê³ ì •ë˜ì§€ ì•Šìœ¼ë©´ ì…€ ë‚´ìš© ì‚­ì œ
                if (!isStillFixed && state.classData[classNum]) {
                    state.classData[classNum].timetable[r][c] = '';
                }
            });
        });
        
        state.subjectSheets.splice(idx, 1);
        saveAndRefresh();
    }
}

// ê³ ì • ì‹œíŠ¸ ë Œë”ë§
function renderMasterSheets() {
    const container = document.getElementById('masterSheetsContainer');
    container.innerHTML = '';

    state.subjectSheets.forEach((sheet, sIdx) => {
        const div = document.createElement('div');
        div.className = 'master-sheet';
        const titleCls = getSubjectClass(sheet.subName);
        const tagDisplay = sheet.tag ? ` <span style="color: #666; font-size: 12px;">${sheet.tag}</span>` : '';
        let html = `<h3><span class="${titleCls}">[${sheet.subName}]</span>${tagDisplay} ê³ ì • ì‹œê°„í‘œ <button class="btn" style="background: #6c757d; font-size: 11px; padding: 3px 8px;" onclick="showGlobalCopyDialog(${sIdx})">ë³µì‚¬</button> <button class="btn btn-del" onclick="deleteSheet(${sIdx})">ì‚­ì œ</button></h3>`;
        html += `<table><thead><tr><th>êµì‹œ</th>${days.map(d => `<th>${d}</th>`).join('')}</tr></thead><tbody>`;
        
        for (let r = 0; r < state.periodCount; r++) {
            html += `<tr><th>${r+1}</th>`;
            for (let c = 0; c < 5; c++) {
                const key = `${r}-${c}`;
                const selected = sheet.rules[key] || [];
                html += `<td class="master-td draggable-cell" 
                            draggable="true"
                            onclick="showClassSelector(event, ${sIdx}, ${r}, ${c})"
                            ondragstart="handleMasterDragStart(event, ${sIdx}, ${r}, ${c})"
                            ondragover="handleMasterDragOver(event)"
                            ondrop="handleMasterDrop(event, ${sIdx}, ${r}, ${c})"
                            ondragend="handleMasterDragEnd(event)">
                            <span class="selected-classes">${selected.length > 0 ? selected.join(',') + 'ë°˜' : '+'}</span>
                         </td>`;
            }
            html += `</tr>`;
        }
        html += `</tbody></table>`;
        html += `<textarea placeholder="${sheet.subName} êµê³¼ ê´€ë ¨ ê³µì§€/ë©”ëª¨..." onchange="updateSheetMemo(${sIdx}, this.value)">${sheet.memo || ""}</textarea>`;
        div.innerHTML = html;
        container.appendChild(div);
    });
}

function updateSheetMemo(idx, val) {
    state.subjectSheets[idx].memo = val;
    saveAndRefresh(false);
}

// í•™ê¸‰ ì„ íƒ íŒì—…
function showClassSelector(event, sIdx, r, c) {
    event.stopPropagation();
    const selector = document.getElementById('globalClassSelector');
    const key = `${r}-${c}`;
    const selectedClasses = state.subjectSheets[sIdx].rules[key] || [];

    // ë‹¤ë¥¸ ì „ë‹´ ê³ ì •í‘œì˜ ê°™ì€ ì¢Œí‘œì— ì´ë¯¸ ì„ íƒëœ ë°˜ ì°¾ê¸°
    const occupiedClasses = new Set();
    state.subjectSheets.forEach((sheet, idx) => {
        if (idx !== sIdx && sheet.rules[key]) {
            sheet.rules[key].forEach(classNum => {
                occupiedClasses.add(classNum);
            });
        }
    });

    let html = `<strong>ëŒ€ìƒ í•™ê¸‰</strong><hr>`;
    for (let i = 1; i <= state.classCount; i++) {
        const checked = selectedClasses.includes(i) ? 'checked' : '';
        const disabled = occupiedClasses.has(i) && !selectedClasses.includes(i) ? 'disabled' : '';
        const disabledText = occupiedClasses.has(i) && !selectedClasses.includes(i) ? ' (ë‹¤ë¥¸ ê³ ì • ì‹œê°„í‘œì—ì„œ ì‚¬ìš© ì¤‘)' : '';
        const style = disabled ? 'style="opacity: 0.5; cursor: not-allowed;"' : '';
        html += `<label ${style}><input type="checkbox" value="${i}" ${checked} ${disabled} onchange="toggleRule(${sIdx}, ${r}, ${c}, ${i}, this.checked)"> ${i}ë°˜${disabledText}</label>`;
    }
    html += `<hr><button class="btn" style="width:100%; font-size:11px;" onclick="closeSelector()">ë‹«ê¸°</button>`;
    
    selector.innerHTML = html;
    selector.style.display = 'block';
    selector.style.left = (event.pageX + 10) + 'px';
    selector.style.top = (event.pageY + 10) + 'px';
}

function toggleRule(sIdx, r, c, classNum, isChecked) {
    const key = `${r}-${c}`;
    if (!state.subjectSheets[sIdx].rules[key]) state.subjectSheets[sIdx].rules[key] = [];
    
    if (isChecked) {
        // ë‹¤ë¥¸ ì „ë‹´ ê³ ì •í‘œì˜ ê°™ì€ ì¢Œí‘œì— ì´ë¯¸ ì„ íƒëœ ë°˜ì¸ì§€ í™•ì¸
        let isOccupied = false;
        state.subjectSheets.forEach((sheet, idx) => {
            if (idx !== sIdx && sheet.rules[key] && sheet.rules[key].includes(classNum)) {
                isOccupied = true;
            }
        });
        
        if (isOccupied) {
            alert(`${classNum}ë°˜ì€ ë‹¤ë¥¸ ê³ ì • ì‹œê°„í‘œì—ì„œ ì´ë¯¸ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤.`);
            // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë˜ëŒë¦¬ê¸°
            const selector = document.getElementById('globalClassSelector');
            const checkbox = selector.querySelector(`input[value="${classNum}"]`);
            if (checkbox) checkbox.checked = false;
            return;
        }
        
        if (!state.subjectSheets[sIdx].rules[key].includes(classNum)) {
            state.subjectSheets[sIdx].rules[key].push(classNum);
        }
    } else {
        // ì²´í¬ í•´ì œ ì‹œ: í•´ë‹¹ ì…€ì˜ ë‚´ìš© ì‚­ì œ
        state.subjectSheets[sIdx].rules[key] = state.subjectSheets[sIdx].rules[key].filter(n => n !== classNum);
        
        // í•´ë‹¹ ì…€ì´ ë” ì´ìƒ ê³ ì •ë˜ì§€ ì•Šìœ¼ë©´ ë‚´ìš© ì‚­ì œ
        let isStillFixed = false;
        state.subjectSheets.forEach((sheet, idx) => {
            if (sheet.rules[key] && sheet.rules[key].includes(classNum)) {
                isStillFixed = true;
            }
        });
        
        if (!isStillFixed && state.classData[classNum]) {
            state.classData[classNum].timetable[r][c] = '';
        }
    }
    saveAndRefresh();
}

function closeSelector() { document.getElementById('globalClassSelector').style.display = 'none'; }

// ê³¼ëª© ì„ íƒ íŒì—…
function showSubjectSelector(event, classNum, r, c) {
    event.stopPropagation();
    const selector = document.getElementById('globalSubjectSelector');
    const cellValue = state.classData[classNum].timetable[r][c] || '';

    let html = `<strong>ê³¼ëª© ì„ íƒ</strong><hr>`;
    html += `<label><input type="checkbox" value="" ${cellValue === '' ? 'checked' : ''} onchange="updateCellFromCheckbox(${classNum}, ${r}, ${c}, '', this.checked)"> (ì—†ìŒ)</label>`;
    allSubjects.forEach(sub => {
        const checked = cellValue === sub ? 'checked' : '';
        html += `<label><input type="checkbox" value="${sub}" ${checked} onchange="updateCellFromCheckbox(${classNum}, ${r}, ${c}, '${sub}', this.checked)"> ${sub}</label>`;
    });
    html += `<hr><button class="btn" style="width:100%; font-size:11px;" onclick="closeSubjectSelector()">ë‹«ê¸°</button>`;
    
    selector.innerHTML = html;
    selector.style.display = 'block';
    selector.style.left = (event.pageX + 10) + 'px';
    selector.style.top = (event.pageY + 10) + 'px';
}

function updateCellFromCheckbox(classNum, r, c, subject, isChecked) {
    // ë‹¤ë¥¸ ì²´í¬ë°•ìŠ¤ ëª¨ë‘ í•´ì œ
    const checkboxes = document.querySelectorAll('#globalSubjectSelector input[type="checkbox"]');
    checkboxes.forEach(cb => {
        if (cb.value !== subject) cb.checked = false;
    });
    
    if (isChecked) {
        state.classData[classNum].timetable[r][c] = subject;
    } else {
        state.classData[classNum].timetable[r][c] = '';
    }
    
    // ì…€ ì—…ë°ì´íŠ¸
    const cell = document.getElementById(`cell-${classNum}-${r}-${c}`);
    if (cell) {
        const span = cell.querySelector('.selected-subject');
        if (span) span.textContent = subject || '-';
        
        // ìƒ‰ìƒ í´ë˜ìŠ¤ ì—…ë°ì´íŠ¸
        const oldCls = cell.className.match(/subject-\w+/g);
        if (oldCls) {
            oldCls.forEach(cls => cell.classList.remove(cls));
        }
        const newCls = getSubjectClass(subject);
        if (newCls) {
            cell.classList.add(newCls);
        }
    }
    
    saveAndRefresh(false);
    calculateUnifiedStatus(classNum);
    closeSubjectSelector();
}

function closeSubjectSelector() { 
    document.getElementById('globalSubjectSelector').style.display = 'none'; 
}

// í•™ê¸‰ ì‹œê°„í‘œ ë Œë”ë§
function renderClassGrid() {
    const grid = document.getElementById('classGrid');
    grid.innerHTML = '';

    for (let i = 1; i <= state.classCount; i++) {
        if (!state.classData[i]) {
            state.classData[i] = { timetable: Array(state.periodCount).fill().map(() => Array(5).fill("")), targetHours: Array(allSubjects.length).fill(0), memo: "" };
        }
        grid.appendChild(createClassCard(i));
    }
    
    renderUnifiedHoursTable();
    renderUnifiedMemo();
}

function createClassCard(num) {
    const data = state.classData[num];
    if (!data.memo) data.memo = '';
    const card = document.createElement('div');
    card.className = 'class-card';
    card.id = `card-${num}`;
    
    let html = `<h3>${num}ë°˜ <button class="btn btn-clear" onclick="clearClassTimetable(${num})">ì‚­ì œ</button> <button class="btn btn-auto" onclick="autoFill(${num})">ìë™ ì±„ìš°ê¸°</button> <span class="badge" id="badge-${num}">ì™„ë£Œ</span></h3>`;
    html += `<table><thead><tr><th>êµì‹œ</th>${days.map((d, idx) => {
        const disabledDays = state.disabledDays || {};
        const isDisabled = disabledDays[d] === true;
        const dayClass = isDisabled ? 'disabled-day-header' : 'day-header';
        return `<th class="${dayClass}" onclick="toggleDayColumn(${idx})" style="cursor: pointer; user-select: none;" title="í´ë¦­í•˜ì—¬ ${d}ìš”ì¼ ì—´ ë¹„í™œì„±í™”/í™œì„±í™”">${d}</th>`;
    }).join('')}</tr></thead><tbody>`;

    for (let r = 0; r < state.periodCount; r++) {
        html += `<tr><th>${r+1}</th>`;
        for (let c = 0; c < 5; c++) {
            const key = `${r}-${c}`;
            let fixedSub = null;
            state.subjectSheets.forEach(sheet => {
                if (sheet.rules[key] && sheet.rules[key].includes(num)) fixedSub = sheet.subName;
            });

            // ìš”ì¼ë³„ ë¹„í™œì„±í™” ë° ìˆ˜ì—… ìˆ˜ ì œí•œ í™•ì¸
            const dayName = days[c];
            const isDayDisabled = state.disabledDays && state.disabledDays[dayName] === true;
            const dayLimit = state.dayPeriodLimits && state.dayPeriodLimits[dayName];
            const isPeriodDisabled = dayLimit !== undefined && dayLimit !== null && (r + 1) > dayLimit;

            if (fixedSub) {
                const cls = getSubjectClass(fixedSub);
                const disabledClass = (isDayDisabled || isPeriodDisabled) ? ' disabled-cell' : '';
                html += `<td class="fixed-cell ${cls}${disabledClass}">${fixedSub}</td>`;
                data.timetable[r][c] = fixedSub;
            } else {
                const cellId = `cell-${num}-${r}-${c}`;
                const cellValue = data.timetable[r][c] || '';
                const cls = cellValue ? getSubjectClass(cellValue) : '';
                const disabledClass = (isDayDisabled || isPeriodDisabled) ? ' disabled-cell' : '';
                const disabledAttr = (isDayDisabled || isPeriodDisabled) ? ' style="opacity: 0.3; pointer-events: none; cursor: not-allowed;"' : '';
                html += `<td class="subject-cell draggable-cell ${cls}${disabledClass}" id="${cellId}" draggable="${!(isDayDisabled || isPeriodDisabled)}" 
                    ${disabledAttr}
                    onclick="${(isDayDisabled || isPeriodDisabled) ? '' : `showSubjectSelector(event, ${num}, ${r}, ${c})`}"
                    ondragstart="${(isDayDisabled || isPeriodDisabled) ? '' : `handleDragStart(event, ${num}, ${r}, ${c})`}"
                    ondragover="${(isDayDisabled || isPeriodDisabled) ? '' : 'handleDragOver(event)'}"
                    ondrop="${(isDayDisabled || isPeriodDisabled) ? '' : `handleDrop(event, ${num}, ${r}, ${c})`}"
                    ondragend="${(isDayDisabled || isPeriodDisabled) ? '' : 'handleDragEnd(event)'}">
                    <span class="selected-subject">${cellValue || '-'}</span>
                </td>`;
            }
        }
        html += `</tr>`;
    }
    html += `</tbody></table>`;
    
    card.innerHTML = html;
    setTimeout(() => {
        calculateUnifiedStatus(num);
    }, 0);
    return card;
}

function updateClassMemo(classNum, val) {
    if (!state.classData[classNum]) return;
    state.classData[classNum].memo = val;
    saveAndRefresh(false);
}

// í†µí•© ë©”ëª¨ì°½ ë Œë”ë§
function renderUnifiedMemo() {
    const container = document.getElementById('unifiedMemoContent');
    if (!container) return;
    
    container.innerHTML = `
        <textarea 
            placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." 
            onchange="updateMemo(this.value)"
            style="width: 600px; max-width: 100%; min-height: 40px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; font-family: inherit; resize: vertical;">${state.memo || ""}</textarea>
    `;
}

function updateMemo(val) {
    state.memo = val;
    saveAndRefresh(false);
}

// ë“œë˜ê·¸ ì•¤ ë“œë¡­ í•¨ìˆ˜ë“¤
let dragSource = null;

function handleDragStart(e, classNum, r, c) {
    const key = `${r}-${c}`;
    let fixedSub = null;
    state.subjectSheets.forEach(sheet => {
        if (sheet.rules[key] && sheet.rules[key].includes(classNum)) fixedSub = sheet.subName;
    });
    
    if (fixedSub) {
        e.preventDefault();
        return false;
    }
    
    dragSource = { classNum, r, c, value: state.classData[classNum].timetable[r][c] };
    e.dataTransfer.effectAllowed = 'move';
    e.currentTarget.classList.add('dragging');
}

function handleDragOver(e) {
    if (dragSource) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        e.currentTarget.classList.add('drag-over');
    }
}

function handleDrop(e, classNum, r, c) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');
    
    if (!dragSource) return;
    
    const source = dragSource;
    const targetKey = `${r}-${c}`;
    
    // ê³ ì •ëœ ì…€ì¸ì§€ í™•ì¸
    let targetFixed = false;
    state.subjectSheets.forEach(sheet => {
        if (sheet.rules[targetKey] && sheet.rules[targetKey].includes(classNum)) targetFixed = true;
    });
    
    if (targetFixed || source.classNum !== classNum) return;
    
    // ê°’ êµí™˜
    const sourceValue = state.classData[classNum].timetable[source.r][source.c];
    const targetValue = state.classData[classNum].timetable[r][c];
    
    state.classData[classNum].timetable[source.r][source.c] = targetValue;
    state.classData[classNum].timetable[r][c] = sourceValue;
    
    // ìƒ‰ìƒ í´ë˜ìŠ¤ ì—…ë°ì´íŠ¸
    const sourceCell = document.getElementById(`cell-${classNum}-${source.r}-${source.c}`);
    const targetCell = document.getElementById(`cell-${classNum}-${r}-${c}`);
    
    if (sourceCell) {
        const oldCls = sourceCell.className.match(/subject-\w+/g);
        if (oldCls) oldCls.forEach(cls => sourceCell.classList.remove(cls));
        const newCls = getSubjectClass(targetValue);
        if (newCls) sourceCell.classList.add(newCls);
        const span = sourceCell.querySelector('.selected-subject');
        if (span) span.textContent = targetValue || '-';
    }
    
    if (targetCell) {
        const oldCls = targetCell.className.match(/subject-\w+/g);
        if (oldCls) oldCls.forEach(cls => targetCell.classList.remove(cls));
        const newCls = getSubjectClass(sourceValue);
        if (newCls) targetCell.classList.add(newCls);
        const span = targetCell.querySelector('.selected-subject');
        if (span) span.textContent = sourceValue || '-';
    }
    
    saveAndRefresh();
}

function handleDragEnd(e) {
    e.currentTarget.classList.remove('dragging');
    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
    dragSource = null;
}

// ê³ ì • ì‹œê°„í‘œ ë“œë˜ê·¸ ì•¤ ë“œë¡­ í•¨ìˆ˜ë“¤
let masterDragSource = null;

function handleMasterDragStart(e, sIdx, r, c) {
    const key = `${r}-${c}`;
    const selected = state.subjectSheets[sIdx].rules[key] || [];
    
    masterDragSource = { sIdx, r, c, selected: [...selected] };
    e.dataTransfer.effectAllowed = 'move';
    e.currentTarget.classList.add('dragging');
}

function handleMasterDragOver(e) {
    if (masterDragSource) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        e.currentTarget.classList.add('drag-over');
    }
}

function handleMasterDrop(e, sIdx, r, c) {
    e.preventDefault();
    e.stopPropagation();
    e.currentTarget.classList.remove('drag-over');
    
    if (!masterDragSource) return;
    
    const source = masterDragSource;
    
    // ê°™ì€ ì‹œíŠ¸ ë‚´ì—ì„œë§Œ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê°€ëŠ¥
    if (source.sIdx !== sIdx) return;
    
    const sourceKey = `${source.r}-${source.c}`;
    const targetKey = `${r}-${c}`;
    
    // rules êµí™˜
    const sourceRules = state.subjectSheets[sIdx].rules[sourceKey] || [];
    const targetRules = state.subjectSheets[sIdx].rules[targetKey] || [];
    
    state.subjectSheets[sIdx].rules[sourceKey] = [...targetRules];
    state.subjectSheets[sIdx].rules[targetKey] = [...sourceRules];
    
    // ë¹ˆ ë°°ì—´ì´ë©´ í‚¤ ì‚­ì œ
    if (state.subjectSheets[sIdx].rules[sourceKey].length === 0) {
        delete state.subjectSheets[sIdx].rules[sourceKey];
    }
    if (state.subjectSheets[sIdx].rules[targetKey].length === 0) {
        delete state.subjectSheets[sIdx].rules[targetKey];
    }
    
    saveAndRefresh();
}

function handleMasterDragEnd(e) {
    e.currentTarget.classList.remove('dragging');
    document.querySelectorAll('.master-td.drag-over').forEach(el => el.classList.remove('drag-over'));
    masterDragSource = null;
}

function updateCell(classNum, r, c, val) {
    state.classData[classNum].timetable[r][c] = val;
    saveAndRefresh(false);
    calculateStatus(classNum);
}

function updateHour(classNum, idx, val) {
    // ëª©í‘œì‹œìˆ˜ëŠ” ëª¨ë“  ë°˜ì— ë™ì¼í•˜ê²Œ ì ìš© (1ë°˜ ê²ƒë§Œ ì‚¬ìš©)
    const targetValue = parseInt(val) || 0;
    for (let i = 1; i <= state.classCount; i++) {
        if (state.classData[i]) {
            state.classData[i].targetHours[idx] = targetValue;
        }
    }
    saveAndRefresh(false);
    // ëª©í‘œì‹œìˆ˜ í•©ê³„ ì—…ë°ì´íŠ¸
    updateTargetHoursSum();
    // ëª¨ë“  ë°˜ì˜ ë‹¬ì„±ë„ ì¬ê³„ì‚°
    for (let i = 1; i <= state.classCount; i++) {
        if (state.classData[i]) {
            calculateUnifiedStatus(i);
        }
    }
}

// ìë™ ì±„ìš°ê¸° ë¡œì§ (ì„ í˜¸êµì‹œ ê³ ë ¤)
function autoFill(num) {
    const data = state.classData[num];
    const needed = [];

    // 1. ê° ê³¼ëª©ë³„ë¡œ ë” ì±„ì›Œì•¼ í•  ê°œìˆ˜ ë¦¬ìŠ¤íŠ¸ì—… (1ë°˜ì˜ ëª©í‘œì‹œìˆ˜ ì‚¬ìš©)
    const targetHoursRef = state.classData[1] ? state.classData[1].targetHours : data.targetHours;
    allSubjects.forEach((sub, idx) => {
        let count = 0;
        for(let r=0; r<state.periodCount; r++) {
            for(let c=0; c<5; c++) {
                const key = `${r}-${c}`;
                let fixed = false;
                state.subjectSheets.forEach(sheet => { if(sheet.rules[key] && sheet.rules[key].includes(num)) fixed=true; });
                if(fixed) { 
                    let fixedName = "";
                    state.subjectSheets.forEach(sheet => { if(sheet.rules[key] && sheet.rules[key].includes(num)) fixedName = sheet.subName; });
                    if(fixedName === sub) count++;
                } else if(data.timetable[r][c] === sub) count++;
            }
        }
        let diff = targetHoursRef[idx] - count;
        for(let k=0; k<diff; k++) needed.push({sub, idx});
    });

    // 2. ë¹„ì–´ìˆëŠ”(í™œì„±í™”ëœ) ì¹¸ ì°¾ê¸° (ì„ í˜¸êµì‹œ ìš°ì„ ìˆœìœ„ ì ìš©)
    const emptySlots = [];
    for(let r=0; r<state.periodCount; r++) {
        for(let c=0; c<5; c++) {
            const key = `${r}-${c}`;
            let fixed = false;
            state.subjectSheets.forEach(sheet => { if(sheet.rules[key] && sheet.rules[key].includes(num)) fixed=true; });
            
            // ë¹„í™œì„±í™”ëœ ì…€ í™•ì¸
            const dayName = days[c];
            const isDayDisabled = state.disabledDays && state.disabledDays[dayName] === true;
            const dayLimit = state.dayPeriodLimits && state.dayPeriodLimits[dayName];
            const isPeriodDisabled = dayLimit !== undefined && dayLimit !== null && (r + 1) > dayLimit;
            const isDisabled = isDayDisabled || isPeriodDisabled;
            
            if(!fixed && !isDisabled && data.timetable[r][c] === "") {
                emptySlots.push({r, c, period: r+1});
            }
        }
    }

    // 3. ì„ í˜¸êµì‹œë¥¼ ê³ ë ¤í•œ ë°°ì¹˜
    // ì„ í˜¸êµì‹œê°€ ìˆëŠ” ê³¼ëª©ì„ ë¨¼ì € ë°°ì¹˜
    const preferred = [];
    const nonPreferred = [];
    
    needed.forEach(item => {
        const prefs = state.preferences[item.sub] || [];
        if (prefs.length > 0) {
            preferred.push(item);
        } else {
            nonPreferred.push(item);
        }
    });
    
    // ì„ í˜¸êµì‹œê°€ ìˆëŠ” ê³¼ëª© ë°°ì¹˜
    preferred.forEach(item => {
        const prefs = state.preferences[item.sub] || [];
        const availableSlots = emptySlots.filter(slot => prefs.includes(slot.period));
        if (availableSlots.length > 0) {
            const slot = availableSlots[Math.floor(Math.random() * availableSlots.length)];
            data.timetable[slot.r][slot.c] = item.sub;
            const idx = emptySlots.findIndex(s => s.r === slot.r && s.c === slot.c);
            if (idx >= 0) emptySlots.splice(idx, 1);
        }
    });
    
    // ë‚˜ë¨¸ì§€ ê³¼ëª© ëœë¤ ë°°ì¹˜ (1ë°˜ì˜ ëª©í‘œì‹œìˆ˜ ì‚¬ìš©)
    const remaining = [...preferred, ...nonPreferred].filter(item => {
        let count = 0;
        for(let r=0; r<state.periodCount; r++) {
            for(let c=0; c<5; c++) {
                const key = `${r}-${c}`;
                let fixedSub = null;
                state.subjectSheets.forEach(sheet => { 
                    if (sheet.rules[key] && sheet.rules[key].includes(num)) fixedSub = sheet.subName; 
                });
                const currentVal = fixedSub || data.timetable[r][c];
                if(currentVal === item.sub) count++;
            }
        }
        return count < targetHoursRef[item.idx];
    });
    
    // ë¹„í™œì„±í™”ëœ ì…€ ì œì™¸í•˜ê³  ë°°ì¹˜
    const availableSlotsForRemaining = emptySlots.filter(slot => {
        const dayName = days[slot.c];
        const isDayDisabled = state.disabledDays && state.disabledDays[dayName] === true;
        const dayLimit = state.dayPeriodLimits && state.dayPeriodLimits[dayName];
        const isPeriodDisabled = dayLimit !== undefined && dayLimit !== null && (slot.r + 1) > dayLimit;
        return !isDayDisabled && !isPeriodDisabled;
    });
    
    remaining.sort(() => Math.random() - 0.5);
    availableSlotsForRemaining.forEach((slot, i) => {
        if(remaining[i]) data.timetable[slot.r][slot.c] = remaining[i].sub;
    });

    saveAndRefresh();
}

function calculateStatus(classNum) {
    // í†µí•© í‘œì˜ ë‹¬ì„±ë„ ê³„ì‚° í•¨ìˆ˜ ì‚¬ìš©
    calculateUnifiedStatus(classNum);
}

function renderAll() { 
    renderMasterSheets(); 
    renderClassGrid(); 
    renderUnifiedHoursTable();
    updateWeekPeriodInfo();
}

// í†µí•© ì£¼ê°„ ì‹œìˆ˜ ë° ë‹¬ì„±ë„ í‘œ ë Œë”ë§
function renderUnifiedHoursTable() {
    const container = document.getElementById('unifiedHoursTable');
    if (!container) return;
    
    // 1ë°˜ ë°ì´í„° ì‚¬ìš© (ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ í•™ê¸‰)
    const firstClass = state.classData[1] || state.classData[Object.keys(state.classData)[0]];
    if (!firstClass) {
        container.innerHTML = '<p>í•™ê¸‰ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }
    
    let html = '<table><thead><tr><th>êµ¬ë¶„</th>';
    html += allSubjects.map(s => `<th>${s}</th>`).join('');
    html += '<th>í•©ê³„</th></tr></thead><tbody>';
    
    // í–‰1: ëª©í‘œì‹œìˆ˜ (1ë°˜ ê²ƒ ì‚¬ìš©)
    html += '<tr id="target-hours-row"><th>ëª©í‘œì‹œìˆ˜</th>';
    html += allSubjects.map((s, idx) => {
        return `<td><input type="number" value="${firstClass.targetHours[idx]}" style="width:100%" onchange="updateHour(1, ${idx}, this.value)"></td>`;
    }).join('');
    html += '<td id="target-hours-sum" style="font-weight:bold">0</td>';
    html += '</tr>';
    
    // ê° ë°˜ì˜ ë‹¬ì„±ë„ í–‰
    for (let i = 1; i <= state.classCount; i++) {
        if (!state.classData[i]) continue;
        const remainId = `unified-remain-${i}`;
        html += `<tr id="${remainId}" style="font-weight:bold"><th>${i}ë°˜</th>`;
        html += allSubjects.map(() => `<td>0</td>`).join('');
        html += `<td id="remain-sum-${i}" style="font-weight:bold">0</td>`;
        html += '</tr>';
    }
    
    html += '</tbody></table>';
    container.innerHTML = html;
    
    // ëª©í‘œì‹œìˆ˜ í•©ê³„ ê³„ì‚°
    updateTargetHoursSum();
    
    // ê° ë°˜ì˜ ë‹¬ì„±ë„ ê³„ì‚°
    for (let i = 1; i <= state.classCount; i++) {
        if (state.classData[i]) {
            calculateUnifiedStatus(i);
        }
    }
}

function calculateUnifiedStatus(classNum) {
    const data = state.classData[classNum];
    const remainRow = document.getElementById(`unified-remain-${classNum}`);
    if (!remainRow) return;
    
    const cells = remainRow.cells;
    let allDone = true;
    let sum = 0;

    allSubjects.forEach((sub, idx) => {
        let count = 0;
        for(let r=0; r<state.periodCount; r++) {
            for(let c=0; c<5; c++) {
                const key = `${r}-${c}`;
                let fixedSub = null;
                state.subjectSheets.forEach(sheet => { 
                    if (sheet.rules[key] && sheet.rules[key].includes(classNum)) fixedSub = sheet.subName; 
                });
                const currentVal = fixedSub || data.timetable[r][c];
                if(currentVal === sub) count++;
            }
        }
        const target = state.classData[1] ? state.classData[1].targetHours[idx] : data.targetHours[idx];
        const remain = target - count;
        sum += remain;
        if (cells[idx + 1]) {
            cells[idx + 1].innerText = remain;
            // ëª¨ë“  ê³¼ëª©ì— ë™ì¼í•˜ê²Œ ì ìš©: ëª©í‘œì‹œìˆ˜ê°€ 0ë³´ë‹¤ í¬ê³  ë‹¬ì„±ë„ê°€ 0ì´ë©´ ìƒ‰ ë³€ê²½
            if(target > 0 && remain === 0) {
                cells[idx + 1].className = 'target-zero';
            } else { 
                cells[idx + 1].className = ''; 
                if(remain !== 0) allDone = false; 
            }
        }
    });
    
    // í•©ê³„ ì—…ë°ì´íŠ¸
    const sumCell = document.getElementById(`remain-sum-${classNum}`);
    if (sumCell) {
        sumCell.innerText = sum;
    }
    
    // ì¹´ë“œì˜ ì™„ë£Œ ìƒíƒœë„ ì—…ë°ì´íŠ¸
    const card = document.getElementById(`card-${classNum}`);
    const badge = document.getElementById(`badge-${classNum}`);
    if (card && badge) {
        badge.style.display = allDone ? 'inline' : 'none';
        card.classList.toggle('completed', allDone);
    }
}

// ëª©í‘œì‹œìˆ˜ í•©ê³„ ê³„ì‚°
function updateTargetHoursSum() {
    const firstClass = state.classData[1];
    if (!firstClass) return;
    
    const sum = firstClass.targetHours.reduce((a, b) => a + b, 0);
    const sumCell = document.getElementById('target-hours-sum');
    if (sumCell) {
        sumCell.innerText = sum;
    }
}

// ì—°ê°„ì‹œìˆ˜í‘œ ë°ì´í„° ì„ íƒ í•¨ìˆ˜
function loadAnnualData() {
    const semester = '2'; // 2í•™ê¸° ê³ ì •
    const loginInfoStr = localStorage.getItem('timetable_login');
    
    if (!loginInfoStr) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        window.location.href = 'login.html';
        return;
    }
    
    let loginInfo;
    try {
        loginInfo = JSON.parse(loginInfoStr);
    } catch (e) {
        alert('ë¡œê·¸ì¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        window.location.href = 'login.html';
        return;
    }
    
    const nickname = loginInfo.nickname;
    if (!nickname) {
        alert('ë¡œê·¸ì¸ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        window.location.href = 'login.html';
        return;
    }
    
    fetch(`${window.location.origin}/api/annual-data?nickname=${encodeURIComponent(nickname)}&semester=${semester}`)
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => {
                    throw new Error(err.message || `HTTP ${response.status}`);
                });
            }
            return response.json();
        })
        .then(result => {
            if (!result.success) {
                throw new Error(result.message || 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
            
            const data = result.data || [];
            state.annualTableData = data;
            
            // ì£¼ ì„ íƒ ì»¨í…Œì´ë„ˆ í‘œì‹œ
            const weekContainer = document.getElementById('weekSelectorContainer');
            
            if (data && data.length > 0) {
                // ì²« ë²ˆì§¸ ì£¼ë¡œ ì´ˆê¸°í™”
                currentWeekIndex = 0;
                
                // ì²« ë²ˆì§¸ ì£¼ì˜ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
                loadWeekDataFromStorage(currentWeekIndex);
                
                // í™”ë©´ ì—…ë°ì´íŠ¸
                updateAnnualWeekDisplay();
                renderAll();
                
                // ëª©í‘œì‹œìˆ˜ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
                loadWeekData();
                
                weekContainer.style.display = 'flex';
                alert(`${semester}í•™ê¸° ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } else {
                weekContainer.innerHTML = '<span style="color: #dc3545; font-weight: bold;">ì—°ê°„ì‹œìˆ˜í‘œë¥¼ ë¨¼ì € ì…ë ¥ í•´ì£¼ì„¸ìš”.</span>';
                weekContainer.style.display = 'flex';
            }
        })
        .catch(error => {
            alert(`ì˜¤ë¥˜: ${error.message}\n\nì„œë²„ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.`);
            console.error('ì—°ê°„ì‹œìˆ˜í‘œ ë¡œë“œ ì˜¤ë¥˜:', error);
        });
}

// í˜„ì¬ ì„ íƒëœ ì£¼ ì¸ë±ìŠ¤
let currentWeekIndex = -1;

// ì£¼ ë³€ê²½ í•¨ìˆ˜ (í™”ì‚´í‘œ ë²„íŠ¼ìš©)
function changeWeek(direction) {
    if (!state.annualTableData || state.annualTableData.length === 0) return;
    
    const newIndex = currentWeekIndex + direction;
    
    // ë²”ìœ„ ì²´í¬
    if (newIndex < 0 || newIndex >= state.annualTableData.length) return;
    
    // í˜„ì¬ ì£¼ì˜ ë°ì´í„° ì €ì¥
    if (currentWeekIndex >= 0) {
        saveCurrentWeekData();
    }
    
    // ìƒˆ ì£¼ë¡œ ë³€ê²½
    currentWeekIndex = newIndex;
    
    // ìƒˆ ì£¼ì˜ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    loadWeekDataFromStorage(currentWeekIndex);
    
    // í™”ë©´ ì—…ë°ì´íŠ¸
    updateAnnualWeekDisplay();
    renderAll();
    
    // ëª©í‘œì‹œìˆ˜ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    loadWeekData();
}

// ì—°ê°„ì‹œìˆ˜í‘œ ì£¼ í‘œì‹œ ì—…ë°ì´íŠ¸
function updateAnnualWeekDisplay() {
    const annualWeekDisplay = document.getElementById('annualWeekDisplay');
    if (!annualWeekDisplay) return;
    
    if (!state.annualTableData || state.annualTableData.length === 0) {
        console.log('[ë©”ì¸í˜ì´ì§€] updateAnnualWeekDisplay - ì—°ê°„ì‹œìˆ˜í‘œ ë°ì´í„° ì—†ìŒ');
        annualWeekDisplay.textContent = '';
        return;
    }
    
    if (currentWeekIndex < 0 || currentWeekIndex >= state.annualTableData.length) {
        console.log(`[ë©”ì¸í˜ì´ì§€] updateAnnualWeekDisplay - ìœ íš¨í•˜ì§€ ì•Šì€ ì£¼ ì¸ë±ìŠ¤: ${currentWeekIndex}`);
        annualWeekDisplay.textContent = '';
        return;
    }
    
    // "1ì£¼", "2ì£¼" í˜•ì‹ìœ¼ë¡œ í‘œì‹œ
    annualWeekDisplay.textContent = `${currentWeekIndex + 1}ì£¼`;
    console.log(`[ë©”ì¸í˜ì´ì§€] ì£¼ í‘œì‹œ ì—…ë°ì´íŠ¸: ${currentWeekIndex + 1}ì£¼`);
}

// ì£¼ ì„ íƒ ì‹œ í•´ë‹¹ ì£¼ì˜ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
function loadWeekData() {
    if (currentWeekIndex < 0 || !state.annualTableData) return;
    
    const weekData = state.annualTableData[currentWeekIndex];
    if (!weekData) return;
    
    // ê¸°ê°„ í‘œì‹œ
    const periodDisplay = document.getElementById('periodDisplay');
    if (weekData['ê¸°ê°„']) {
        periodDisplay.textContent = `ê¸°ê°„: ${weekData['ê¸°ê°„']}`;
    }
    
    // ì£¼ì™€ ê¸°ê°„ ì •ë³´ ì—…ë°ì´íŠ¸
    updateWeekPeriodInfo();
    
    // ê³¼ëª©ë³„ ëª©í‘œì‹œìˆ˜ ë§¤í•‘ (JSON í•„ë“œ -> allSubjects ì¸ë±ìŠ¤)
    const subjectMapping = {
        'êµ­ì–´': 0,
        'ì‚¬íšŒ': 1,
        'ë„ë•': 2,
        'ìˆ˜í•™': 3,
        'ê³¼í•™': 4,
        'ì‹¤ê³¼': 5,
        'ì²´ìœ¡': 6,
        'ìŒì•…': 7,
        'ë¯¸ìˆ ': 8,
        'ì˜ì–´': 9,
        'ììœ¨': 10,  // ì°½ì²´(ì)
        'ë™ì•„ë¦¬': 11,  // ì°½ì²´(ë™)
        'ë´‰ì‚¬': 12,   // ì°½ì²´(ë´‰)
        'ì§„ë¡œ': 13    // ì°½ì²´(ì§„)
    };
    
    // ëª©í‘œì‹œìˆ˜ ì—…ë°ì´íŠ¸
    Object.keys(subjectMapping).forEach(subjectKey => {
        const idx = subjectMapping[subjectKey];
        const value = parseInt(weekData[subjectKey]) || 0;
        
        // ëª¨ë“  ë°˜ì˜ ëª©í‘œì‹œìˆ˜ ì—…ë°ì´íŠ¸
        for (let i = 1; i <= state.classCount; i++) {
            if (state.classData[i]) {
                state.classData[i].targetHours[idx] = value;
            }
        }
    });
    
    // í†µí•© í‘œ ë‹¤ì‹œ ë Œë”ë§í•˜ì—¬ ëª©í‘œì‹œìˆ˜ ë°˜ì˜
    renderUnifiedHoursTable();
    
    // localStorageì— ì €ì¥
    saveAndRefresh(false);
}

// í•™ê¸‰ ì‹œê°„í‘œ ì‚­ì œ í•¨ìˆ˜
function clearClassTimetable(classNum) {
    if (!confirm(`${classNum}ë°˜ì˜ ì‹œê°„í‘œë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê³ ì •ëœ êµê³¼ëŠ” ì‚­ì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`)) {
        return;
    }
    
    const data = state.classData[classNum];
    if (!data) return;
    
    // ê³ ì •ëœ êµê³¼ë¥¼ ì œì™¸í•˜ê³  ëª¨ë“  ì…€ ë¹„ìš°ê¸°
    for (let r = 0; r < state.periodCount; r++) {
        for (let c = 0; c < 5; c++) {
            const key = `${r}-${c}`;
            let isFixed = false;
            state.subjectSheets.forEach(sheet => {
                if (sheet.rules[key] && sheet.rules[key].includes(classNum)) {
                    isFixed = true;
                }
            });
            
            if (!isFixed) {
                data.timetable[r][c] = '';
            }
        }
    }
    
    saveAndRefresh();
    
    // í†µí•© í‘œì˜ ë‹¬ì„±ë„ ì¬ê³„ì‚°
    calculateUnifiedStatus(classNum);
    
    // ì¹´ë“œ ë‹¤ì‹œ ë Œë”ë§
    const card = document.getElementById(`card-${classNum}`);
    if (card) {
        const grid = document.getElementById('classGrid');
        const newCard = createClassCard(classNum);
        grid.replaceChild(newCard, card);
    }
}
// ë³µì‚¬ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
function showGlobalCopyDialog(sheetIdx) {
    if (!state.annualTableData || state.annualTableData.length === 0) {
        alert('ì—°ê°„ì‹œìˆ˜í‘œ ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    const maxWeek = state.annualTableData.length;
    const targetWeek = prompt(`ë³µì‚¬í•  ì£¼ë¥¼ ì…ë ¥í•˜ì„¸ìš” (1~${maxWeek}):`, String(currentWeekIndex + 1));
    if (!targetWeek) return;
    
    const targetWeekIdx = parseInt(targetWeek) - 1; // ì¸ë±ìŠ¤ë¡œ ë³€í™˜
    
    if (isNaN(targetWeekIdx) || targetWeekIdx < 0 || targetWeekIdx >= maxWeek) {
        alert('ì˜¬ë°”ë¥¸ ì£¼ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    if (targetWeekIdx === currentWeekIndex) {
        alert('í˜„ì¬ ì£¼ì™€ ë™ì¼í•©ë‹ˆë‹¤. ë‹¤ë¥¸ ì£¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    if (confirm(`í˜„ì¬ ì£¼ì˜ ê³ ì • ì‹œê°„í‘œë¥¼ ${targetWeek}ì£¼ë¡œ ë³µì‚¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        copySheetToWeek(sheetIdx, targetWeekIdx);
    }
}

// ê³ ì • ì‹œê°„í‘œë¥¼ íŠ¹ì • ì£¼ì— ë³µì‚¬
function copySheetToWeek(sheetIdx, targetWeekIdx) {
    const sheet = state.subjectSheets[sheetIdx];
    if (!sheet) return;
    
    // í˜„ì¬ ì£¼ì˜ ë°ì´í„°ë¥¼ ì£¼ë³„ ë°ì´í„°ì— ì €ì¥
    if (currentWeekIndex >= 0) {
        saveCurrentWeekData();
    }
    
    // ëŒ€ìƒ ì£¼ì— ë³µì‚¬
    if (!state.weeklyData2) state.weeklyData2 = {};
    if (!state.weeklyData2[targetWeekIdx]) {
        state.weeklyData2[targetWeekIdx] = {
            subjectSheets: [],
            classData: {}
        };
    }
    
    // í•´ë‹¹ ì£¼ì˜ subjectSheets ë°°ì—´ì—ì„œ ê°™ì€ ê³¼ëª©ê³¼ íƒœê·¸ ì°¾ê¸°
    const weekSheets = state.weeklyData2[targetWeekIdx].subjectSheets;
    const sheetTag = sheet.tag || '';
    const existingIdx = weekSheets.findIndex(s => s.subName === sheet.subName && (s.tag || '') === sheetTag);
    
    // ë³µì‚¬í•  ë°ì´í„° ì¤€ë¹„
    const copiedSheet = {
        subName: sheet.subName,
        tag: sheet.tag || '',
        memo: sheet.memo,
        rules: JSON.parse(JSON.stringify(sheet.rules))
    };
    
    if (existingIdx >= 0) {
        // ê¸°ì¡´ ì‹œíŠ¸ êµì²´ (ê³¼ëª©ëª…ê³¼ íƒœê·¸ê°€ ëª¨ë‘ ê°™ì€ ê²½ìš°)
        weekSheets[existingIdx] = copiedSheet;
    } else {
        // ìƒˆ ì‹œíŠ¸ ì¶”ê°€ (ê³¼ëª©ëª…ì´ ë‹¤ë¥´ê±°ë‚˜ íƒœê·¸ê°€ ë‹¤ë¥¸ ê²½ìš°)
        weekSheets.push(copiedSheet);
    }
    
    // ì„œë²„ì— ì €ì¥
    saveDataToServer();
    
    alert(`${targetWeekIdx + 1}ì£¼ë¡œ ë³µì‚¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
}

// ëª¨ë“  ê³ ì •ì‹œê°„í‘œ ë³µì‚¬ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
function copyAllFixedTimetables() {
    if (!state.annualTableData || state.annualTableData.length === 0) {
        alert('ì—°ê°„ì‹œìˆ˜í‘œ ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    if (state.subjectSheets.length === 0) {
        alert('ë³µì‚¬í•  ê³ ì •ì‹œê°„í‘œê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    const maxWeek = state.annualTableData.length;
    const startWeek = prompt(`ë³µì‚¬í•  ì‹œì‘ ì£¼ë¥¼ ì…ë ¥í•˜ì„¸ìš” (1~${maxWeek}):`, '1');
    if (!startWeek) return;
    
    const endWeek = prompt(`ë³µì‚¬í•  ë ì£¼ë¥¼ ì…ë ¥í•˜ì„¸ìš” (${startWeek}~${maxWeek}):`, String(maxWeek));
    if (!endWeek) return;
    
    const start = parseInt(startWeek) - 1; // ì¸ë±ìŠ¤ë¡œ ë³€í™˜
    const end = parseInt(endWeek) - 1;
    
    if (isNaN(start) || isNaN(end) || start < 0 || end >= maxWeek || start > end) {
        alert('ì˜¬ë°”ë¥¸ ì£¼ ë²”ìœ„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    if (confirm(`í˜„ì¬ ì£¼ì˜ ëª¨ë“  ê³ ì •ì‹œê°„í‘œë¥¼ ${startWeek}ì£¼ë¶€í„° ${endWeek}ì£¼ê¹Œì§€ ë³µì‚¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        copyAllSheetsToWeeks(start, end);
    }
}

// ëª¨ë“  ê³ ì •ì‹œê°„í‘œë¥¼ ì—¬ëŸ¬ ì£¼ì— ë³µì‚¬
function copyAllSheetsToWeeks(startWeekIdx, endWeekIdx) {
    // í˜„ì¬ ì£¼ì˜ ë°ì´í„°ë¥¼ ì£¼ë³„ ë°ì´í„°ì— ì €ì¥
    if (currentWeekIndex >= 0) {
        saveCurrentWeekData();
    }
    
    // ê° ì£¼ì— ëª¨ë“  ì‹œíŠ¸ ë³µì‚¬
    for (let weekIdx = startWeekIdx; weekIdx <= endWeekIdx; weekIdx++) {
        if (!state.weeklyData2) state.weeklyData2 = {};
        if (!state.weeklyData2[weekIdx]) {
            state.weeklyData2[weekIdx] = {
                subjectSheets: [],
                classData: {}
            };
        }
        
        const weekSheets = state.weeklyData2[weekIdx].subjectSheets;
        
        // ëª¨ë“  ì‹œíŠ¸ ë³µì‚¬
        state.subjectSheets.forEach(sheet => {
            const sheetTag = sheet.tag || '';
            const existingIdx = weekSheets.findIndex(s => s.subName === sheet.subName && (s.tag || '') === sheetTag);
            
            // ë³µì‚¬í•  ë°ì´í„° ì¤€ë¹„
            const copiedSheet = {
                subName: sheet.subName,
                tag: sheet.tag || '',
                memo: sheet.memo,
                rules: JSON.parse(JSON.stringify(sheet.rules))
            };
            
            if (existingIdx >= 0) {
                // ê¸°ì¡´ ì‹œíŠ¸ êµì²´ (ê³¼ëª©ëª…ê³¼ íƒœê·¸ê°€ ëª¨ë‘ ê°™ì€ ê²½ìš°)
                weekSheets[existingIdx] = copiedSheet;
            } else {
                // ìƒˆ ì‹œíŠ¸ ì¶”ê°€ (ê³¼ëª©ëª…ì´ ë‹¤ë¥´ê±°ë‚˜ íƒœê·¸ê°€ ë‹¤ë¥¸ ê²½ìš°)
                weekSheets.push(copiedSheet);
            }
        });
    }
    
    // ì„œë²„ì— ì €ì¥
    saveDataToServer();
    
    alert(`${startWeekIdx + 1}ì£¼ë¶€í„° ${endWeekIdx + 1}ì£¼ê¹Œì§€ ëª¨ë“  ê³ ì •ì‹œê°„í‘œ ë³µì‚¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
}

// ìš”ì¼ ì—´ ë¹„í™œì„±í™”/í™œì„±í™” í† ê¸€ í•¨ìˆ˜
function toggleDayColumn(dayIndex) {
    const dayName = days[dayIndex];
    if (!state.disabledDays) state.disabledDays = {};
    
    // í† ê¸€
    state.disabledDays[dayName] = !state.disabledDays[dayName];
    
    // ë¹„í™œì„±í™”ëœ ìš”ì¼ì˜ ëª¨ë“  ì…€ ë‚´ìš© ì‚­ì œ
    if (state.disabledDays[dayName]) {
        for (let classNum = 1; classNum <= state.classCount; classNum++) {
            if (state.classData[classNum] && state.classData[classNum].timetable) {
                for (let r = 0; r < state.periodCount; r++) {
                    // ê³ ì •ëœ ì…€ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì‚­ì œ
                    const key = `${r}-${dayIndex}`;
                    let isFixed = false;
                    state.subjectSheets.forEach(sheet => {
                        if (sheet.rules[key] && sheet.rules[key].includes(classNum)) {
                            isFixed = true;
                        }
                    });
                    
                    if (!isFixed) {
                        state.classData[classNum].timetable[r][dayIndex] = '';
                    }
                }
            }
        }
    }
    
    saveAndRefresh();
}

document.addEventListener('click', function(e) {
    if (!e.target.closest('.class-selector') && !e.target.closest('.master-td')) {
        closeSelector();
    }
    if (!e.target.closest('.subject-selector') && !e.target.closest('.subject-cell')) {
        closeSubjectSelector();
    }
});

// ì „ë‹´ ê³ ì •í‘œ ë“œë˜ê·¸ ì¤‘ í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€
document.addEventListener('dragstart', function(e) {
    if (e.target.closest('.master-td')) {
        // ë“œë˜ê·¸ ì¤‘ì—ëŠ” í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€
        const masterTd = e.target.closest('.master-td');
        if (masterTd) {
            masterTd.style.pointerEvents = 'none';
        }
    }
});

document.addEventListener('dragend', function(e) {
    if (e.target.closest('.master-td')) {
        const masterTd = e.target.closest('.master-td');
        if (masterTd) {
            masterTd.style.pointerEvents = '';
        }
    }
});
init();
</script>

</body>
</html>