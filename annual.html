<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì—°ê°„ì‹œìˆ˜í‘œ - ì‹œê°„í‘œ ì‹œìŠ¤í…œ</title>
    <style>
        :root { --accent: #4a90e2; }
        body { font-family: 'Malgun Gothic', sans-serif; padding: 20px; background: #f0f2f5; color: #333; line-height: 1.5; }
        .section { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 30px; width: fit-content; margin-left: auto; margin-right: auto; }
        .btn { padding: 8px 16px; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin: 5px; }
        .btn:hover { opacity: 0.8; }
        .btn-success { background: #28a745; }
        .nav-buttons { text-align: right; margin-bottom: 20px; }
        .info-box { background: #e7f3ff; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid var(--accent); }
        table { width: auto; border-collapse: collapse; margin: 15px 0; }
        th, td { border: 1px solid #ced4da; padding: 5px 8px; text-align: center; font-size: 12px; }
        th { background: #eee; font-weight: bold; }
        input { border: 1px solid #ddd; border-radius: 4px; padding: 3px; font-family: inherit; font-size: 11px; width: 60px; text-align: center; }
        select { border: 1px solid #ddd; border-radius: 4px; padding: 5px; font-family: inherit; font-size: 14px; margin: 5px; }
        .subject-row { background: #f8f9fa; }
        #annualHoursTable { width: fit-content; }
        .file-controls { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
        .btn-delete { background: #dc3545; font-size: 11px; padding: 3px 8px; }
        .btn-delete:hover { opacity: 0.8; }
        .total-row { background: #fff3cd; font-weight: bold; }
        .semester-buttons { display: flex; gap: 10px; align-items: center; }
        .btn-semester { padding: 8px 20px; background: #e9ecef; color: #495057; border: 2px solid #ced4da; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: normal; }
        .btn-semester:hover { background: #dee2e6; }
        .btn-semester.active { background: var(--accent); color: white; border-color: var(--accent); font-weight: bold; }
    </style>
</head>
<body>

<div class="nav-buttons">
    <button class="btn" onclick="history.back()">ì´ì „ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</button>
</div>

<div class="section">
    <h2>ğŸ“‹ ì—°ê°„ì‹œìˆ˜í‘œ</h2>
    
    <div class="info-box">
        <p>ì´ì§€ ì—ë“€ì˜ ì‹œìˆ˜í‘œë¥¼ ë³µì‚¬í•´ ë„£ì€ CSV íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ë©´ ì—°ê°„ì‹œìˆ˜í‘œê°€ ìë™ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤. ì˜ˆì‹œíŒŒì¼ì„ ë‹¤ìš´ë°›ì•„ ì‚¬ìš©í•˜ì„¸ìš”. ë˜ëŠ” ì§ì ‘ ì…ë ¥í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ê³„ì˜ ê°’ì€ ìƒˆë¡œê³ ì¹¨í•´ì•¼ ì ìš©ë©ë‹ˆë‹¤.</p>
        <div class="file-controls" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <button class="btn" onclick="downloadExampleFile()" style="background: #17a2b8;">ì˜ˆì‹œíŒŒì¼</button>
                <button class="btn" onclick="document.getElementById('csvFile').click()" style="background: var(--accent);">íŒŒì¼ì„ íƒ</button>
                <input type="file" id="csvFile" accept=".csv" style="display: none;">
                <div class="semester-buttons">
                    <button id="semester1Btn" class="btn-semester active" onclick="switchSemester('1')">1í•™ê¸°</button>
                    <button id="semester2Btn" class="btn-semester" onclick="switchSemester('2')">2í•™ê¸°</button>
                </div>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button class="btn" onclick="addRow()">í–‰ ì¶”ê°€</button>
                <button class="btn btn-success" onclick="saveAnnualHours()">ì €ì¥</button>
            </div>
        </div>
    </div>
    
    <table id="annualHoursTable">
        <thead>
            <tr id="annualHeaderRow">
                <th>ì£¼</th>
                <th>ê¸°ê°„</th>
                <th>ìˆ˜ì—…ì¼ìˆ˜</th>
                <th>êµ­ì–´</th>
                <th>ì‚¬íšŒ</th>
                <th>ë„ë•</th>
                <th>ìˆ˜í•™</th>
                <th>ê³¼í•™</th>
                <th>ì‹¤ê³¼</th>
                <th>ì²´ìœ¡</th>
                <th>ìŒì•…</th>
                <th>ë¯¸ìˆ </th>
                <th>ì˜ì–´</th>
                <th>ììœ¨</th>
                <th>ë™ì•„ë¦¬</th>
                <th>ë´‰ì‚¬</th>
                <th>ì§„ë¡œ</th>
                <th>ê³„</th>
                <th>ì‚­ì œ</th>
            </tr>
        </thead>
        <tbody id="annualHoursBody">
        </tbody>
    </table>
</div>


<script src="csv.js"></script>
<script>
// ì˜ˆì‹œíŒŒì¼ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
function downloadExampleFile() {
    const link = document.createElement('a');
    link.href = '1st.csv';
    link.download = '1st.csv';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// ê³¼ëª© ë§¤í•‘: CSV ì»¬ëŸ¼ëª… -> ì €ì¥ìš© í‚¤
const subjectMapping = {
    'êµ­ì–´': 'êµ­ì–´',
    'ì‚¬íšŒ': 'ì‚¬íšŒ',
    'ë„ë•': 'ë„ë•',
    'ìˆ˜í•™': 'ìˆ˜í•™',
    'ê³¼í•™': 'ê³¼í•™',
    'ì‹¤ê³¼': 'ì‹¤ê³¼',
    'ì²´ìœ¡': 'ì²´ìœ¡',
    'ìŒì•…': 'ìŒì•…',
    'ë¯¸ìˆ ': 'ë¯¸ìˆ ',
    'ì˜ì–´': 'ì˜ì–´',
    'ììœ¨': 'ì°½ì²´(ì)',
    'ë™ì•„ë¦¬': 'ì°½ì²´(ë™)',
    'ë´‰ì‚¬': 'ì°½ì²´(ë´‰)',
    'ì§„ë¡œ': 'ì°½ì²´(ì§„)'
};

const headerColumns = ['ì£¼', 'ê¸°ê°„', 'ìˆ˜ì—…ì¼ìˆ˜', 'êµ­ì–´', 'ì‚¬íšŒ', 'ë„ë•', 'ìˆ˜í•™', 'ê³¼í•™', 'ì‹¤ê³¼', 'ì²´ìœ¡', 'ìŒì•…', 'ë¯¸ìˆ ', 'ì˜ì–´', 'ììœ¨', 'ë™ì•„ë¦¬', 'ë´‰ì‚¬', 'ì§„ë¡œ', 'ê³„'];

// localStorageì—ì„œ ë§ˆì§€ë§‰ ì„ íƒ í•™ê¸° ë¶ˆëŸ¬ì˜¤ê¸°, ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ '1'
let currentSemester = localStorage.getItem('annual_semester') || '1';

function init() {
    // ë¡œê·¸ì¸ ì²´í¬
    const loginInfo = localStorage.getItem('timetable_login');
    if (!loginInfo) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        window.location.href = 'login.html';
        return;
    }
    
    // ì´ˆê¸° ë²„íŠ¼ ìƒíƒœ ì„¤ì •
    const btn1 = document.getElementById('semester1Btn');
    const btn2 = document.getElementById('semester2Btn');
    if (currentSemester === '1') {
        btn1.classList.add('active');
        btn2.classList.remove('active');
    } else {
        btn1.classList.remove('active');
        btn2.classList.add('active');
    }
    
    setupCSVLoader();
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ì–´ DOMì´ ì™„ì „íˆ ë¡œë“œëœ í›„ ì‹¤í–‰)
    setTimeout(() => {
        loadAnnualDataFromServer();
    }, 200);
}

// ì„œë²„ì—ì„œ ì—°ê°„ì‹œìˆ˜í‘œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
function loadAnnualDataFromServer() {
    const loginInfoStr = localStorage.getItem('timetable_login');
    if (!loginInfoStr) {
        renderAnnualTable([]);
        return;
    }
    
    let loginInfo;
    try {
        loginInfo = JSON.parse(loginInfoStr);
    } catch (e) {
        console.error('[ì—°ê°„ì‹œìˆ˜í‘œ] ë¡œê·¸ì¸ ì •ë³´ íŒŒì‹± ì˜¤ë¥˜:', e);
        renderAnnualTable([]);
        return;
    }
    
    const nickname = loginInfo.nickname;
    if (!nickname) {
        renderAnnualTable([]);
        return;
    }
    
    // ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
    fetch(`${window.location.origin}/api/annual-data?nickname=${encodeURIComponent(nickname)}&semester=${currentSemester}`)
        .then(response => response.json())
        .then(result => {
            if (result.success && result.data && result.data.length > 0) {
                renderAnnualTable(result.data);
            } else {
                // ì„œë²„ì— ë°ì´í„°ê°€ ì—†ìœ¼ë©´ localStorageì—ì„œ ì‹œë„ (ë§ˆì´ê·¸ë ˆì´ì…˜ ì§€ì›)
                const storageKey = `annual_data_${nickname}_semester${currentSemester}`;
                const storedData = localStorage.getItem(storageKey);
                
                if (storedData) {
                    try {
                        const dataArray = JSON.parse(storedData);
                        renderAnnualTable(dataArray);
                        // localStorageì—ì„œ ë¶ˆëŸ¬ì˜¨ ë°ì´í„°ë¥¼ ì„œë²„ì— ì €ì¥
                        saveAnnualHoursToServer(dataArray);
                    } catch (e) {
                        console.error('[ì—°ê°„ì‹œìˆ˜í‘œ] localStorage ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', e);
                        renderAnnualTable([]);
                    }
                } else {
                    renderAnnualTable([]);
                }
            }
        })
        .catch(error => {
            console.error('[ì—°ê°„ì‹œìˆ˜í‘œ] ì„œë²„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
            // ì˜¤ë¥˜ ì‹œ localStorageì—ì„œ ì‹œë„
            const storageKey = `annual_data_${nickname}_semester${currentSemester}`;
            const storedData = localStorage.getItem(storageKey);
            
            if (storedData) {
                try {
                    const dataArray = JSON.parse(storedData);
                    renderAnnualTable(dataArray);
                } catch (e) {
                    console.error('[ì—°ê°„ì‹œìˆ˜í‘œ] localStorage ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', e);
                    renderAnnualTable([]);
                }
            } else {
                renderAnnualTable([]);
            }
        });
}

function switchSemester(semester) {
    currentSemester = semester;
    
    // localStorageì— ì„ íƒí•œ í•™ê¸° ì €ì¥
    localStorage.setItem('annual_semester', semester);
    
    // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
    const btn1 = document.getElementById('semester1Btn');
    const btn2 = document.getElementById('semester2Btn');
    
    if (semester === '1') {
        btn1.classList.add('active');
        btn2.classList.remove('active');
    } else {
        btn1.classList.remove('active');
        btn2.classList.add('active');
    }
    
    loadAnnualDataFromServer();
}

function renderAnnualTable(annualData = []) {
    const tbody = document.getElementById('annualHoursBody');
    tbody.innerHTML = '';
    
    if (annualData.length === 0) {
        // ë¹ˆ í–‰ í•˜ë‚˜ ì¶”ê°€
        const row = createDataRow({}, 0);
        tbody.appendChild(row);
    } else {
        annualData.forEach((rowData, idx) => {
            const row = createDataRow(rowData, idx);
            tbody.appendChild(row);
        });
    }
    
    // í•©ê³„ í–‰ ì¶”ê°€ (ë§ˆì§€ë§‰ í–‰)
    addTotalRow();
}

function addTotalRow() {
    const tbody = document.getElementById('annualHoursBody');
    const rows = tbody.querySelectorAll('.data-row');
    
    // ê¸°ì¡´ í•©ê³„ í–‰ ì œê±°
    const existingTotalRow = tbody.querySelector('.total-row');
    if (existingTotalRow) {
        existingTotalRow.remove();
    }
    
    if (rows.length === 0) return;
    
    const totalRow = document.createElement('tr');
    totalRow.className = 'total-row';
    
    // ì£¼, ê¸°ê°„, ìˆ˜ì—…ì¼ìˆ˜ëŠ” ë¹ˆ ê°’
    totalRow.innerHTML += '<td></td>'; // ì£¼
    totalRow.innerHTML += '<td>í•©ê³„</td>'; // ê¸°ê°„
    totalRow.innerHTML += '<td></td>'; // ìˆ˜ì—…ì¼ìˆ˜
    
    // 4ë²ˆì§¸ ì—´ë¶€í„° ë ì—´ê¹Œì§€ í•©ê³„ ê³„ì‚° (ë§ˆì§€ë§‰ í–‰ ì œì™¸)
    const subjects = ['êµ­ì–´', 'ì‚¬íšŒ', 'ë„ë•', 'ìˆ˜í•™', 'ê³¼í•™', 'ì‹¤ê³¼', 'ì²´ìœ¡', 'ìŒì•…', 'ë¯¸ìˆ ', 'ì˜ì–´', 'ììœ¨', 'ë™ì•„ë¦¬', 'ë´‰ì‚¬', 'ì§„ë¡œ'];
    const totals = {};
    
    subjects.forEach(subject => {
        let sum = 0;
        rows.forEach(row => {
            const input = row.querySelector(`input[data-subject="${subject}"]`);
            if (input) {
                sum += parseInt(input.value) || 0;
            }
        });
        totals[subject] = sum;
        totalRow.innerHTML += `<td style="font-weight:bold">${sum}</td>`;
    });
    
    // ê³„ ì—´ í•©ê³„
    const totalSum = subjects.reduce((sum, sub) => sum + (totals[sub] || 0), 0);
    totalRow.innerHTML += `<td style="font-weight:bold">${totalSum}</td>`;
    
    // ì‚­ì œ ë²„íŠ¼ ì—´ì€ ë¹ˆ ê°’
    totalRow.innerHTML += '<td></td>';
    
    tbody.appendChild(totalRow);
}

function deleteRowByElement(btn) {
    if (!confirm('ì´ í–‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    
    const row = btn.parentElement.parentElement;
    const tbody = document.getElementById('annualHoursBody');
    const rows = Array.from(tbody.querySelectorAll('.data-row'));
    const rowIndex = rows.indexOf(row);
    
    if (rowIndex >= 0) {
        row.remove();
        
        // í•©ê³„ í–‰ ì—…ë°ì´íŠ¸
        addTotalRow();
        
        // ë°ì´í„° ì €ì¥ (localStorageì— ì €ì¥)
        saveAnnualHours();
    }
}

function createDataRow(rowData, rowIndex = null) {
    const row = document.createElement('tr');
    row.className = 'data-row';
    
    const actualRowIndex = rowIndex !== null ? rowIndex : -1;
    
    // ì£¼
    row.innerHTML += `<td><input type="text" class="week-input" value="${rowData.ì£¼ || ''}" onchange="updateRowDataByElement(this, 'ì£¼', this.value)"></td>`;
    
    // ê¸°ê°„
    row.innerHTML += `<td><input type="text" class="period-input" value="${rowData.ê¸°ê°„ || ''}" onchange="updateRowDataByElement(this, 'ê¸°ê°„', this.value)"></td>`;
    
    // ìˆ˜ì—…ì¼ìˆ˜
    row.innerHTML += `<td><input type="number" class="days-input" value="${rowData.ìˆ˜ì—…ì¼ìˆ˜ || ''}" min="0" onchange="updateRowDataByElement(this, 'ìˆ˜ì—…ì¼ìˆ˜', this.value)"></td>`;
    
    // ê³¼ëª©ë³„ ì‹œìˆ˜
    ['êµ­ì–´', 'ì‚¬íšŒ', 'ë„ë•', 'ìˆ˜í•™', 'ê³¼í•™', 'ì‹¤ê³¼', 'ì²´ìœ¡', 'ìŒì•…', 'ë¯¸ìˆ ', 'ì˜ì–´', 'ììœ¨', 'ë™ì•„ë¦¬', 'ë´‰ì‚¬', 'ì§„ë¡œ'].forEach(subject => {
        const value = rowData[subject] || '';
        row.innerHTML += `<td><input type="number" class="subject-input" data-subject="${subject}" value="${value}" min="0" onchange="updateRowDataByElement(this, '${subject}', this.value); calculateTotal(this.parentElement)"></td>`;
    });
    
    // ê³„ (í•©ê³„)
    const total = calculateRowTotal(rowData);
    row.innerHTML += `<td class="total-cell" style="font-weight:bold">${total}</td>`;
    
    // í–‰ ì‚­ì œ ë²„íŠ¼
    const actualIndex = rowIndex !== null ? rowIndex : -1;
    row.innerHTML += `<td><button class="btn btn-delete" onclick="deleteRowByElement(this)">ì‚­ì œ</button></td>`;
    
    return row;
}

function calculateRowTotal(rowData) {
    // ê³„: 4ë²ˆë¶€í„° 17ë²ˆ ì—´ì˜ ê°’ í•©ê³„ (ê³¼ëª©ë³„ ì‹œìˆ˜ë§Œ, ìˆ˜ì—…ì¼ìˆ˜ ì œì™¸)
    const subjects = ['êµ­ì–´', 'ì‚¬íšŒ', 'ë„ë•', 'ìˆ˜í•™', 'ê³¼í•™', 'ì‹¤ê³¼', 'ì²´ìœ¡', 'ìŒì•…', 'ë¯¸ìˆ ', 'ì˜ì–´', 'ììœ¨', 'ë™ì•„ë¦¬', 'ë´‰ì‚¬', 'ì§„ë¡œ'];
    return subjects.reduce((sum, sub) => sum + (parseInt(rowData[sub]) || 0), 0);
}

function calculateTotal(row) {
    // ê³„: 4ë²ˆë¶€í„° 17ë²ˆ ì—´ì˜ ê°’ í•©ê³„ (ê³¼ëª©ë³„ ì‹œìˆ˜ë§Œ, ìˆ˜ì—…ì¼ìˆ˜ ì œì™¸)
    const subjectInputs = row.querySelectorAll('.subject-input');
    let total = 0;
    subjectInputs.forEach(input => {
        total += parseInt(input.value) || 0;
    });
    
    const totalCell = row.querySelector('.total-cell');
    if (totalCell) {
        totalCell.textContent = total;
    }
    
    // í•©ê³„ í–‰ë„ ì—…ë°ì´íŠ¸
    addTotalRow();
}

function updateRowDataByElement(element, column, value) {
    const row = element.parentElement.parentElement; // tr ìš”ì†Œ
    const tbody = document.getElementById('annualHoursBody');
    const rowIndex = Array.from(tbody.children).indexOf(row);
    
    updateRowData(rowIndex, column, value);
}

function updateRowData(rowIndex, column, value) {
    // ì‹¤ì‹œê°„ ì €ì¥ì€ ì œê±°í•˜ê³ , ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ë§Œ ì„œë²„ì— ì €ì¥ë¨
    // ë°ì´í„°ëŠ” í™”ë©´ì—ë§Œ ë°˜ì˜ë˜ê³ , ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ ì„œë²„ì— ì €ì¥ë¨
}

function setupCSVLoader() {
    const csvFileInput = document.getElementById('csvFile');
    if (csvFileInput) {
        csvFileInput.addEventListener('change', handleCSVLoad);
    }
}

function handleCSVLoad(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = () => {
        // csv.jsì˜ parseCSV í•¨ìˆ˜ ì‚¬ìš©
        if (typeof parseCSV === 'function') {
            const rows = parseCSV(reader.result);
            applyCSVToAnnualTable(rows);
        } else {
            // csv.jsê°€ ë¡œë“œë˜ì§€ ì•Šì€ ê²½ìš° ì§ì ‘ íŒŒì‹±
            const rows = parseCSVDirect(reader.result);
            applyCSVToAnnualTable(rows);
        }
    };
    reader.readAsText(file, 'utf-8');
}

function parseCSVDirect(text) {
    const rows = [];
    let row = [];
    let value = '';
    let insideQuotes = false;
    
    for (let i = 0; i < text.length; i++) {
        const char = text[i];
        const next = text[i + 1];
        
        if (char === '"' && next === '"') {
            value += '"';
            i++;
        } else if (char === '"') {
            insideQuotes = !insideQuotes;
        } else if (char === ',' && !insideQuotes) {
            row.push(value.trim());
            value = '';
        } else if ((char === '\n' || char === '\r') && !insideQuotes) {
            if (value || row.length) {
                row.push(value.trim());
                rows.push(row);
                row = [];
                value = '';
            }
        } else {
            value += char;
        }
    }
    if (value || row.length) {
        row.push(value.trim());
        rows.push(row);
    }
    return rows;
}

// parseCSVëŠ” csv.jsì—ì„œ ì œê³µë¨

// CSV ë¯¸ë¦¬ë³´ê¸° ì œê±°ë¨

function applyCSVToAnnualTable(rows) {
    if (rows.length < 2) return;
    
    const dataRows = rows.slice(1);
    
    // ê³ ì •ëœ ì—´ ì¸ë±ìŠ¤ ë§¤í•‘ (CSV ì—´ ë²ˆí˜¸ëŠ” 1ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ ì¸ë±ìŠ¤ëŠ” -1)
    const columnIndexes = {
        'ì£¼': 0,  // 1ë²ˆì§¸ ì—´ (ì¸ë±ìŠ¤ 0)
        'ê¸°ê°„': 1,  // 2ë²ˆì§¸ ì—´ (ì¸ë±ìŠ¤ 1)
        'ìˆ˜ì—…ì¼ìˆ˜': 4,  // 5ë²ˆì§¸ ì—´ (ì¸ë±ìŠ¤ 4)
        'êµ­ì–´': 149,  // 150ë²ˆì§¸ ì—´ (ì¸ë±ìŠ¤ 149)
        'ì‚¬íšŒ': 154,  // 155ë²ˆì§¸ ì—´ (ì¸ë±ìŠ¤ 154)
        'ë„ë•': 155,  // 156ë²ˆì§¸ ì—´ (ì¸ë±ìŠ¤ 155)
        'ìˆ˜í•™': 156,  // 157ë²ˆì§¸ ì—´ (ì¸ë±ìŠ¤ 156)
        'ê³¼í•™': 157,  // 158ë²ˆì§¸ ì—´ (ì¸ë±ìŠ¤ 157)
        'ì‹¤ê³¼': 158,  // 159ë²ˆì§¸ ì—´ (ì¸ë±ìŠ¤ 158)
        'ì²´ìœ¡': 159,  // 160ë²ˆì§¸ ì—´ (ì¸ë±ìŠ¤ 159)
        'ìŒì•…': 160,  // 161ë²ˆì§¸ ì—´ (ì¸ë±ìŠ¤ 160)
        'ë¯¸ìˆ ': 161,  // 162ë²ˆì§¸ ì—´ (ì¸ë±ìŠ¤ 161)
        'ì˜ì–´': 162,  // 163ë²ˆì§¸ ì—´ (ì¸ë±ìŠ¤ 162)
        'ììœ¨': 163,  // 164ë²ˆì§¸ ì—´ (ì¸ë±ìŠ¤ 163)
        'ë™ì•„ë¦¬': 164,  // 165ë²ˆì§¸ ì—´ (ì¸ë±ìŠ¤ 164)
        'ë´‰ì‚¬': 165,  // 166ë²ˆì§¸ ì—´ (ì¸ë±ìŠ¤ 165)
        'ì§„ë¡œ': 166   // 167ë²ˆì§¸ ì—´ (ì¸ë±ìŠ¤ 166)
    };
    
    // 1ì—´(ì£¼ ì—´)ì´ ë¹„ì–´ìˆëŠ” í–‰ ì°¾ê¸°
    const emptyFirstColumnRows = [];
    dataRows.forEach((row, rowIdx) => {
        const firstColumnValue = columnIndexes['ì£¼'] < row.length ? (row[columnIndexes['ì£¼']] || '').trim() : '';
        if (!firstColumnValue) {
            emptyFirstColumnRows.push(rowIdx + 1); // ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì¤„ ë•ŒëŠ” 1ë¶€í„° ì‹œì‘
        }
    });
    
    // 1ì—´ì´ ë¹„ì–´ìˆëŠ” í–‰ì´ ìˆìœ¼ë©´ ì‚­ì œ ì—¬ë¶€ í™•ì¸
    let filteredRows = dataRows;
    if (emptyFirstColumnRows.length > 0) {
        const shouldDelete = confirm(`1ì—´(ì£¼ ì—´)ì— ë‚´ìš©ì´ ì—†ëŠ” í–‰ì´ ${emptyFirstColumnRows.length}ê°œ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.\ní–‰ ë²ˆí˜¸: ${emptyFirstColumnRows.join(', ')}\nì´ í–‰ë“¤ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
        if (shouldDelete) {
            filteredRows = dataRows.filter((row, rowIdx) => {
                const firstColumnValue = columnIndexes['ì£¼'] < row.length ? (row[columnIndexes['ì£¼']] || '').trim() : '';
                return firstColumnValue !== '';
            });
        }
    }
    
    const tableData = [];
    filteredRows.forEach((row, rowIdx) => {
        const rowData = {};
        
        // ì£¼ (1ë²ˆì§¸ ì—´) - CSVì—ì„œëŠ” ìˆ«ìë§Œ ì½ê³ , ì €ì¥ ì‹œ í•™ê¸° ì •ë³´ ì¶”ê°€
        if (columnIndexes['ì£¼'] < row.length) {
            const weekValue = (row[columnIndexes['ì£¼']] || '').trim();
            // ìˆ«ìë§Œ ì¶”ì¶œ (ì´ë¯¸ "1í•™ê¸° 1ì£¼" í˜•ì‹ì´ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
            const weekNum = weekValue.replace(/[^0-9]/g, '');
            if (weekNum) {
                rowData['ì£¼'] = `${currentSemester}í•™ê¸° ${weekNum}ì£¼`;
            } else {
                rowData['ì£¼'] = weekValue || '';
            }
        }
        
        // ê¸°ê°„ (2ë²ˆì§¸ ì—´)
        if (columnIndexes['ê¸°ê°„'] < row.length) {
            rowData['ê¸°ê°„'] = row[columnIndexes['ê¸°ê°„']] || '';
        }
        
        // ìˆ˜ì—…ì¼ìˆ˜ (5ë²ˆì§¸ ì—´)
        if (columnIndexes['ìˆ˜ì—…ì¼ìˆ˜'] < row.length) {
            const value = row[columnIndexes['ìˆ˜ì—…ì¼ìˆ˜']];
            rowData['ìˆ˜ì—…ì¼ìˆ˜'] = parseInt(value) || 0;
        } else {
            rowData['ìˆ˜ì—…ì¼ìˆ˜'] = 0;
        }
        
        // ê³¼ëª©ë³„ ì‹œìˆ˜
        const subjects = ['êµ­ì–´', 'ì‚¬íšŒ', 'ë„ë•', 'ìˆ˜í•™', 'ê³¼í•™', 'ì‹¤ê³¼', 'ì²´ìœ¡', 'ìŒì•…', 'ë¯¸ìˆ ', 'ì˜ì–´', 'ììœ¨', 'ë™ì•„ë¦¬', 'ë´‰ì‚¬', 'ì§„ë¡œ'];
        subjects.forEach(subject => {
            const idx = columnIndexes[subject];
            if (idx !== null && idx < row.length) {
                const value = row[idx];
                rowData[subject] = parseInt(value) || 0;
            } else {
                rowData[subject] = 0;
            }
        });
        
        // ê³„ (í•©ê³„ ê³„ì‚°: 4ë²ˆë¶€í„° 17ë²ˆ ì—´ì˜ ê°’ í•©ê³„, ê³¼ëª©ë³„ ì‹œìˆ˜ë§Œ)
        const total = subjects.reduce((sum, sub) => sum + (parseInt(rowData[sub]) || 0), 0);
        rowData['ê³„'] = total;
        
        if (Object.keys(rowData).length > 0) {
            tableData.push(rowData);
        }
    });
    
    // localStorageì— ì €ì¥
    const loginInfoStr = localStorage.getItem('timetable_login');
    if (!loginInfoStr) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        window.location.href = 'login.html';
        return;
    }
    
    let loginInfo;
    try {
        loginInfo = JSON.parse(loginInfoStr);
    } catch (e) {
        alert('ë¡œê·¸ì¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        window.location.href = 'login.html';
        return;
    }
    
    const nickname = loginInfo.nickname;
    if (!nickname) {
        alert('ë¡œê·¸ì¸ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        window.location.href = 'login.html';
        return;
    }
    
    // localStorageì— ì €ì¥
    const storageKey = `annual_data_${nickname}_semester${currentSemester}`;
    try {
        localStorage.setItem(storageKey, JSON.stringify(tableData));
        // ë¨¼ì € í™”ë©´ì— í‘œì‹œ
        renderAnnualTable(tableData);
        alert(`CSV ë°ì´í„°ê°€ ${currentSemester}í•™ê¸° ì—°ê°„ì‹œìˆ˜í‘œì— ì ìš©ë˜ì—ˆê³  ë¡œì»¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    } catch (error) {
        console.error('[CSV ì €ì¥ ì˜¤ë¥˜]', error);
        alert('ë¡œì»¬ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    }
}

function saveAnnualHours() {
    // í…Œì´ë¸”ì—ì„œ ëª¨ë“  ë°ì´í„° ì½ê¸° (í•©ê³„ í–‰ ì œì™¸)
    const tbody = document.getElementById('annualHoursBody');
    const rows = tbody.querySelectorAll('.data-row');
    const tableData = [];
    
    rows.forEach(row => {
        const rowData = {};
        
        // ì£¼ - í•™ê¸° ì •ë³´ê°€ ì—†ìœ¼ë©´ ì¶”ê°€
        const weekInput = row.querySelector('.week-input');
        if (weekInput) {
            let weekValue = weekInput.value.trim();
            // ìˆ«ìë§Œ ìˆëŠ” ê²½ìš° í•™ê¸° ì •ë³´ ì¶”ê°€
            if (weekValue && !weekValue.includes('í•™ê¸°')) {
                const weekNum = weekValue.replace(/[^0-9]/g, '');
                if (weekNum) {
                    weekValue = `${currentSemester}í•™ê¸° ${weekNum}ì£¼`;
                }
            }
            rowData['ì£¼'] = weekValue || '';
        }
        
        // ê¸°ê°„
        const periodInput = row.querySelector('.period-input');
        if (periodInput) rowData['ê¸°ê°„'] = periodInput.value || '';
        
        // ìˆ˜ì—…ì¼ìˆ˜
        const daysInput = row.querySelector('.days-input');
        if (daysInput) rowData['ìˆ˜ì—…ì¼ìˆ˜'] = parseInt(daysInput.value) || 0;
        
        // ê³¼ëª©ë³„ ì‹œìˆ˜
        const subjects = ['êµ­ì–´', 'ì‚¬íšŒ', 'ë„ë•', 'ìˆ˜í•™', 'ê³¼í•™', 'ì‹¤ê³¼', 'ì²´ìœ¡', 'ìŒì•…', 'ë¯¸ìˆ ', 'ì˜ì–´', 'ììœ¨', 'ë™ì•„ë¦¬', 'ë´‰ì‚¬', 'ì§„ë¡œ'];
        subjects.forEach(subject => {
            const input = row.querySelector(`input[data-subject="${subject}"]`);
            if (input) {
                rowData[subject] = parseInt(input.value) || 0;
            }
        });
        
        // ê³„ ê³„ì‚° (4ë²ˆë¶€í„° 17ë²ˆ ì—´ í•©ê³„)
        const total = calculateRowTotal(rowData);
        rowData['ê³„'] = total;
        
        if (Object.keys(rowData).length > 0) {
            tableData.push(rowData);
        }
    });
    
    // í•©ê³„ í–‰ ì—…ë°ì´íŠ¸
    addTotalRow();
    
    // ì„œë²„ì— ì €ì¥
    saveAnnualHoursToServer(tableData);
}

// ì„œë²„ì— ì—°ê°„ì‹œìˆ˜í‘œ ë°ì´í„° ì €ì¥
function saveAnnualHoursToServer(tableData) {
    const loginInfoStr = localStorage.getItem('timetable_login');
    if (!loginInfoStr) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        window.location.href = 'login.html';
        return;
    }
    
    let loginInfo;
    try {
        loginInfo = JSON.parse(loginInfoStr);
    } catch (e) {
        alert('ë¡œê·¸ì¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        window.location.href = 'login.html';
        return;
    }
    
    const nickname = loginInfo.nickname;
    if (!nickname) {
        alert('ë¡œê·¸ì¸ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        window.location.href = 'login.html';
        return;
    }
    
    // ì„œë²„ì— ì €ì¥
    fetch(`${window.location.origin}/api/annual-data`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            nickname: nickname,
            semester: currentSemester,
            annualData: tableData
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // ì„±ê³µ ì‹œ localStorageì—ë„ ë°±ì—… ì €ì¥ (ì˜¤í”„ë¼ì¸ ì§€ì›)
            const storageKey = `annual_data_${nickname}_semester${currentSemester}`;
            try {
                localStorage.setItem(storageKey, JSON.stringify(tableData));
            } catch (e) {
                console.warn('localStorage ë°±ì—… ì €ì¥ ì‹¤íŒ¨:', e);
            }
            alert(`${currentSemester}í•™ê¸° ì—°ê°„ì‹œìˆ˜í‘œê°€ ì„œë²„ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        } else {
            alert('ì„œë²„ ì €ì¥ ì‹¤íŒ¨: ' + (result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
    })
    .catch(error => {
        console.error('[ì—°ê°„ì‹œìˆ˜í‘œ] ì„œë²„ ì €ì¥ ì˜¤ë¥˜:', error);
        // ì„œë²„ ì €ì¥ ì‹¤íŒ¨ ì‹œ localStorageì— ì €ì¥ (ì˜¤í”„ë¼ì¸ ì§€ì›)
        const storageKey = `annual_data_${nickname}_semester${currentSemester}`;
        try {
            localStorage.setItem(storageKey, JSON.stringify(tableData));
            alert(`${currentSemester}í•™ê¸° ì—°ê°„ì‹œìˆ˜í‘œê°€ ë¡œì»¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (ì„œë²„ ì—°ê²° ì‹¤íŒ¨)`);
        } catch (e) {
            alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
    });
}

// ë¹ˆ í–‰ ì¶”ê°€ í•¨ìˆ˜
function addRow() {
    const tbody = document.getElementById('annualHoursBody');
    // í•©ê³„ í–‰ ì œê±°
    const totalRow = tbody.querySelector('.total-row');
    if (totalRow) {
        totalRow.remove();
    }
    
    const rowIndex = tbody.querySelectorAll('.data-row').length;
    // ìƒˆ í–‰ì˜ ì£¼ì°¨ ë²ˆí˜¸ ìë™ ìƒì„± (í˜„ì¬ í•™ê¸° ì •ë³´ í¬í•¨)
    const newWeekNumber = rowIndex + 1;
    const rowData = {
        'ì£¼': `${currentSemester}í•™ê¸° ${newWeekNumber}ì£¼`
    };
    const row = createDataRow(rowData, rowIndex);
    tbody.appendChild(row);
    
    // í•©ê³„ í–‰ ë‹¤ì‹œ ì¶”ê°€
    addTotalRow();
}

// í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™”
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
} else {
    // DOMì´ ì´ë¯¸ ë¡œë“œëœ ê²½ìš°
    init();
}

// í˜ì´ì§€ í‘œì‹œ ì‹œ ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸° (ë¸Œë¼ìš°ì € ë’¤ë¡œê°€ê¸° ë“±)
window.addEventListener('pageshow', function(event) {
    // í˜ì´ì§€ê°€ ìºì‹œì—ì„œ ë³µì›ëœ ê²½ìš° ë˜ëŠ” ì¼ë°˜ ë¡œë“œì¸ ê²½ìš° ëª¨ë‘ ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
    setTimeout(() => {
        loadAnnualDataFromServer();
    }, 200);
});

// í˜ì´ì§€ í¬ì»¤ìŠ¤ ì‹œì—ë„ ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸° (ë‹¤ë¥¸ íƒ­ì—ì„œ ëŒì•„ì˜¬ ë•Œ)
window.addEventListener('focus', function() {
    setTimeout(() => {
        loadAnnualDataFromServer();
    }, 300);
});
</script>

</body>
</html>
