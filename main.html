<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì´ˆë“± ì‹œê°„í‘œ ê³ ì • ë° ìë™ ë°°ì¹˜ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --fixed-bg: #e9ecef; --accent: #4a90e2; --sub-bg: #ffffff; --complete: #d4edda; }
        body { font-family: 'Malgun Gothic', sans-serif; padding: 20px; background: #f0f2f5; color: #333; line-height: 1.5; }
        
        /* ì£¼ì°¨ í‘œì‹œ */
        .week-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; font-size: 18px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .nav-buttons { text-align: right; margin-top: 10px; }
        
        .section { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 30px; }
        .section h2 { margin-top: 0; margin-bottom: 15px; }
        #classTimetableSection h2 { margin-top: 10px; }
        
        /* ê³ ì • êµê³¼ ì„¤ì • ìŠ¤íƒ€ì¼ */
        .subject-manager { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; flex-wrap: wrap; }
        #masterSheetsContainer { display: flex; flex-wrap: wrap; gap: 10px; }
        .master-sheet { border: 2px solid var(--accent); padding: 8px; border-radius: 8px; margin-bottom: 0; background: #f8fbff; width: fit-content; min-width: 280px; }
        .master-sheet h3 { margin-top: 0; margin-bottom: 5px; color: var(--accent); display: flex; justify-content: space-between; align-items: center; font-size: 16px; }
        .master-sheet table { font-size: 12px; margin: 5px 0; width: auto; }
        .master-sheet th, .master-sheet td { padding: 3px; height: 20px; font-size: 11px; width: auto; min-width: 35px; }
        .master-sheet textarea { height: 30px; font-size: 13px; padding: 3px; margin-top: 3px; width: 100%; }
        
        /* í•™ê¸‰ ì„ íƒ íŒì—… */
        .class-selector { display: none; position: absolute; background: white; border: 1px solid #ccc; padding: 10px; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 8px; min-width: 120px; }
        .class-selector label { display: block; font-size: 13px; cursor: pointer; padding: 4px; border-radius: 4px; }
        .class-selector label:hover { background: #f0f0f0; }
        
        /* ê³¼ëª© ì„ íƒ íŒì—… */
        .subject-selector { display: none; position: absolute; background: white; border: 1px solid #ccc; padding: 10px; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 8px; min-width: 150px; max-height: 300px; overflow-y: auto; }
        .subject-selector label { display: block; font-size: 12px; cursor: pointer; padding: 4px; border-radius: 4px; }
        .subject-selector label:hover { background: #f0f0f0; }
        .subject-cell { cursor: pointer; position: relative; }
        .subject-cell:hover { background: #eef5ff; }

        /* í•™ê¸‰ ê·¸ë¦¬ë“œ */
        .class-grid { display: flex; flex-wrap: wrap; gap: 10px; }
        .class-card { background: white; padding: 8px; border-radius: 8px; border: 1px solid #dee2e6; position: relative; width: fit-content; min-width: 280px; }
        .class-card.completed { border: 2px solid #28a745; background: #f9fffb; }
        .class-card h3 { margin-top: 0; margin-bottom: 5px; font-size: 16px; }
        .class-card h4 { margin: 8px 0 5px 0; font-size: 14px; }
        
        table { width: 100%; border-collapse: collapse; margin: 5px 0; font-size: 12px; table-layout: fixed; }
        th, td { border: 1px solid #ced4da; padding: 3px; text-align: center; height: 20px; }
        th { background: #eee; font-weight: bold; font-size: 11px; }
        .class-card table { width: auto; }
        .day-header { background: #e3f2fd !important; cursor: pointer !important; }
        .day-header:hover { background: #bbdefb !important; }
        .disabled-day-header { background: #ffcdd2 !important; cursor: pointer !important; }
        .disabled-day-header:hover { background: #ef9a9a !important; }
        .disabled-cell { opacity: 0.3; pointer-events: none; cursor: not-allowed !important; }
        .class-card th, .class-card td { font-size: 11px; min-width: 35px; }
        
        /* í†µí•© ì£¼ê°„ ì‹œìˆ˜ í‘œ ìµœì†Œí™” */
        #unifiedHoursTable { width: 50%; }
        #unifiedHoursTable table { width: 100%; table-layout: fixed; font-size: 11px; margin: 3px 0; }
        #unifiedHoursTable th, #unifiedHoursTable td { padding: 2px 4px; height: 18px; font-size: 10px; width: 1%; text-align: center; }
        #unifiedHoursTable th { font-size: 10px; }
        #unifiedHoursTable input { width: 18px; font-size: 10px; padding: 1px; text-align: center; }
        
        .master-td { cursor: move; background: white; font-size: 10px; transition: 0.2s; user-select: none; }
        .master-td:hover { background: #eef5ff; border: 1px solid var(--accent); }
        .master-td.dragging { opacity: 0.5; }
        .master-td.drag-over { background-color: #fff3cd !important; border: 2px dashed #ffc107 !important; }
        .selected-classes { color: var(--accent); font-weight: bold; display: block; font-size: 10px; }

        .fixed-cell { background-color: var(--fixed-bg); color: #666; font-weight: bold; font-size: 11px; }
        .selected-subject { font-size: 11px; display: block; }
        .target-zero { background-color: var(--complete); font-weight: bold; }
        
        /* ê³¼ëª©ë³„ ìƒ‰ìƒ */
        .subject-korean { color: #2563eb; font-weight: bold; } /* íŒŒë€ìƒ‰ */
        .subject-social { color: #3498db; font-weight: bold; }
        .subject-ethics { color: #9b59b6; font-weight: bold; }
        .subject-math { color: #e67e22; font-weight: bold; }
        .subject-science { color: #1abc9c; font-weight: bold; }
        .subject-practical { color: #b45309; font-weight: bold; } /* í™©ê°ˆìƒ‰ ê³„ì—´ (ë¯¸ìˆ ê³¼ êµ¬ë¶„) */
        .subject-pe { color: #27ae60; font-weight: bold; }
        .subject-music { color: #e91e63; font-weight: bold; }
        .subject-art { color: #ea580c; font-weight: bold; } /* ì£¼í™©Â·ë¹¨ê°• ê³„ì—´ (ì‹¤ê³¼ì™€ êµ¬ë¶„) */
        .subject-english { color: #2196f3; font-weight: bold; }
        
        /* ë“œë˜ê·¸ ì•¤ ë“œë¡­ */
        .draggable-cell { cursor: move; user-select: none; }
        .dragging { opacity: 0.5; }
        .drag-over { background-color: #fff3cd !important; border: 2px dashed #ffc107 !important; }
        
        input, select, textarea { border: 1px solid #ddd; border-radius: 4px; padding: 3px; font-family: inherit; }
        .class-card input, .class-card select { font-size: 10px; padding: 2px; }
        .class-card textarea { width: 100%; height: 35px; resize: none; margin-top: 3px; font-size: 10px; border-color: #eee; padding: 3px; }
        
        .btn { padding: 6px 12px; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; margin: 2px; }
        .btn:hover { opacity: 0.8; }
        .btn-auto { background: #6c757d; float: right; }
        .btn-del { background: #dc3545; font-size: 11px; padding: 3px 8px; }
        .btn-clear { background: #dc3545; float: right; margin-left: 5px; }
        .btn-export { background: #28a745; }
        .btn-import { background: #17a2b8; }
        .btn-save { background: #ffc107; color: #333; }
        .btn-load { background: #fd7e14; }
        
        .badge { position: absolute; right: 8px; top: 8px; display: none; background: #28a745; color: white; padding: 2px 6px; border-radius: 10px; font-size: 9px; }
        
        /* ì •ë³´ìˆ˜ì • ëª¨ë‹¬ */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; color: var(--accent); }
        .close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: #000; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box; }
        .form-group small { display: block; margin-top: 5px; color: #666; font-size: 12px; }
        .password-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        .password-section h3 { margin-top: 0; margin-bottom: 15px; color: #333; font-size: 16px; }
        
        .toolbar { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; align-items: center; justify-content: flex-end; }
        
        /* ì¸ì‡„ ìµœì í™” */
        @media print {
            body { padding: 0; background: white; }
            .section { page-break-inside: avoid; box-shadow: none; border: 1px solid #ddd; }
            .btn, .nav-buttons, .toolbar, .subject-manager button, .master-sheet button { display: none !important; }
            .class-card { page-break-inside: avoid; }
            .week-header { page-break-after: avoid; }
            textarea { border: none; background: transparent; }
        }
        
        /* íŒŒì¼ ì…ë ¥ ìˆ¨ê¹€ */
        #fileInput { display: none; }
    </style>
</head>
<body>
    <script>
        window.addEventListener("pageshow", function (event) {
          if (event.persisted) location.reload();
        });
    </script>
<!-- ì •ë³´ìˆ˜ì • ëª¨ë‹¬ -->
<div id="editAccountModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ê³„ì • ì •ë³´ ìˆ˜ì •</h2>
            <span class="close" onclick="closeEditAccountModal()">&times;</span>
        </div>
        <form id="editAccountForm" onsubmit="updateAccount(event)">
            <div class="form-group">
                <label>í•™êµ ì´ë¦„</label>
                <input type="text" id="editSchoolName" required>
            </div>
            <div class="form-group">
                <label>í•™ë…„</label>
                <select id="editGrade" required>
                    <option value="1">1í•™ë…„</option>
                    <option value="2">2í•™ë…„</option>
                    <option value="3">3í•™ë…„</option>
                    <option value="4">4í•™ë…„</option>
                    <option value="5">5í•™ë…„</option>
                    <option value="6">6í•™ë…„</option>
                </select>
            </div>
            <div class="form-group">
                <label>ë‹‰ë„¤ì„</label>
                <input type="text" id="editNickname" required disabled>
                <small>ë‹‰ë„¤ì„ì€ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</small>
            </div>
            
            <div class="password-section">
                <h3>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
                <div class="form-group">
                    <label>ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="editCurrentPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ë ¤ë©´ ì…ë ¥í•˜ì„¸ìš”">
                    <small>ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ì§€ ì•Šìœ¼ë ¤ë©´ ë¹„ì›Œë‘ì„¸ìš”.</small>
                </div>
                <div class="form-group">
                    <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="editNewPassword" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div class="form-group">
                    <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                    <input type="password" id="editNewPasswordConfirm" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”">
                </div>
            </div>
            
            <div style="margin-top: 20px; text-align: right;">
                <button type="button" class="btn" onclick="closeEditAccountModal()" style="background: #6c757d; margin-right: 10px;">ì·¨ì†Œ</button>
                <button type="submit" class="btn btn-success">ìˆ˜ì •</button>
            </div>
        </form>
    </div>
</div>

<!-- ì£¼ê°„ì‹œê°„í‘œ ìƒì„± - ë‹¬ë ¥ìœ¼ë¡œ ì£¼ ì„ íƒ -->
<div id="createWeeklyCalendarModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ì£¼ê°„ì‹œê°„í‘œ ìƒì„±</h2>
            <span class="close" onclick="closeCreateWeeklyCalendarModal()">&times;</span>
        </div>
        <div class="form-group">
            <label>í•´ë‹¹ ì£¼ì˜ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”</label>
            <input type="date" id="createWeeklyDateInput" style="width: 100%; padding: 10px; font-size: 16px; box-sizing: border-box;">
        </div>
        <div class="form-group">
            <label>ì£¼ì°¨ (ìˆ«ì ì…ë ¥)</label>
            <input type="text" id="createWeeklyWeekNumberInput" placeholder="ì˜ˆ: 2 (ë¹„ì›Œë‘ë©´ ì£¼ì°¨ ì—†ì´ í‘œì‹œ)" style="width: 100%; padding: 10px; font-size: 16px; box-sizing: border-box;">
        </div>
        <div style="margin-top: 20px; text-align: right;">
            <button type="button" class="btn" onclick="closeCreateWeeklyCalendarModal()" style="background: #6c757d; margin-right: 10px;">ì·¨ì†Œ</button>
            <button type="button" class="btn" style="background: #28a745;" onclick="confirmCreateWeeklyFromCalendar()">ìƒì„±</button>
        </div>
    </div>
</div>

<!-- ì£¼ì°¨ í‘œì‹œ -->
<div class="week-header">
    <div id="weekDisplay"></div>
    <div class="nav-buttons">
        <button class="btn" onclick="location.href='admin.html'">ê´€ë¦¬ì í˜ì´ì§€</button>
        <button class="btn" onclick="showEditAccountModal()" style="background: #17a2b8;">ì •ë³´ìˆ˜ì •</button>
        <button class="btn" onclick="logout()" style="background: #dc3545;">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
</div>

<div class="section" style="padding: 15px; margin-bottom: 20px;">
    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; justify-content: space-between;">
        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <label><strong id="semesterLabel">1í•™ê¸°</strong></label>
            <button class="btn" id="switchSemesterBtn" onclick="switchSemester()" style="background: #17a2b8; margin-left: 10px;">2í•™ê¸°ë¡œ ì „í™˜</button>
            <label for="weekSelectDropdown" style="margin-left: 15px; font-weight: bold;">ì£¼ê°„ ì‹œê°„í‘œ:</label>
            <select id="weekSelectDropdown" onchange="onWeekDropdownChange(this)" style="min-width: 200px; padding: 6px 10px; font-size: 14px; border-radius: 6px; border: 1px solid #ced4da;"></select>
            <button class="btn" id="goToDefaultTimetableBtn" onclick="goToDefaultTimetable()" style="background: #6c757d;">ê¸°ë³¸ì‹œê°„í‘œë¡œ ì´ë™</button>
            <button class="btn" id="deleteCurrentWeeklyBtn" onclick="deleteCurrentWeeklyTimetable()" style="background: #dc3545;">í˜„ì¬ í˜ì´ì§€ ì‚­ì œí•˜ê¸°</button>
            <button class="btn" id="createWeeklyTimetableBtn" onclick="createNewWeeklyTimetable()" style="background: #28a745;">ì£¼ê°„ì‹œê°„í‘œ ìƒì„±</button>
        </div>
        <div class="toolbar" style="margin-left: auto;">
            <span id="lastServerSaveTime" style="font-size: 12px; color: #6c757d; margin-right: 10px;"></span>
            <button class="btn btn-save" onclick="saveToServer()">ì„œë²„ì— ì €ì¥</button>
            <button class="btn btn-load" onclick="loadFromServer()">ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button class="btn btn-export" onclick="exportToExcel()">ì—‘ì…€ ë‚´ë³´ë‚´ê¸°</button>
            <button class="btn btn-import" onclick="document.getElementById('excelInput').click()">ì—‘ì…€ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <input type="file" id="excelInput" accept=".xlsx,.xls" onchange="importFromExcel(event)" style="display:none">
            <button class="btn" onclick="window.print()">ì¸ì‡„</button>
        </div>
    </div>
</div>

<div class="section">
    <h2>ğŸ“Š ì „ì²´ í•™ê¸‰ ì£¼ê°„ ì‹œìˆ˜ ë° ë‹¬ì„±ë„ (ì£¼ê°„ ëª©í‘œ ì‹œìˆ˜ë¥¼ ë¨¼ì € ì‘ì„±í•´ ì£¼ì„¸ìš”.)</h2>
    <div id="unifiedHoursTable"></div>
</div>

<div class="section" style="padding: 15px;">
    <h2 style="font-size: 16px; margin-bottom: 10px;">âš™ï¸ ê³ ì • êµê³¼ ë° ì „ë‹´ êµì‚¬ ì„¤ì •</h2>
    <div class="subject-manager">
        <span><strong>ìƒˆ ê³ ì • ì‹œíŠ¸:</strong></span>
        <select id="newSubName" style="width:120px;"></select>
        <input type="text" id="newSubTag" placeholder="íƒœê·¸ (ì˜ˆ: ë‹´ì„)" style="width:100px; padding: 5px; margin-right: 5px; border: 1px solid #ccc; border-radius: 3px;">
        <button class="btn" onclick="addSubjectSheet()">ì‹œíŠ¸ ìƒì„±</button>
        <button class="btn" onclick="undoLastMasterAction()" style="background: #6c757d;">ë˜ëŒë¦¬ê¸°</button>
    </div>

    <div id="masterSheetsContainer"></div>
</div>

<div class="section" id="classTimetableSection">
    <h2>ğŸ« í•™ê¸‰ë³„ ì‹œê°„í‘œ <span id="currentWeekLabelDisplay" style="font-size: 16px; font-weight: normal; color: #666;"></span></h2>
    <div id="classGrid" class="class-grid"></div>
    <div id="unifiedMemoContainer" style="margin-top: 20px;">
        <h3 style="font-size: 14px; margin-bottom: 10px;">ğŸ“ ë©”ëª¨</h3>
        <div id="unifiedMemoContent"></div>
    </div>
</div>


<div id="globalClassSelector" class="class-selector"></div>
<div id="globalSubjectSelector" class="subject-selector"></div>

<script>
const allSubjects = ["êµ­ì–´", "ì‚¬íšŒ", "ë„ë•", "ìˆ˜í•™", "ê³¼í•™", "ì‹¤ê³¼", "ì²´ìœ¡", "ìŒì•…", "ë¯¸ìˆ ", "ì˜ì–´", "ì°½ì²´(ì)", "ì°½ì²´(ë™)", "ì°½ì²´(ë´‰)", "ì°½ì²´(ì§„)"];
const days = ["ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ"];

// ê³¼ëª©ë³„ CSS í´ë˜ìŠ¤ ë§¤í•‘
function getSubjectClass(subject) {
    const classMap = {
        'êµ­ì–´': 'subject-korean',
        'ì‚¬íšŒ': 'subject-social',
        'ë„ë•': 'subject-ethics',
        'ìˆ˜í•™': 'subject-math',
        'ê³¼í•™': 'subject-science',
        'ì‹¤ê³¼': 'subject-practical',
        'ì²´ìœ¡': 'subject-pe',
        'ìŒì•…': 'subject-music',
        'ë¯¸ìˆ ': 'subject-art',
        'ì˜ì–´': 'subject-english'
    };
    return classMap[subject] || '';
}

// í˜„ì¬ í•™ê¸° (localStorageì—ì„œ ë¶ˆëŸ¬ì˜¤ê±°ë‚˜ ê¸°ë³¸ê°’ '1')
let currentSemester = localStorage.getItem('main_semester') || '1';

let state = {
    classCount: 3,
    periodCount: 7, // êµì‹œ ìˆ˜
    subjectSheets: [], // { subName, memo: "", rules: { "0-0": [1, 2] } }
    classData: {}, // { classNum: { timetable: [], targetHours: [], memo: "" } }
    preferences: {}, // { subject: [1, 2, 3] } - ì„ í˜¸í•˜ëŠ” êµì‹œ ë°°ì—´
    currentWeek: new Date(), // í˜„ì¬ ì£¼ì°¨
    annualHours: {},
    memo: "", // í†µí•© ë©”ëª¨
    weeklyData1: {}, // 1í•™ê¸° ì£¼ë³„ ë°ì´í„° { weekIndex: { subjectSheets: [], classData: {}, disabledDays: {} } }
    weeklyData2: {}, // 2í•™ê¸° ì£¼ë³„ ë°ì´í„°
    weekLabels1: { 0: "ê¸°ë³¸ì‹œê°„í‘œ" }, // ì£¼ê°„ë³„ í‘œì‹œ ì´ë¦„
    weekLabels2: { 0: "ê¸°ë³¸ì‹œê°„í‘œ" },
    disabledDays: {}, // { "ì›”": true, "í™”": false } - ë¹„í™œì„±í™”ëœ ìš”ì¼
    dayPeriodLimits: {} // { "ìˆ˜": 5 } - ìš”ì¼ë³„ ìˆ˜ì—… ìˆ˜ ì œí•œ (ì˜ˆ: ìˆ˜ìš”ì¼ì€ 5êµì‹œê¹Œì§€)
};

function init() {
    // ë¡œê·¸ì¸ ì²´í¬
    const loginInfo = localStorage.getItem('timetable_login');
    if (!loginInfo) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        window.location.href = 'login.html';
        return;
    }
    
    // í˜„ì¬ í•™ê¸° UI ì—…ë°ì´íŠ¸
    updateSemesterUI();
    
    // ë¡œì»¬ì— ì €ì¥ëœ ë°ì´í„°ë§Œ ë¶ˆëŸ¬ì˜¤ê¸°
    loadDataFromLocal();
    
    // ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ìœ¼ë¡œ ë“¤ì–´ì˜¨ ê²½ìš° í”Œë˜ê·¸ ì œê±°
    if (localStorage.getItem('main_doLoadFromServer') === '1') {
        localStorage.removeItem('main_doLoadFromServer');
    }
    
    // ë¡œê·¸ì¸ í›„ í˜ì´ì§€ë¥¼ ì—´ì—ˆì„ ë•Œ ì„œë²„ì—ì„œ ìë™ ë¶ˆëŸ¬ì˜¤ê¸° (í•œ ë²ˆ)
    loadDataFromServer();
}

// í•™ê¸° ì „í™˜ í•¨ìˆ˜
function switchSemester() {
    if (currentWeekIndex >= 0) saveCurrentWeekData();
    
    currentSemester = currentSemester === '1' ? '2' : '1';
    localStorage.setItem('main_semester', currentSemester);
    
    updateSemesterUI();
    ensureWeekLabelsExist();
    currentWeekIndex = 0;
    loadWeekDataFromStorage(0);
    updateWeekDropdown();
    renderAll();
}

// ì£¼ê°„ ë¼ë²¨ ë³´ì •: 0ì£¼ì°¨ëŠ” í•­ìƒ "ê¸°ë³¸ì‹œê°„í‘œ"ë¡œ í‘œê¸°
function ensureWeekLabelsExist() {
    if (!state.weekLabels1) state.weekLabels1 = {};
    if (!state.weekLabels2) state.weekLabels2 = {};
    state.weekLabels1[0] = "ê¸°ë³¸ì‹œê°„í‘œ";
    state.weekLabels2[0] = "ê¸°ë³¸ì‹œê°„í‘œ";
}

// ì£¼ê°„ ì‹œê°„í‘œ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸° ë° ì„ íƒê°’ ë™ê¸°í™”
function updateWeekDropdown() {
    const sel = document.getElementById('weekSelectDropdown');
    if (!sel) return;
    const labels = currentSemester === '1' ? state.weekLabels1 : state.weekLabels2;
    if (!labels) return;
    
    const indices = Object.keys(labels).map(Number).sort((a, b) => a - b);
    sel.innerHTML = '';
    indices.forEach(idx => {
        const opt = document.createElement('option');
        opt.value = idx;
        opt.textContent = labels[idx] || `${currentSemester}í•™ê¸°`;
        sel.appendChild(opt);
    });
    if (currentWeekIndex >= 0 && indices.indexOf(currentWeekIndex) >= 0) {
        sel.value = String(currentWeekIndex);
    } else if (indices.length > 0) {
        currentWeekIndex = indices[0];
        sel.value = String(currentWeekIndex);
    }
    // ê¸°ë³¸ì‹œê°„í‘œ(0ì£¼ì°¨)ì—ì„œë§Œ ì£¼ê°„ì‹œê°„í‘œ ìƒì„± ë²„íŠ¼ í‘œì‹œ
    const createBtn = document.getElementById('createWeeklyTimetableBtn');
    if (createBtn) createBtn.style.display = currentWeekIndex === 0 ? '' : 'none';
    // ê¸°ë³¸ì‹œê°„í‘œì¼ ë•ŒëŠ” 'ê¸°ë³¸ì‹œê°„í‘œë¡œ ì´ë™', 'í˜„ì¬ í˜ì´ì§€ ì‚­ì œí•˜ê¸°' ë²„íŠ¼ ìˆ¨ê¹€
    const goDefaultBtn = document.getElementById('goToDefaultTimetableBtn');
    if (goDefaultBtn) goDefaultBtn.style.display = currentWeekIndex === 0 ? 'none' : '';
    const deleteBtn = document.getElementById('deleteCurrentWeeklyBtn');
    if (deleteBtn) deleteBtn.style.display = currentWeekIndex === 0 ? 'none' : '';
    // í•™ê¸‰ë³„ ì‹œê°„í‘œ ì˜†ì— í˜„ì¬ ì£¼ê°„ì‹œê°„í‘œ ë ˆì´ë¸” í‘œì‹œ
    const labelEl = document.getElementById('currentWeekLabelDisplay');
    if (labelEl) {
        const currentLabel = labels[currentWeekIndex];
        labelEl.textContent = currentLabel ? ' â€” ' + currentLabel : '';
    }
}

// ë“œë¡­ë‹¤ìš´ì—ì„œ ì£¼ê°„ ì„ íƒ ì‹œ
function onWeekDropdownChange(selectEl) {
    const idx = parseInt(selectEl.value, 10);
    if (isNaN(idx) || idx < 0) return;
    if (currentWeekIndex >= 0) saveCurrentWeekData();
    currentWeekIndex = idx;
    loadWeekDataFromStorage(currentWeekIndex);
    updateWeekDropdown();
    renderAll();
}

// í˜„ì¬ ì£¼ê°„ ì‹œê°„í‘œ ì‚­ì œ (ê¸°ë³¸ì‹œê°„í‘œëŠ” ì‚­ì œ ë¶ˆê°€)
function deleteCurrentWeeklyTimetable() {
    if (currentWeekIndex === 0) {
        alert('ê¸°ë³¸ì‹œê°„í‘œëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    const labels = currentSemester === '1' ? state.weekLabels1 : state.weekLabels2;
    const weekLabel = labels[currentWeekIndex] || `${currentSemester}í•™ê¸°`;
    if (!confirm(`"${weekLabel}" ì£¼ê°„ ì‹œê°„í‘œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œ í›„ ê¸°ë³¸ì‹œê°„í‘œë¡œ ì´ë™í•©ë‹ˆë‹¤.`)) return;
    
    const curLabels = currentSemester === '1' ? state.weekLabels1 : state.weekLabels2;
    const curData = currentSemester === '1' ? state.weeklyData1 : state.weeklyData2;
    delete curLabels[currentWeekIndex];
    delete curData[currentWeekIndex];
    
    currentWeekIndex = 0;
    loadWeekDataFromStorage(0);
    updateWeekDropdown();
    saveToLocalStorage();
    renderAll();
}

// ê¸°ë³¸ì‹œê°„í‘œ(0ì£¼ì°¨)ë¡œ ì´ë™
function goToDefaultTimetable() {
    if (currentWeekIndex === 0) return;
    if (currentWeekIndex >= 0) saveCurrentWeekData();
    currentWeekIndex = 0;
    loadWeekDataFromStorage(0);
    updateWeekDropdown();
    renderAll();
}

// ì„ íƒí•œ ë‚ ì§œê°€ ì†í•œ ì£¼ì˜ ì›”ìš”ì¼ ë°˜í™˜ (í•œêµ­: ì›”~ê¸ˆ ê¸°ì¤€)
function getMondayOfWeek(d) {
    const date = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    const day = date.getDay(); // 0=ì¼, 1=ì›”, ..., 6=í† 
    const diff = day === 0 ? -6 : 1 - day;
    date.setDate(date.getDate() + diff);
    return date;
}

// í•´ë‹¹ ì£¼ ì›”~ê¸ˆ ë‚ ì§œë¡œ ë¼ë²¨ ë¬¸ìì—´ ìƒì„± (ì˜ˆ: 3.9~3.13)
function getWeekRangeLabel(d) {
    const mon = getMondayOfWeek(d);
    const fri = new Date(mon);
    fri.setDate(mon.getDate() + 4);
    const m = mon.getMonth() + 1, d1 = mon.getDate();
    const m2 = fri.getMonth() + 1, d2 = fri.getDate();
    return m + '.' + d1 + '~' + m2 + '.' + d2;
}

// ì£¼ê°„ì‹œê°„í‘œ ìƒì„± ëª¨ë‹¬ ì—´ê¸° (ë‹¬ë ¥ìœ¼ë¡œ ì£¼ ì„ íƒ)
function createNewWeeklyTimetable() {
    saveCurrentWeekData();
    const input = document.getElementById('createWeeklyDateInput');
    const weekNumInput = document.getElementById('createWeeklyWeekNumberInput');
    if (!input) return;
    const today = new Date();
    input.value = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
    if (weekNumInput) weekNumInput.value = '';
    document.getElementById('createWeeklyCalendarModal').style.display = 'block';
}

function closeCreateWeeklyCalendarModal() {
    const modal = document.getElementById('createWeeklyCalendarModal');
    if (modal) modal.style.display = 'none';
}

function confirmCreateWeeklyFromCalendar() {
    const input = document.getElementById('createWeeklyDateInput');
    if (!input || !input.value) {
        alert('ë‚ ì§œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');
        return;
    }
    const d = new Date(input.value + 'T12:00:00');
    if (isNaN(d.getTime())) {
        alert('ì˜¬ë°”ë¥¸ ë‚ ì§œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');
        return;
    }
    const labels = currentSemester === '1' ? state.weekLabels1 : state.weekLabels2;
    const weeklyData = currentSemester === '1' ? state.weeklyData1 : state.weeklyData2;
    if (!labels) {
        if (currentSemester === '1') state.weekLabels1 = {};
        else state.weekLabels2 = {};
    }
    if (!weeklyData) {
        if (currentSemester === '1') state.weeklyData1 = {};
        else state.weeklyData2 = {};
    }
    const curLabels = currentSemester === '1' ? state.weekLabels1 : state.weekLabels2;
    const curData = currentSemester === '1' ? state.weeklyData1 : state.weeklyData2;
    const nextIdx = Math.max(0, ...Object.keys(curLabels).map(Number)) + 1;
    const weekLabel = getWeekRangeLabel(d);
    const weekNumEl = document.getElementById('createWeeklyWeekNumberInput');
    const weekNum = weekNumEl ? weekNumEl.value.trim() : '';
    const sem = currentSemester === '1' ? '1í•™ê¸°' : '2í•™ê¸°';
    const label = weekNum ? sem + ' ' + weekNum + 'ì£¼ì°¨(' + weekLabel + ')' : sem + ' (' + weekLabel + ')';
    curLabels[nextIdx] = label;
    curData[nextIdx] = {
        subjectSheets: JSON.parse(JSON.stringify(state.subjectSheets)),
        classData: JSON.parse(JSON.stringify(state.classData)),
        disabledDays: JSON.parse(JSON.stringify(state.disabledDays || {}))
    };
    currentWeekIndex = nextIdx;
    loadWeekDataFromStorage(currentWeekIndex);
    updateWeekDropdown();
    saveToLocalStorage();
    renderAll();
    closeCreateWeeklyCalendarModal();
    alert('"' + label + '" ì£¼ê°„ ì‹œê°„í‘œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

// í•™ê¸° UI ì—…ë°ì´íŠ¸
function updateSemesterUI() {
    const semesterLabel = document.getElementById('semesterLabel');
    const switchBtn = document.getElementById('switchSemesterBtn');
    
    if (semesterLabel) {
        semesterLabel.textContent = `${currentSemester}í•™ê¸°`;
    }
    if (switchBtn) {
        switchBtn.textContent = currentSemester === '1' ? '2í•™ê¸°ë¡œ ì „í™˜' : '1í•™ê¸°ë¡œ ì „í™˜';
    }
}

// ë¡œì»¬ì— ë°ì´í„° ì €ì¥ (ëª¨ë“  í¸ì§‘ì€ ë¡œì»¬ì—ë§Œ ë°˜ì˜, ì„œë²„ëŠ” 'ì„œë²„ì— ì €ì¥' ì‹œì—ë§Œ ë°˜ì˜)
function saveToLocalStorage() {
    const loginInfo = localStorage.getItem('timetable_login');
    if (!loginInfo) return;
    const login = JSON.parse(loginInfo);
    const nickname = login.nickname;
    if (!nickname) return;
    const stateToSave = { ...state };
    delete stateToSave.annualTableData;
    try {
        localStorage.setItem(`timetable_main_${nickname}`, JSON.stringify(stateToSave));
    } catch (e) {
        console.error('ë¡œì»¬ ì €ì¥ ì˜¤ë¥˜:', e);
    }
}

// ë¡œì»¬ì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (ìµœì´ˆ ì§„ì… ë˜ëŠ” ì„œë²„ ë¯¸ì‚¬ìš© ì‹œ)
function loadDataFromLocal() {
    const loginInfo = localStorage.getItem('timetable_login');
    if (!loginInfo) return;
    let login;
    try {
        login = JSON.parse(loginInfo);
    } catch (e) {
        console.error('ë¡œê·¸ì¸ ì •ë³´ íŒŒì‹± ì˜¤ë¥˜:', e);
        return;
    }
    const nickname = login.nickname;
    if (!nickname) return;

    const raw = localStorage.getItem(`timetable_main_${nickname}`);
    
    if (raw) {
        try {
            const parsed = JSON.parse(raw);
            delete parsed.annualTableData;
            delete parsed.annualTableData1;
            delete parsed.annualTableData2;
            Object.assign(state, parsed);
            if (parsed.currentWeek) state.currentWeek = new Date(parsed.currentWeek);
            if (!state.periodCount) state.periodCount = 7;
            if (!state.annualHours) state.annualHours = {};
            if (!state.weeklyData1) state.weeklyData1 = {};
            if (!state.weeklyData2) state.weeklyData2 = {};
            if (!state.weekLabels1) state.weekLabels1 = {};
            if (!state.weekLabels2) state.weekLabels2 = {};
        } catch (e) {
            console.error('ë¡œì»¬ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', e);
        }
    } else {
        state.periodCount = state.periodCount || 7;
        state.annualHours = state.annualHours || {};
        state.weeklyData1 = state.weeklyData1 || {};
        state.weeklyData2 = state.weeklyData2 || {};
        state.weekLabels1 = state.weekLabels1 || {};
        state.weekLabels2 = state.weekLabels2 || {};
    }
    ensureWeekLabelsExist();
    const subSelect = document.getElementById('newSubName');
    if (subSelect) {
        subSelect.innerHTML = '';
        allSubjects.forEach(s => subSelect.add(new Option(s, s)));
    }
    currentWeekIndex = 0;
    loadWeekDataFromStorage(0);
    updateWeekDropdown();
    updateWeekDisplay();
    refreshLastServerSaveDisplay();
    renderAll();
}

// ì„œë²„ì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ í˜¸ì¶œ, ë¶ˆëŸ¬ì˜¨ ë’¤ ë¡œì»¬ì—ë„ ë°˜ì˜)
function loadDataFromServer() {
    const loginInfo = JSON.parse(localStorage.getItem('timetable_login'));
    const nickname = loginInfo.nickname;
    
    fetch(`${window.location.origin}/api/data?nickname=${encodeURIComponent(nickname)}`)
        .then(response => response.json())
        .then(result => {
            if (result.success && result.data) {
                const parsed = result.data;
                delete parsed.annualTableData;
                delete parsed.annualTableData1;
                delete parsed.annualTableData2;
                Object.assign(state, parsed);
                if (parsed.currentWeek) state.currentWeek = new Date(parsed.currentWeek);
                if (!state.periodCount) state.periodCount = 7;
                if (!state.annualHours) state.annualHours = {};
                if (!state.weeklyData1) state.weeklyData1 = {};
                if (!state.weeklyData2) state.weeklyData2 = {};
            } else {
                state.periodCount = 7;
                state.annualHours = {};
                state.weeklyData1 = {};
                state.weeklyData2 = {};
            }
            
            const subSelect = document.getElementById('newSubName');
            if (subSelect) {
                subSelect.innerHTML = '';
                allSubjects.forEach(s => subSelect.add(new Option(s, s)));
            }
            if (!state.weekLabels1) state.weekLabels1 = {};
            if (!state.weekLabels2) state.weekLabels2 = {};
            ensureWeekLabelsExist();
            currentWeekIndex = 0;
            loadWeekDataFromStorage(0);
            updateWeekDropdown();
            updateWeekDisplay();
            renderAll();
            saveToLocalStorage();
        })
        .catch(error => {
            console.error('ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
            alert('ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            state.periodCount = 7;
            state.annualHours = {};
            state.weeklyData1 = {};
            state.weeklyData2 = {};
            state.weekLabels1 = state.weekLabels1 || {};
            state.weekLabels2 = state.weekLabels2 || {};
            ensureWeekLabelsExist();
            const subSelect = document.getElementById('newSubName');
            if (subSelect) {
                subSelect.innerHTML = '';
                allSubjects.forEach(s => subSelect.add(new Option(s, s)));
            }
            currentWeekIndex = 0;
            loadWeekDataFromStorage(0);
            updateWeekDropdown();
            updateWeekDisplay();
            renderAll();
        });
}

function logout() {
    if (confirm('ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        localStorage.removeItem('timetable_login');
        window.location.href = 'login.html';
    }
}

// ì •ë³´ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
function showEditAccountModal() {
    const loginInfo = JSON.parse(localStorage.getItem('timetable_login'));
    if (!loginInfo) {
        alert('ë¡œê·¸ì¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // í˜„ì¬ ì •ë³´ë¡œ í¼ ì±„ìš°ê¸°
    document.getElementById('editSchoolName').value = loginInfo.schoolName || '';
    document.getElementById('editGrade').value = loginInfo.grade || '1';
    document.getElementById('editNickname').value = loginInfo.nickname || '';
    document.getElementById('editNickname').disabled = true; // ë‹‰ë„¤ì„ì€ ë³€ê²½ ë¶ˆê°€
    
    // ë¹„ë°€ë²ˆí˜¸ í•„ë“œ ì´ˆê¸°í™”
    document.getElementById('editCurrentPassword').value = '';
    document.getElementById('editNewPassword').value = '';
    document.getElementById('editNewPasswordConfirm').value = '';
    
    document.getElementById('editAccountModal').style.display = 'block';
}

// ì •ë³´ìˆ˜ì • ëª¨ë‹¬ ë‹«ê¸°
function closeEditAccountModal() {
    document.getElementById('editAccountModal').style.display = 'none';
}

// ê³„ì • ì •ë³´ ìˆ˜ì •
function updateAccount(event) {
    event.preventDefault();
    
    const loginInfo = JSON.parse(localStorage.getItem('timetable_login'));
    if (!loginInfo) {
        alert('ë¡œê·¸ì¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    const schoolName = document.getElementById('editSchoolName').value.trim();
    const grade = parseInt(document.getElementById('editGrade').value);
    const nickname = loginInfo.nickname; // ë‹‰ë„¤ì„ì€ ë³€ê²½ ë¶ˆê°€
    const currentPassword = document.getElementById('editCurrentPassword').value;
    const newPassword = document.getElementById('editNewPassword').value;
    const newPasswordConfirm = document.getElementById('editNewPasswordConfirm').value;
    
    // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì—¬ë¶€ í™•ì¸
    const isChangingPassword = currentPassword || newPassword || newPasswordConfirm;
    
    if (isChangingPassword) {
        // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹œ ëª¨ë“  í•„ë“œ í•„ìˆ˜
        if (!currentPassword) {
            alert('ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        if (!newPassword) {
            alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        if (newPassword !== newPasswordConfirm) {
            alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            return;
        }
        if (newPassword.length < 4) {
            alert('ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
            return;
        }
    }
    
    // ì„œë²„ì— ìˆ˜ì • ìš”ì²­
    fetch(`${window.location.origin}/api/accounts/update`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            nickname: nickname,
            schoolName: schoolName,
            grade: grade,
            currentPassword: currentPassword || null,
            newPassword: isChangingPassword ? newPassword : null
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.message || `HTTP ${response.status}`);
            });
        }
        return response.json();
    })
    .then(result => {
        if (result.success) {
            // ë¡œê·¸ì¸ ì •ë³´ ì—…ë°ì´íŠ¸
            const updatedLoginInfo = {
                schoolName: schoolName,
                grade: grade,
                nickname: nickname,
                loginTime: loginInfo.loginTime
            };
            localStorage.setItem('timetable_login', JSON.stringify(updatedLoginInfo));
            
            alert('ê³„ì • ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
            closeEditAccountModal();
            
            // í˜ì´ì§€ í‘œì‹œ ì—…ë°ì´íŠ¸
            updateWeekDisplay();
        } else {
            alert('ìˆ˜ì • ì‹¤íŒ¨: ' + (result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
    })
    .catch(error => {
        console.error('ê³„ì • ìˆ˜ì • ì˜¤ë¥˜:', error);
        alert('ê³„ì • ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    });
}

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
window.onclick = function(event) {
    const modal = document.getElementById('editAccountModal');
    if (event.target === modal) {
        closeEditAccountModal();
    }
}

// ì£¼ì°¨ í‘œì‹œ ì—…ë°ì´íŠ¸ (ë¡œê·¸ì¸ ì •ë³´ë¡œ ë³€ê²½)
function updateWeekDisplay() {
    const loginInfo = localStorage.getItem('timetable_login');
    if (loginInfo) {
        try {
            const login = JSON.parse(loginInfo);
            if (login.schoolName && login.grade) {
                document.getElementById('weekDisplay').innerHTML = 
                    `${login.schoolName} ${login.grade}í•™ë…„ ì‹œê°„í‘œ`;
                return;
            }
        } catch (e) {
            // íŒŒì‹± ì˜¤ë¥˜ ì‹œ ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©
        }
    }
    
    // ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìœ¼ë©´ ê¸°ì¡´ ì£¼ì°¨ í‘œì‹œ
    const date = state.currentWeek || new Date();
    const year = date.getFullYear();
    const month = date.getMonth() + 1;
    
    // í•´ë‹¹ ì›”ì˜ ì²« ë²ˆì§¸ ë‚ 
    const firstDay = new Date(year, month - 1, 1);
    const firstDayOfWeek = firstDay.getDay();
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDayOfWeek);
    
    // í˜„ì¬ ë‚ ì§œê°€ ì†í•œ ì£¼ ì°¾ê¸°
    const diffTime = date.getTime() - startDate.getTime();
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    const weekNumber = Math.floor(diffDays / 7) + 1;
    
    // í•´ë‹¹ ì£¼ì˜ ì‹œì‘ì¼
    const weekStart = new Date(startDate);
    weekStart.setDate(startDate.getDate() + (weekNumber - 1) * 7);
    const weekStartMonth = weekStart.getMonth() + 1;
    const weekStartDate = weekStart.getDate();
    
    document.getElementById('weekDisplay').innerHTML = 
        `${month}ì›” ${weekStartDate}ì¼ ì£¼ - 1í•™ê¸°`;
}

function saveAndRefresh(full = true) {
    // í˜„ì¬ ì£¼ì˜ ë°ì´í„°ë¥¼ ì£¼ë³„ ë°ì´í„°ì— ì €ì¥
    if (currentWeekIndex >= 0) {
        saveCurrentWeekData();
    }
    
    // ë¡œì»¬ì—ë§Œ ì €ì¥ (ì„œë²„ ë°˜ì˜ì€ 'ì„œë²„ì— ì €ì¥' ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ)
    saveToLocalStorage();
    
    if (full) { renderMasterSheets(); renderClassGrid(); renderUnifiedMemo(); }
}

// ì„œë²„ì— ë°ì´í„° ì €ì¥ (ì„±ê³µ ì‹œ result.success === trueì¸ Promise ë°˜í™˜)
function saveDataToServer() {
    const loginInfo = localStorage.getItem('timetable_login');
    if (!loginInfo) return Promise.resolve({ success: false });
    
    const login = JSON.parse(loginInfo);
    const nickname = login.nickname;
    
    const stateToSave = { ...state };
    
    return fetch(`${window.location.origin}/api/data`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            nickname: nickname,
            state: stateToSave
        })
    })
    .then(response => response.json())
    .then(result => {
        if (!result.success) {
            console.error('ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', result.message);
        }
        return result;
    })
    .catch(error => {
        console.error('ë°ì´í„° ì €ì¥ ì˜¤ë¥˜:', error);
        return { success: false };
    });
}

// í˜„ì¬ ì£¼ì˜ ë°ì´í„°ë¥¼ ì €ì¥
function saveCurrentWeekData() {
    if (currentWeekIndex < 0) return;
    
    // í˜„ì¬ í•™ê¸°ì— ë§ëŠ” weeklyData ì‚¬ìš©
    const weeklyData = currentSemester === '1' ? state.weeklyData1 : state.weeklyData2;
    if (!weeklyData) {
        if (currentSemester === '1') {
            state.weeklyData1 = {};
        } else {
            state.weeklyData2 = {};
        }
    }
    
    const targetWeeklyData = currentSemester === '1' ? state.weeklyData1 : state.weeklyData2;
    if (!targetWeeklyData[currentWeekIndex]) {
        targetWeeklyData[currentWeekIndex] = {};
    }
    
    // í˜„ì¬ ì£¼ì˜ subjectSheets, classData, disabledDaysë¥¼ ê¹Šì€ ë³µì‚¬ë¡œ ì €ì¥
    targetWeeklyData[currentWeekIndex] = {
        subjectSheets: JSON.parse(JSON.stringify(state.subjectSheets)),
        classData: JSON.parse(JSON.stringify(state.classData)),
        disabledDays: JSON.parse(JSON.stringify(state.disabledDays || {}))
    };
}

// íŠ¹ì • ì£¼ì˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê¸°
function loadWeekDataFromStorage(weekIndex) {
    // í˜„ì¬ í•™ê¸°ì— ë§ëŠ” weeklyData ì‚¬ìš©
    const weeklyData = currentSemester === '1' ? state.weeklyData1 : state.weeklyData2;
    
    if (!weeklyData || !weeklyData[weekIndex]) {
        // ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
        state.subjectSheets = [];
        state.classData = {};
        state.disabledDays = {};
        
        // í•™ê¸‰ ë°ì´í„° ì´ˆê¸°í™”
        for (let i = 1; i <= state.classCount; i++) {
            if (!state.classData[i]) {
                state.classData[i] = { 
                    timetable: Array(state.periodCount).fill().map(() => Array(5).fill("")), 
                    targetHours: Array(allSubjects.length).fill(0),
                    memo: ""
                };
            }
        }
    } else {
        // ì €ì¥ëœ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        const weekData = weeklyData[weekIndex];
        state.subjectSheets = JSON.parse(JSON.stringify(weekData.subjectSheets));
        state.classData = JSON.parse(JSON.stringify(weekData.classData));
        state.disabledDays = JSON.parse(JSON.stringify(weekData.disabledDays || {}));
    }
}

// ë§ˆì§€ë§‰ ì„œë²„ ì €ì¥ ì¼ì‹œë¥¼ localStorageì— ì €ì¥í•˜ê³  í™”ë©´ì— í‘œì‹œ
function setLastServerSaveTime(displayText) {
    const el = document.getElementById('lastServerSaveTime');
    if (el) el.textContent = displayText;
    const loginInfo = localStorage.getItem('timetable_login');
    if (loginInfo) {
        try {
            const login = JSON.parse(loginInfo);
            if (login.nickname) localStorage.setItem('timetable_lastServerSave_' + login.nickname, displayText);
        } catch (e) {}
    }
}

// ISO ì‹œê° ë¬¸ìì—´ì„ 'ë§ˆì§€ë§‰ ì €ì¥: YYYY-MM-DD HH:mm:ss' í˜•ì‹ìœ¼ë¡œ ë³€í™˜
function formatSavedAtDisplay(isoStr) {
    if (!isoStr) return '';
    try {
        const d = new Date(isoStr);
        if (isNaN(d.getTime())) return '';
        const dateStr = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
        const timeStr = String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0') + ':' + String(d.getSeconds()).padStart(2, '0');
        return 'ë§ˆì§€ë§‰ ì €ì¥: ' + dateStr + ' ' + timeStr;
    } catch (e) { return ''; }
}

// ì €ì¥ëœ ë§ˆì§€ë§‰ ì„œë²„ ì €ì¥ ì¼ì‹œë¥¼ í™”ë©´ì— ë³µì› (ë¡œì»¬ + ì„œë²„ ì¡°íšŒë¡œ ë‹¤ë¥¸ PCì—ì„œë„ í‘œì‹œ)
function refreshLastServerSaveDisplay() {
    const loginInfo = localStorage.getItem('timetable_login');
    if (!loginInfo) return;
    try {
        const login = JSON.parse(loginInfo);
        const nickname = login.nickname;
        if (!nickname) return;
        const el = document.getElementById('lastServerSaveTime');
        // ì„œë²„ì—ì„œ ë§ˆì§€ë§‰ ì €ì¥ ì‹œê° ì¡°íšŒ (ë‹¤ë¥¸ PCì—ì„œ ë¡œê·¸ì¸í•´ë„ í‘œì‹œë˜ë„ë¡)
        fetch(window.location.origin + '/api/last-save?nickname=' + encodeURIComponent(nickname))
            .then(function(r) { return r.json(); })
            .then(function(result) {
                if (result && result.success && result.savedAt) {
                    const displayText = formatSavedAtDisplay(result.savedAt);
                    if (el && displayText) {
                        el.textContent = displayText;
                        setLastServerSaveTime(displayText);
                    }
                } else {
                    const saved = localStorage.getItem('timetable_lastServerSave_' + nickname);
                    if (el && saved) el.textContent = saved;
                }
            })
            .catch(function() {
                const saved = localStorage.getItem('timetable_lastServerSave_' + nickname);
                if (el && saved) el.textContent = saved;
            });
    } catch (e) {}
}

// ì„œë²„ì— ì €ì¥ (ë¡œì»¬ ìƒíƒœë¥¼ ì„œë²„ë¡œ ì—…ë¡œë“œ, ë¹„ë°€ë²ˆí˜¸ í™•ì¸ í•„ìš”)
function saveToServer() {
    if (!confirm('ì„œë²„ì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê¸°ì¡´ ì„œë²„ì— ìˆëŠ” ìë£ŒëŠ” í˜„ì¬ í™”ë©´ ë‚´ìš©ìœ¼ë¡œ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.')) return;
    const password = prompt('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
    if (password === null) return;
    if (password === '') {
        alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        return;
    }
    const loginInfo = localStorage.getItem('timetable_login');
    if (!loginInfo) return;
    const login = JSON.parse(loginInfo);
    const nickname = login.nickname;
    fetch(window.location.origin + '/api/accounts/verify-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nickname: nickname, password: password })
    })
    .then(function(r) { return r.json(); })
    .then(function(verify) {
        if (!verify || !verify.success) {
            alert(verify && verify.message ? verify.message : 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            return;
        }
        if (currentWeekIndex >= 0) saveCurrentWeekData();
        saveToLocalStorage();
        saveDataToServer().then(function(result) {
            if (result && result.success) {
                const displayText = result.savedAt ? formatSavedAtDisplay(result.savedAt) : formatSavedAtDisplay(new Date().toISOString());
                setLastServerSaveTime(displayText);
            }
            alert('ì„œë²„ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        });
    })
    .catch(function(err) {
        console.error(err);
        alert('ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° (ì„œë²„ ë°ì´í„°ë¡œ ë¡œì»¬ ë®ì–´ì“°ê¸°)
function loadFromServer() {
    if (!confirm('ì„œë²„ì— ì €ì¥ëœ ë°ì´í„°ë¡œ ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ ë¡œì»¬ì—ë§Œ ìˆëŠ” ìˆ˜ì • ë‚´ìš©ì€ ì‚¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.')) return;
    localStorage.setItem('main_doLoadFromServer', '1');
    location.reload();
}

// íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
function loadFromFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const loaded = JSON.parse(e.target.result);
            Object.assign(state, loaded);
            if (loaded.currentWeek) state.currentWeek = new Date(loaded.currentWeek);
            updateWeekDisplay();
            renderPreferences();
            renderAll();
            alert('íŒŒì¼ì„ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
        } catch (err) {
            alert('íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
        }
    };
    reader.readAsText(file);
}

// ì—‘ì…€ ë‚´ë³´ë‚´ê¸°
function exportToExcel() {
    const wb = XLSX.utils.book_new();
    
    // ê³ ì • êµê³¼ ì‹œíŠ¸
    const masterData = [];
    masterData.push(['ê³ ì • êµê³¼ ì„¤ì •']);
    state.subjectSheets.forEach(sheet => {
        masterData.push([`[${sheet.subName}] ê³ ì • ì‹œê°„í‘œ`]);
        masterData.push(['êµì‹œ', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ']);
        for (let r = 0; r < state.periodCount; r++) {
            const row = [r + 1];
            for (let c = 0; c < 5; c++) {
                const key = `${r}-${c}`;
                const classes = sheet.rules[key] || [];
                row.push(classes.length > 0 ? classes.join(',') + 'ë°˜' : '');
            }
            masterData.push(row);
        }
        masterData.push([]);
    });
    const masterWs = XLSX.utils.aoa_to_sheet(masterData);
    XLSX.utils.book_append_sheet(wb, masterWs, 'ê³ ì •êµê³¼');
    
    // í†µí•© ì‹œê°„í‘œ ì‹œíŠ¸ (ëª¨ë“  ë°˜ì„ í•˜ë‚˜ì˜ ì‹œíŠ¸ì—)
    const timetableData = [];
    
    // ë¨¼ì € ëª¨ë“  ë°˜ì˜ ì‹œê°„í‘œ ë°ì´í„° ì¶œë ¥
    for (let i = 1; i <= state.classCount; i++) {
        if (!state.classData[i]) continue;
        const data = state.classData[i];
        
        // ë°˜ êµ¬ë¶„ì„  ë° í—¤ë”
        if (i > 1) {
            timetableData.push([]); // ë¹ˆ ì¤„ë¡œ êµ¬ë¶„
        }
        timetableData.push([`${i}ë°˜ ì‹œê°„í‘œ`]);
        timetableData.push(['êµì‹œ', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ']);
        
        // ì‹œê°„í‘œ ë°ì´í„°
        for (let r = 0; r < state.periodCount; r++) {
            const row = [r + 1];
            for (let c = 0; c < 5; c++) {
                const key = `${r}-${c}`;
                let fixedSub = null;
                state.subjectSheets.forEach(sheet => {
                    if (sheet.rules[key] && sheet.rules[key].includes(i)) fixedSub = sheet.subName;
                });
                row.push(fixedSub || data.timetable[r][c] || '');
            }
            timetableData.push(row);
        }
        
        // ë©”ëª¨
        if (data.memo) {
            timetableData.push([]);
            timetableData.push(['ë©”ëª¨', data.memo]);
        }
    }
    
    // ë§ˆì§€ë§‰ì— ê³¼ëª©ê³¼ ëª©í‘œì‹œìˆ˜ ì •ë³´ í•œ ë²ˆë§Œ ì¶œë ¥
    timetableData.push([]);
    timetableData.push(['ê³¼ëª©', ...allSubjects]);
    
    // ê° ë°˜ì˜ ëª©í‘œì‹œìˆ˜ ì¶œë ¥
    for (let i = 1; i <= state.classCount; i++) {
        if (!state.classData[i]) continue;
        const data = state.classData[i];
        timetableData.push([`${i}ë°˜ ëª©í‘œì‹œìˆ˜`, ...data.targetHours]);
    }
    
    const timetableWs = XLSX.utils.aoa_to_sheet(timetableData);
    XLSX.utils.book_append_sheet(wb, timetableWs, 'ì‹œê°„í‘œ');
    
    XLSX.writeFile(wb, `ì‹œê°„í‘œ_${new Date().toISOString().split('T')[0]}.xlsx`);
}

// ì—‘ì…€ ë¶ˆëŸ¬ì˜¤ê¸°
function importFromExcel(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            
            // í•™ê¸‰ë³„ ì‹œíŠ¸ ì½ê¸°
            for (let i = 1; i <= state.classCount; i++) {
                const sheetName = `${i}ë°˜`;
                if (!workbook.Sheets[sheetName]) continue;
                
                const ws = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
                
                if (!state.classData[i]) {
                    state.classData[i] = { 
                        timetable: Array(state.periodCount).fill().map(() => Array(5).fill("")), 
                        targetHours: Array(allSubjects.length).fill(0),
                        memo: ""
                    };
                }
                
                // ì‹œê°„í‘œ ì½ê¸° (2í–‰ë¶€í„° ì‹œì‘)
                for (let r = 2; r < 2 + state.periodCount && r - 2 < state.periodCount; r++) {
                    if (!jsonData[r]) continue;
                    for (let c = 1; c < 6 && c - 1 < 5; c++) {
                        const val = jsonData[r][c];
                        if (val && typeof val === 'string') {
                            state.classData[i].timetable[r - 2][c - 1] = val;
                        }
                    }
                }
                
                // ëª©í‘œì‹œìˆ˜ ì½ê¸°
                const targetRow = jsonData.findIndex(row => row && row[0] === 'ëª©í‘œì‹œìˆ˜');
                if (targetRow >= 0 && jsonData[targetRow]) {
                    for (let idx = 0; idx < allSubjects.length && idx + 1 < jsonData[targetRow].length; idx++) {
                        const val = jsonData[targetRow][idx + 1];
                        if (typeof val === 'number') {
                            state.classData[i].targetHours[idx] = val;
                        }
                    }
                }
                
                // ë©”ëª¨ ì½ê¸°
                const memoRow = jsonData.findIndex(row => row && row[0] === 'ë©”ëª¨');
                if (memoRow >= 0 && jsonData[memoRow] && jsonData[memoRow][1]) {
                    state.classData[i].memo = String(jsonData[memoRow][1]);
                }
            }
            
            renderAll();
            alert('ì—‘ì…€ íŒŒì¼ì„ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
        } catch (err) {
            alert('ì—‘ì…€ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
        }
    };
    reader.readAsArrayBuffer(file);
}

function updateClassCount(val) {
    state.classCount = parseInt(val);
    saveAndRefresh();
}

// ê³ ì • ì‹œê°„í‘œ ë˜ëŒë¦¬ê¸°ìš©: ìµœëŒ€ 10ë‹¨ê³„ê¹Œì§€ ì €ì¥
const MASTER_UNDO_MAX = 10;
let masterUndoStack = [];
function pushUndoStateForMaster() {
    masterUndoStack.push({
        subjectSheets: JSON.parse(JSON.stringify(state.subjectSheets)),
        classData: JSON.parse(JSON.stringify(state.classData))
    });
    if (masterUndoStack.length > MASTER_UNDO_MAX) masterUndoStack.shift();
}
function undoLastMasterAction() {
    if (masterUndoStack.length === 0) {
        alert('ë˜ëŒë¦´ ë™ì‘ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    const prev = masterUndoStack.pop();
    state.subjectSheets = prev.subjectSheets;
    state.classData = prev.classData;
    saveCurrentWeekData();
    saveAndRefresh();
}

function addSubjectSheet() {
    pushUndoStateForMaster();
    const name = document.getElementById('newSubName').value;
    if (!name) return alert("ê³¼ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    const tag = document.getElementById('newSubTag').value.trim();
    state.subjectSheets.push({ subName: name, tag: tag, memo: "", rules: {} });
    document.getElementById('newSubName').value = '';
    document.getElementById('newSubTag').value = '';
    saveAndRefresh();
}

function deleteSheet(idx) {
    if(confirm("í•´ë‹¹ êµê³¼ ê³ ì • ì„¤ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        pushUndoStateForMaster();
        const sheet = state.subjectSheets[idx];
        
        // ì‚­ì œë  ê³ ì • ì‹œíŠ¸ì˜ ëª¨ë“  ê·œì¹™ì— ëŒ€í•´ í•´ë‹¹ ì…€ì˜ ë‚´ìš© ì‚­ì œ
        Object.keys(sheet.rules || {}).forEach(key => {
            const [r, c] = key.split('-').map(Number);
            const classNums = sheet.rules[key] || [];
            
            classNums.forEach(classNum => {
                // ë‹¤ë¥¸ ê³ ì • ì‹œíŠ¸ì—ì„œë„ ê°™ì€ ì…€ì„ ì‚¬ìš©í•˜ëŠ”ì§€ í™•ì¸
                let isStillFixed = false;
                state.subjectSheets.forEach((otherSheet, otherIdx) => {
                    if (otherIdx !== idx && otherSheet.rules[key] && otherSheet.rules[key].includes(classNum)) {
                        isStillFixed = true;
                    }
                });
                
                // ë” ì´ìƒ ê³ ì •ë˜ì§€ ì•Šìœ¼ë©´ ì…€ ë‚´ìš© ì‚­ì œ
                if (!isStillFixed && state.classData[classNum]) {
                    state.classData[classNum].timetable[r][c] = '';
                }
            });
        });
        
        state.subjectSheets.splice(idx, 1);
        saveAndRefresh();
    }
}

// ê³ ì • ì‹œíŠ¸ ë Œë”ë§
function renderMasterSheets() {
    const container = document.getElementById('masterSheetsContainer');
    container.innerHTML = '';

    state.subjectSheets.forEach((sheet, sIdx) => {
        const div = document.createElement('div');
        div.className = 'master-sheet';
        const titleCls = getSubjectClass(sheet.subName);
        const tagDisplay = sheet.tag ? ` <span style="color: #666; font-size: 12px;">${sheet.tag}</span>` : '';
        let html = `<h3><span class="${titleCls}">[${sheet.subName}]</span>${tagDisplay} ê³ ì • ì‹œê°„í‘œ <button class="btn btn-del" onclick="deleteSheet(${sIdx})">ì‚­ì œ</button></h3>`;
        html += `<table><thead><tr><th>êµì‹œ</th>${days.map((d, idx) => {
            return `<th class="day-header" onclick="clearMasterSheetColumn(${sIdx}, ${idx})" style="cursor: pointer; user-select: none;" title="í´ë¦­í•˜ë©´ ì´ ê³ ì •í‘œì˜ ${d}ìš”ì¼ ì—´ë§Œ ì‚­ì œë©ë‹ˆë‹¤">${d}</th>`;
        }).join('')}</tr></thead><tbody>`;
        
        for (let r = 0; r < state.periodCount; r++) {
            html += `<tr><th>${r+1}</th>`;
            for (let c = 0; c < 5; c++) {
                const key = `${r}-${c}`;
                const selected = sheet.rules[key] || [];
                html += `<td class="master-td draggable-cell" 
                            draggable="true"
                            onclick="showClassSelector(event, ${sIdx}, ${r}, ${c})"
                            ondragstart="handleMasterDragStart(event, ${sIdx}, ${r}, ${c})"
                            ondragover="handleMasterDragOver(event)"
                            ondrop="handleMasterDrop(event, ${sIdx}, ${r}, ${c})"
                            ondragend="handleMasterDragEnd(event)">
                            <span class="selected-classes">${selected.length > 0 ? selected.join(',') + 'ë°˜' : '+'}</span>
                         </td>`;
            }
            html += `</tr>`;
        }
        html += `</tbody></table>`;
        html += `<textarea placeholder="${sheet.subName} êµê³¼ ê´€ë ¨ ê³µì§€/ë©”ëª¨..." onchange="updateSheetMemo(${sIdx}, this.value)">${sheet.memo || ""}</textarea>`;
        div.innerHTML = html;
        container.appendChild(div);
    });
}

function updateSheetMemo(idx, val) {
    pushUndoStateForMaster();
    state.subjectSheets[idx].memo = val;
    saveAndRefresh(false);
}

// ê³ ì • ì‹œíŠ¸ì—ì„œ ìš”ì¼ í´ë¦­ ì‹œ í•´ë‹¹ í‘œì˜ í•´ë‹¹ ì—´ë§Œ ì‚­ì œ (í•˜ë‹¨ ì‹œê°„í‘œÂ·ë¹„í™œì„±í™”ì™€ ë¬´ê´€)
function clearMasterSheetColumn(sheetIdx, dayIdx) {
    if (sheetIdx < 0 || sheetIdx >= state.subjectSheets.length) return;
    pushUndoStateForMaster();
    const sheet = state.subjectSheets[sheetIdx];
    if (!sheet.rules) return;
    for (let r = 0; r < state.periodCount; r++) {
        const key = `${r}-${dayIdx}`;
        const classNums = sheet.rules[key] || [];
        classNums.forEach(classNum => {
            let isStillFixed = false;
            state.subjectSheets.forEach((other, otherIdx) => {
                if (otherIdx !== sheetIdx && other.rules && other.rules[key] && other.rules[key].includes(classNum)) {
                    isStillFixed = true;
                }
            });
            if (!isStillFixed && state.classData[classNum] && state.classData[classNum].timetable) {
                state.classData[classNum].timetable[r][dayIdx] = '';
            }
        });
        delete sheet.rules[key];
    }
    saveCurrentWeekData();
    saveAndRefresh();
}

// í•™ê¸‰ ì„ íƒ íŒì—…
function showClassSelector(event, sIdx, r, c) {
    event.stopPropagation();
    const selector = document.getElementById('globalClassSelector');
    const key = `${r}-${c}`;
    const selectedClasses = state.subjectSheets[sIdx].rules[key] || [];

    // ë‹¤ë¥¸ ì „ë‹´ ê³ ì •í‘œì˜ ê°™ì€ ì¢Œí‘œì— ì´ë¯¸ ì„ íƒëœ ë°˜ ì°¾ê¸°
    const occupiedClasses = new Set();
    state.subjectSheets.forEach((sheet, idx) => {
        if (idx !== sIdx && sheet.rules[key]) {
            sheet.rules[key].forEach(classNum => {
                occupiedClasses.add(classNum);
            });
        }
    });

    let html = `<strong>ëŒ€ìƒ í•™ê¸‰</strong><hr>`;
    for (let i = 1; i <= state.classCount; i++) {
        const checked = selectedClasses.includes(i) ? 'checked' : '';
        const disabled = occupiedClasses.has(i) && !selectedClasses.includes(i) ? 'disabled' : '';
        const disabledText = occupiedClasses.has(i) && !selectedClasses.includes(i) ? ' (ë‹¤ë¥¸ ê³ ì • ì‹œê°„í‘œì—ì„œ ì‚¬ìš© ì¤‘)' : '';
        const style = disabled ? 'style="opacity: 0.5; cursor: not-allowed;"' : '';
        html += `<label ${style}><input type="checkbox" value="${i}" ${checked} ${disabled} onchange="toggleRule(${sIdx}, ${r}, ${c}, ${i}, this.checked)"> ${i}ë°˜${disabledText}</label>`;
    }
    html += `<hr><button class="btn" style="width:100%; font-size:11px;" onclick="closeSelector()">ë‹«ê¸°</button>`;
    
    selector.innerHTML = html;
    selector.style.display = 'block';
    selector.style.left = (event.pageX + 10) + 'px';
    selector.style.top = (event.pageY + 10) + 'px';
}

function toggleRule(sIdx, r, c, classNum, isChecked) {
    pushUndoStateForMaster();
    const key = `${r}-${c}`;
    if (!state.subjectSheets[sIdx].rules[key]) state.subjectSheets[sIdx].rules[key] = [];
    
    if (isChecked) {
        // ë‹¤ë¥¸ ì „ë‹´ ê³ ì •í‘œì˜ ê°™ì€ ì¢Œí‘œì— ì´ë¯¸ ì„ íƒëœ ë°˜ì¸ì§€ í™•ì¸
        let isOccupied = false;
        state.subjectSheets.forEach((sheet, idx) => {
            if (idx !== sIdx && sheet.rules[key] && sheet.rules[key].includes(classNum)) {
                isOccupied = true;
            }
        });
        
        if (isOccupied) {
            alert(`${classNum}ë°˜ì€ ë‹¤ë¥¸ ê³ ì • ì‹œê°„í‘œì—ì„œ ì´ë¯¸ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤.`);
            // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë˜ëŒë¦¬ê¸°
            const selector = document.getElementById('globalClassSelector');
            const checkbox = selector.querySelector(`input[value="${classNum}"]`);
            if (checkbox) checkbox.checked = false;
            return;
        }
        
        if (!state.subjectSheets[sIdx].rules[key].includes(classNum)) {
            state.subjectSheets[sIdx].rules[key].push(classNum);
        }
    } else {
        // ì²´í¬ í•´ì œ ì‹œ: í•´ë‹¹ ì…€ì˜ ë‚´ìš© ì‚­ì œ
        state.subjectSheets[sIdx].rules[key] = state.subjectSheets[sIdx].rules[key].filter(n => n !== classNum);
        
        // í•´ë‹¹ ì…€ì´ ë” ì´ìƒ ê³ ì •ë˜ì§€ ì•Šìœ¼ë©´ ë‚´ìš© ì‚­ì œ
        let isStillFixed = false;
        state.subjectSheets.forEach((sheet, idx) => {
            if (sheet.rules[key] && sheet.rules[key].includes(classNum)) {
                isStillFixed = true;
            }
        });
        
        if (!isStillFixed && state.classData[classNum]) {
            state.classData[classNum].timetable[r][c] = '';
        }
    }
    saveAndRefresh();
}

function closeSelector() { document.getElementById('globalClassSelector').style.display = 'none'; }

// ê³¼ëª© ì„ íƒ íŒì—…
function showSubjectSelector(event, classNum, r, c) {
    event.stopPropagation();
    const selector = document.getElementById('globalSubjectSelector');
    const cellValue = state.classData[classNum].timetable[r][c] || '';

    let html = `<strong>ê³¼ëª© ì„ íƒ</strong><hr>`;
    html += `<label><input type="checkbox" value="" ${cellValue === '' ? 'checked' : ''} onchange="updateCellFromCheckbox(${classNum}, ${r}, ${c}, '', this.checked)"> (ì—†ìŒ)</label>`;
    allSubjects.forEach(sub => {
        const checked = cellValue === sub ? 'checked' : '';
        html += `<label><input type="checkbox" value="${sub}" ${checked} onchange="updateCellFromCheckbox(${classNum}, ${r}, ${c}, '${sub}', this.checked)"> ${sub}</label>`;
    });
    html += `<hr><button class="btn" style="width:100%; font-size:11px;" onclick="closeSubjectSelector()">ë‹«ê¸°</button>`;
    
    selector.innerHTML = html;
    selector.style.display = 'block';
    selector.style.left = (event.pageX + 10) + 'px';
    selector.style.top = (event.pageY + 10) + 'px';
}

function updateCellFromCheckbox(classNum, r, c, subject, isChecked) {
    // ë‹¤ë¥¸ ì²´í¬ë°•ìŠ¤ ëª¨ë‘ í•´ì œ
    const checkboxes = document.querySelectorAll('#globalSubjectSelector input[type="checkbox"]');
    checkboxes.forEach(cb => {
        if (cb.value !== subject) cb.checked = false;
    });
    
    if (isChecked) {
        state.classData[classNum].timetable[r][c] = subject;
    } else {
        state.classData[classNum].timetable[r][c] = '';
    }
    
    // ì…€ ì—…ë°ì´íŠ¸
    const cell = document.getElementById(`cell-${classNum}-${r}-${c}`);
    if (cell) {
        const span = cell.querySelector('.selected-subject');
        if (span) span.textContent = subject || '-';
    }
    
    saveAndRefresh(false);
    calculateUnifiedStatus(classNum);
    closeSubjectSelector();
}

function closeSubjectSelector() { 
    document.getElementById('globalSubjectSelector').style.display = 'none'; 
}

// í•™ê¸‰ ì‹œê°„í‘œ ë Œë”ë§
function renderClassGrid() {
    const grid = document.getElementById('classGrid');
    grid.innerHTML = '';

    for (let i = 1; i <= state.classCount; i++) {
        if (!state.classData[i]) {
            state.classData[i] = { timetable: Array(state.periodCount).fill().map(() => Array(5).fill("")), targetHours: Array(allSubjects.length).fill(0), memo: "" };
        }
        grid.appendChild(createClassCard(i));
    }
    
    renderUnifiedHoursTable();
    renderUnifiedMemo();
}

function createClassCard(num) {
    const data = state.classData[num];
    if (!data.memo) data.memo = '';
    const card = document.createElement('div');
    card.className = 'class-card';
    card.id = `card-${num}`;
    
    let html = `<h3>${num}ë°˜ <button class="btn btn-clear" onclick="clearClassTimetable(${num})">ì‚­ì œ</button> <button class="btn btn-auto" onclick="autoFill(${num})">ìë™ ì±„ìš°ê¸°</button> <span class="badge" id="badge-${num}">ì™„ë£Œ</span></h3>`;
    html += `<table><thead><tr><th>êµì‹œ</th>${days.map((d, idx) => {
        const disabledDays = state.disabledDays || {};
        const isDisabled = disabledDays[d] === true;
        const dayClass = isDisabled ? 'disabled-day-header' : 'day-header';
        return `<th class="${dayClass}" onclick="toggleDayColumn(${idx})" style="cursor: pointer; user-select: none;" title="í´ë¦­í•˜ì—¬ ${d}ìš”ì¼ ì—´ ë¹„í™œì„±í™”/í™œì„±í™”">${d}</th>`;
    }).join('')}</tr></thead><tbody>`;

    for (let r = 0; r < state.periodCount; r++) {
        html += `<tr><th>${r+1}</th>`;
        for (let c = 0; c < 5; c++) {
            const key = `${r}-${c}`;
            let fixedSub = null;
            state.subjectSheets.forEach(sheet => {
                if (sheet.rules[key] && sheet.rules[key].includes(num)) fixedSub = sheet.subName;
            });

            // ìš”ì¼ë³„ ë¹„í™œì„±í™” ë° ìˆ˜ì—… ìˆ˜ ì œí•œ í™•ì¸
            const dayName = days[c];
            const isDayDisabled = state.disabledDays && state.disabledDays[dayName] === true;
            const dayLimit = state.dayPeriodLimits && state.dayPeriodLimits[dayName];
            const isPeriodDisabled = dayLimit !== undefined && dayLimit !== null && (r + 1) > dayLimit;

            if (fixedSub) {
                const cls = getSubjectClass(fixedSub);
                const disabledClass = (isDayDisabled || isPeriodDisabled) ? ' disabled-cell' : '';
                html += `<td class="fixed-cell ${cls}${disabledClass}">${fixedSub}</td>`;
                data.timetable[r][c] = fixedSub;
            } else {
                const cellId = `cell-${num}-${r}-${c}`;
                const cellValue = data.timetable[r][c] || '';
                const cls = cellValue ? getSubjectClass(cellValue) : '';
                const disabledClass = (isDayDisabled || isPeriodDisabled) ? ' disabled-cell' : '';
                const disabledAttr = (isDayDisabled || isPeriodDisabled) ? ' style="opacity: 0.3; pointer-events: none; cursor: not-allowed;"' : '';
                html += `<td class="subject-cell draggable-cell ${cls}${disabledClass}" id="${cellId}" draggable="${!(isDayDisabled || isPeriodDisabled)}" 
                    ${disabledAttr}
                    onclick="${(isDayDisabled || isPeriodDisabled) ? '' : `showSubjectSelector(event, ${num}, ${r}, ${c})`}"
                    ondragstart="${(isDayDisabled || isPeriodDisabled) ? '' : `handleDragStart(event, ${num}, ${r}, ${c})`}"
                    ondragover="${(isDayDisabled || isPeriodDisabled) ? '' : 'handleDragOver(event)'}"
                    ondrop="${(isDayDisabled || isPeriodDisabled) ? '' : `handleDrop(event, ${num}, ${r}, ${c})`}"
                    ondragend="${(isDayDisabled || isPeriodDisabled) ? '' : 'handleDragEnd(event)'}">
                    <span class="selected-subject">${cellValue || '-'}</span>
                </td>`;
            }
        }
        html += `</tr>`;
    }
    html += `</tbody></table>`;
    
    card.innerHTML = html;
    setTimeout(() => {
        calculateUnifiedStatus(num);
    }, 0);
    return card;
}

function updateClassMemo(classNum, val) {
    if (!state.classData[classNum]) return;
    state.classData[classNum].memo = val;
    saveAndRefresh(false);
}

// í†µí•© ë©”ëª¨ì°½ ë Œë”ë§
function renderUnifiedMemo() {
    const container = document.getElementById('unifiedMemoContent');
    if (!container) return;
    
    container.innerHTML = `
        <textarea 
            placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." 
            onchange="updateMemo(this.value)"
            style="width: 600px; max-width: 100%; min-height: 40px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; font-family: inherit; resize: vertical;">${state.memo || ""}</textarea>
    `;
}

function updateMemo(val) {
    state.memo = val;
    saveAndRefresh(false);
}

// ë“œë˜ê·¸ ì•¤ ë“œë¡­ í•¨ìˆ˜ë“¤
let dragSource = null;

function handleDragStart(e, classNum, r, c) {
    const key = `${r}-${c}`;
    let fixedSub = null;
    state.subjectSheets.forEach(sheet => {
        if (sheet.rules[key] && sheet.rules[key].includes(classNum)) fixedSub = sheet.subName;
    });
    
    if (fixedSub) {
        e.preventDefault();
        return false;
    }
    
    dragSource = { classNum, r, c, value: state.classData[classNum].timetable[r][c] };
    e.dataTransfer.effectAllowed = 'move';
    e.currentTarget.classList.add('dragging');
}

function handleDragOver(e) {
    if (dragSource) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        e.currentTarget.classList.add('drag-over');
    }
}

function handleDrop(e, classNum, r, c) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');
    
    if (!dragSource) return;
    
    const source = dragSource;
    const targetKey = `${r}-${c}`;
    
    // ê³ ì •ëœ ì…€ì¸ì§€ í™•ì¸
    let targetFixed = false;
    state.subjectSheets.forEach(sheet => {
        if (sheet.rules[targetKey] && sheet.rules[targetKey].includes(classNum)) targetFixed = true;
    });
    
    if (targetFixed || source.classNum !== classNum) return;
    
    // ê°’ êµí™˜
    const sourceValue = state.classData[classNum].timetable[source.r][source.c];
    const targetValue = state.classData[classNum].timetable[r][c];
    
    state.classData[classNum].timetable[source.r][source.c] = targetValue;
    state.classData[classNum].timetable[r][c] = sourceValue;
    
    // ìƒ‰ìƒ í´ë˜ìŠ¤ ì—…ë°ì´íŠ¸
    const sourceCell = document.getElementById(`cell-${classNum}-${source.r}-${source.c}`);
    const targetCell = document.getElementById(`cell-${classNum}-${r}-${c}`);
    
    if (sourceCell) {
        const oldCls = sourceCell.className.match(/subject-\w+/g);
        if (oldCls) oldCls.forEach(cls => sourceCell.classList.remove(cls));
        const newCls = getSubjectClass(targetValue);
        if (newCls) sourceCell.classList.add(newCls);
        const span = sourceCell.querySelector('.selected-subject');
        if (span) span.textContent = targetValue || '-';
    }
    
    if (targetCell) {
        const oldCls = targetCell.className.match(/subject-\w+/g);
        if (oldCls) oldCls.forEach(cls => targetCell.classList.remove(cls));
        const newCls = getSubjectClass(sourceValue);
        if (newCls) targetCell.classList.add(newCls);
        const span = targetCell.querySelector('.selected-subject');
        if (span) span.textContent = sourceValue || '-';
    }
    
    saveAndRefresh();
}

function handleDragEnd(e) {
    e.currentTarget.classList.remove('dragging');
    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
    dragSource = null;
}

// ê³ ì • ì‹œê°„í‘œ ë“œë˜ê·¸ ì•¤ ë“œë¡­ í•¨ìˆ˜ë“¤
let masterDragSource = null;

function handleMasterDragStart(e, sIdx, r, c) {
    const key = `${r}-${c}`;
    const selected = state.subjectSheets[sIdx].rules[key] || [];
    
    masterDragSource = { sIdx, r, c, selected: [...selected] };
    e.dataTransfer.effectAllowed = 'move';
    e.currentTarget.classList.add('dragging');
}

function handleMasterDragOver(e) {
    if (masterDragSource) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        e.currentTarget.classList.add('drag-over');
    }
}

function handleMasterDrop(e, sIdx, r, c) {
    e.preventDefault();
    e.stopPropagation();
    e.currentTarget.classList.remove('drag-over');
    
    if (!masterDragSource) return;
    
    const source = masterDragSource;
    
    // ê°™ì€ ì‹œíŠ¸ ë‚´ì—ì„œë§Œ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê°€ëŠ¥
    if (source.sIdx !== sIdx) return;
    
    pushUndoStateForMaster();
    
    const sourceKey = `${source.r}-${source.c}`;
    const targetKey = `${r}-${c}`;
    
    const sourceRules = state.subjectSheets[sIdx].rules[sourceKey] || [];
    const targetRules = state.subjectSheets[sIdx].rules[targetKey] || [];
    
    // rules êµí™˜
    state.subjectSheets[sIdx].rules[sourceKey] = [...targetRules];
    state.subjectSheets[sIdx].rules[targetKey] = [...sourceRules];
    
    // ë¹ˆ ë°°ì—´ì´ë©´ í‚¤ ì‚­ì œ
    if (state.subjectSheets[sIdx].rules[sourceKey].length === 0) {
        delete state.subjectSheets[sIdx].rules[sourceKey];
    }
    if (state.subjectSheets[sIdx].rules[targetKey].length === 0) {
        delete state.subjectSheets[sIdx].rules[targetKey];
    }
    
    // ì˜®ê²¨ì§„ ìë¦¬(ë¹ˆ ìë¦¬)ê°€ ë˜ë©´ í•™ê¸‰ë³„ ì‹œê°„í‘œì—ì„œ í•´ë‹¹ ì…€ ê³µë€ ì²˜ë¦¬
    sourceRules.forEach(classNum => {
        if (state.classData[classNum]) {
            state.classData[classNum].timetable[source.r][source.c] = '';
        }
    });
    targetRules.forEach(classNum => {
        if (state.classData[classNum]) {
            state.classData[classNum].timetable[r][c] = '';
        }
    });
    
    saveAndRefresh();
}

function handleMasterDragEnd(e) {
    e.currentTarget.classList.remove('dragging');
    document.querySelectorAll('.master-td.drag-over').forEach(el => el.classList.remove('drag-over'));
    masterDragSource = null;
}

function updateCell(classNum, r, c, val) {
    state.classData[classNum].timetable[r][c] = val;
    saveAndRefresh(false);
    calculateUnifiedStatus(classNum);
}

function updateHour(classNum, idx, val) {
    // ëª©í‘œì‹œìˆ˜ëŠ” ëª¨ë“  ë°˜ì— ë™ì¼í•˜ê²Œ ì ìš© (1ë°˜ ê²ƒë§Œ ì‚¬ìš©)
    const targetValue = parseInt(val) || 0;
    for (let i = 1; i <= state.classCount; i++) {
        if (state.classData[i]) {
            state.classData[i].targetHours[idx] = targetValue;
        }
    }
    saveAndRefresh(false);
    // ëª©í‘œì‹œìˆ˜ í•©ê³„ ì—…ë°ì´íŠ¸
    updateTargetHoursSum();
    // ëª¨ë“  ë°˜ì˜ ë‹¬ì„±ë„ ì¬ê³„ì‚°
    for (let i = 1; i <= state.classCount; i++) {
        if (state.classData[i]) {
            calculateUnifiedStatus(i);
        }
    }
}

// ìë™ ì±„ìš°ê¸° ë¡œì§ (ì„ í˜¸êµì‹œ ê³ ë ¤)
function autoFill(num) {
    const data = state.classData[num];
    const needed = [];

    // 1. ê° ê³¼ëª©ë³„ë¡œ ë” ì±„ì›Œì•¼ í•  ê°œìˆ˜ ë¦¬ìŠ¤íŠ¸ì—… (1ë°˜ì˜ ëª©í‘œì‹œìˆ˜ ì‚¬ìš©)
    const targetHoursRef = state.classData[1] ? state.classData[1].targetHours : data.targetHours;
    allSubjects.forEach((sub, idx) => {
        let count = 0;
        for(let r=0; r<state.periodCount; r++) {
            for(let c=0; c<5; c++) {
                const key = `${r}-${c}`;
                let fixed = false;
                state.subjectSheets.forEach(sheet => { if(sheet.rules[key] && sheet.rules[key].includes(num)) fixed=true; });
                if(fixed) { 
                    let fixedName = "";
                    state.subjectSheets.forEach(sheet => { if(sheet.rules[key] && sheet.rules[key].includes(num)) fixedName = sheet.subName; });
                    if(fixedName === sub) count++;
                } else if(data.timetable[r][c] === sub) count++;
            }
        }
        let diff = targetHoursRef[idx] - count;
        for(let k=0; k<diff; k++) needed.push({sub, idx});
    });

    // 2. ë¹„ì–´ìˆëŠ”(í™œì„±í™”ëœ) ì¹¸ ì°¾ê¸° (ì„ í˜¸êµì‹œ ìš°ì„ ìˆœìœ„ ì ìš©)
    const emptySlots = [];
    for(let r=0; r<state.periodCount; r++) {
        for(let c=0; c<5; c++) {
            const key = `${r}-${c}`;
            let fixed = false;
            state.subjectSheets.forEach(sheet => { if(sheet.rules[key] && sheet.rules[key].includes(num)) fixed=true; });
            
            // ë¹„í™œì„±í™”ëœ ì…€ í™•ì¸
            const dayName = days[c];
            const isDayDisabled = state.disabledDays && state.disabledDays[dayName] === true;
            const dayLimit = state.dayPeriodLimits && state.dayPeriodLimits[dayName];
            const isPeriodDisabled = dayLimit !== undefined && dayLimit !== null && (r + 1) > dayLimit;
            const isDisabled = isDayDisabled || isPeriodDisabled;
            
            if(!fixed && !isDisabled && data.timetable[r][c] === "") {
                emptySlots.push({r, c, period: r+1});
            }
        }
    }

    // 3. ì„ í˜¸êµì‹œë¥¼ ê³ ë ¤í•œ ë°°ì¹˜
    // ì„ í˜¸êµì‹œê°€ ìˆëŠ” ê³¼ëª©ì„ ë¨¼ì € ë°°ì¹˜
    const preferred = [];
    const nonPreferred = [];
    
    needed.forEach(item => {
        const prefs = state.preferences[item.sub] || [];
        if (prefs.length > 0) {
            preferred.push(item);
        } else {
            nonPreferred.push(item);
        }
    });
    
    // ì„ í˜¸êµì‹œê°€ ìˆëŠ” ê³¼ëª© ë°°ì¹˜
    preferred.forEach(item => {
        const prefs = state.preferences[item.sub] || [];
        const availableSlots = emptySlots.filter(slot => prefs.includes(slot.period));
        if (availableSlots.length > 0) {
            const slot = availableSlots[Math.floor(Math.random() * availableSlots.length)];
            data.timetable[slot.r][slot.c] = item.sub;
            const idx = emptySlots.findIndex(s => s.r === slot.r && s.c === slot.c);
            if (idx >= 0) emptySlots.splice(idx, 1);
        }
    });
    
    // ë‚˜ë¨¸ì§€ ê³¼ëª© ëœë¤ ë°°ì¹˜ (1ë°˜ì˜ ëª©í‘œì‹œìˆ˜ ì‚¬ìš©)
    const remaining = [...preferred, ...nonPreferred].filter(item => {
        let count = 0;
        for(let r=0; r<state.periodCount; r++) {
            for(let c=0; c<5; c++) {
                const key = `${r}-${c}`;
                let fixedSub = null;
                state.subjectSheets.forEach(sheet => { 
                    if (sheet.rules[key] && sheet.rules[key].includes(num)) fixedSub = sheet.subName; 
                });
                const currentVal = fixedSub || data.timetable[r][c];
                if(currentVal === item.sub) count++;
            }
        }
        return count < targetHoursRef[item.idx];
    });
    
    // ë¹„í™œì„±í™”ëœ ì…€ ì œì™¸í•˜ê³  ë°°ì¹˜
    const availableSlotsForRemaining = emptySlots.filter(slot => {
        const dayName = days[slot.c];
        const isDayDisabled = state.disabledDays && state.disabledDays[dayName] === true;
        const dayLimit = state.dayPeriodLimits && state.dayPeriodLimits[dayName];
        const isPeriodDisabled = dayLimit !== undefined && dayLimit !== null && (slot.r + 1) > dayLimit;
        return !isDayDisabled && !isPeriodDisabled;
    });
    
    remaining.sort(() => Math.random() - 0.5);
    availableSlotsForRemaining.forEach((slot, i) => {
        if(remaining[i]) data.timetable[slot.r][slot.c] = remaining[i].sub;
    });

    saveAndRefresh();
}


function renderAll() { 
    renderMasterSheets(); 
    renderClassGrid();
    renderUnifiedHoursTable();
}

// í†µí•© ì£¼ê°„ ì‹œìˆ˜ ë° ë‹¬ì„±ë„ í‘œ ë Œë”ë§
function renderUnifiedHoursTable() {
    const container = document.getElementById('unifiedHoursTable');
    if (!container) return;
    
    // 1ë°˜ ë°ì´í„° ì‚¬ìš© (ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ í•™ê¸‰)
    const firstClass = state.classData[1] || state.classData[Object.keys(state.classData)[0]];
    if (!firstClass) {
        container.innerHTML = '<p>í•™ê¸‰ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }
    
    let html = '<table><thead><tr><th>êµ¬ë¶„</th>';
    html += allSubjects.map(s => {
        const cls = getSubjectClass(s);
        return cls ? `<th class="${cls}">${s}</th>` : `<th>${s}</th>`;
    }).join('');
    html += '<th>í•©ê³„</th></tr></thead><tbody>';
    
    // í–‰1: ëª©í‘œì‹œìˆ˜ (1ë°˜ ê²ƒ ì‚¬ìš©)
    html += '<tr id="target-hours-row"><th>ëª©í‘œì‹œìˆ˜</th>';
    html += allSubjects.map((s, idx) => {
        return `<td><input type="number" value="${firstClass.targetHours[idx]}" style="width:100%" onchange="updateHour(1, ${idx}, this.value)"></td>`;
    }).join('');
    html += '<td id="target-hours-sum" style="font-weight:bold">0</td>';
    html += '</tr>';
    
    // ê° ë°˜ì˜ ë‹¬ì„±ë„ í–‰
    for (let i = 1; i <= state.classCount; i++) {
        if (!state.classData[i]) continue;
        const remainId = `unified-remain-${i}`;
        html += `<tr id="${remainId}" style="font-weight:bold"><th>${i}ë°˜</th>`;
        html += allSubjects.map(() => `<td>0</td>`).join('');
        html += `<td id="remain-sum-${i}" style="font-weight:bold">0</td>`;
        html += '</tr>';
    }
    
    html += '</tbody></table>';
    container.innerHTML = html;
    
    // ëª©í‘œì‹œìˆ˜ í•©ê³„ ê³„ì‚°
    updateTargetHoursSum();
    
    // ê° ë°˜ì˜ ë‹¬ì„±ë„ ê³„ì‚°
    for (let i = 1; i <= state.classCount; i++) {
        if (state.classData[i]) {
            calculateUnifiedStatus(i);
        }
    }
}

function calculateUnifiedStatus(classNum) {
    const data = state.classData[classNum];
    const remainRow = document.getElementById(`unified-remain-${classNum}`);
    if (!remainRow) return;
    
    const cells = remainRow.cells;
    let allDone = true;
    let sum = 0;

    allSubjects.forEach((sub, idx) => {
        let count = 0;
        for(let r=0; r<state.periodCount; r++) {
            for(let c=0; c<5; c++) {
                const key = `${r}-${c}`;
                let fixedSub = null;
                state.subjectSheets.forEach(sheet => { 
                    if (sheet.rules[key] && sheet.rules[key].includes(classNum)) fixedSub = sheet.subName; 
                });
                const currentVal = fixedSub || data.timetable[r][c];
                if(currentVal === sub) count++;
            }
        }
        const target = state.classData[1] ? state.classData[1].targetHours[idx] : data.targetHours[idx];
        const remain = target - count;
        sum += remain;
        if (cells[idx + 1]) {
            cells[idx + 1].innerText = remain;
            // ëª¨ë“  ê³¼ëª©ì— ë™ì¼í•˜ê²Œ ì ìš©: ëª©í‘œì‹œìˆ˜ê°€ 0ë³´ë‹¤ í¬ê³  ë‹¬ì„±ë„ê°€ 0ì´ë©´ ìƒ‰ ë³€ê²½
            if(target > 0 && remain === 0) {
                cells[idx + 1].className = 'target-zero';
            } else { 
                cells[idx + 1].className = ''; 
                if(remain !== 0) allDone = false; 
            }
        }
    });
    
    // í•©ê³„ ì—…ë°ì´íŠ¸
    const sumCell = document.getElementById(`remain-sum-${classNum}`);
    if (sumCell) {
        sumCell.innerText = sum;
    }
    
    // ì¹´ë“œì˜ ì™„ë£Œ ìƒíƒœë„ ì—…ë°ì´íŠ¸
    const card = document.getElementById(`card-${classNum}`);
    const badge = document.getElementById(`badge-${classNum}`);
    if (card && badge) {
        badge.style.display = allDone ? 'inline' : 'none';
        card.classList.toggle('completed', allDone);
    }
}

// ëª©í‘œì‹œìˆ˜ í•©ê³„ ê³„ì‚°
function updateTargetHoursSum() {
    const firstClass = state.classData[1];
    if (!firstClass) return;
    
    const sum = firstClass.targetHours.reduce((a, b) => a + b, 0);
    const sumCell = document.getElementById('target-hours-sum');
    if (sumCell) {
        sumCell.innerText = sum;
    }
}

// í˜„ì¬ ì„ íƒëœ ì£¼ ì¸ë±ìŠ¤ (í•™ê¸°ë³„ 1ê°œ ë·°ë§Œ ì‚¬ìš©, í•­ìƒ 0)
let currentWeekIndex = 0;

// í•™ê¸‰ ì‹œê°„í‘œ ì‚­ì œ í•¨ìˆ˜
function clearClassTimetable(classNum) {
    if (!confirm(`${classNum}ë°˜ì˜ ì‹œê°„í‘œë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê³ ì •ëœ êµê³¼ëŠ” ì‚­ì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`)) {
        return;
    }
    
    const data = state.classData[classNum];
    if (!data) return;
    
    // ê³ ì •ëœ êµê³¼ë¥¼ ì œì™¸í•˜ê³  ëª¨ë“  ì…€ ë¹„ìš°ê¸°
    for (let r = 0; r < state.periodCount; r++) {
        for (let c = 0; c < 5; c++) {
            const key = `${r}-${c}`;
            let isFixed = false;
            state.subjectSheets.forEach(sheet => {
                if (sheet.rules[key] && sheet.rules[key].includes(classNum)) {
                    isFixed = true;
                }
            });
            
            if (!isFixed) {
                data.timetable[r][c] = '';
            }
        }
    }
    
    saveAndRefresh();
    
    // í†µí•© í‘œì˜ ë‹¬ì„±ë„ ì¬ê³„ì‚°
    calculateUnifiedStatus(classNum);
    
    // ì¹´ë“œ ë‹¤ì‹œ ë Œë”ë§
    const card = document.getElementById(`card-${classNum}`);
    if (card) {
        const grid = document.getElementById('classGrid');
        const newCard = createClassCard(classNum);
        grid.replaceChild(newCard, card);
    }
}
// ìš”ì¼ ë¹„í™œì„±í™” ë²„íŠ¼: ìš”ì¼ ì—´ ë¹„í™œì„±í™”/í™œì„±í™” í† ê¸€ í•¨ìˆ˜ (í˜„ì¬ ì£¼ì—ë§Œ ì ìš©)
function toggleDayColumn(dayIndex) {
    if (currentWeekIndex < 0) return; // ì£¼ê°€ ì„ íƒë˜ì§€ ì•Šì€ ê²½ìš°
    
    const dayName = days[dayIndex];
    if (!state.disabledDays) state.disabledDays = {};
    
    // í† ê¸€
    state.disabledDays[dayName] = !state.disabledDays[dayName];
    
    // ë¹„í™œì„±í™”ëœ ìš”ì¼ì˜ ëª¨ë“  ì…€ ë‚´ìš© ì‚­ì œ
    if (state.disabledDays[dayName]) {
        for (let classNum = 1; classNum <= state.classCount; classNum++) {
            if (state.classData[classNum] && state.classData[classNum].timetable) {
                for (let r = 0; r < state.periodCount; r++) {
                    // ê³ ì •ëœ ì…€ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì‚­ì œ
                    const key = `${r}-${dayIndex}`;
                    let isFixed = false;
                    state.subjectSheets.forEach(sheet => {
                        if (sheet.rules[key] && sheet.rules[key].includes(classNum)) {
                            isFixed = true;
                        }
                    });
                    
                    if (!isFixed) {
                        state.classData[classNum].timetable[r][dayIndex] = '';
                    }
                }
            }
        }
    }
    
    // í˜„ì¬ ì£¼ì˜ ë°ì´í„° ì €ì¥
    saveCurrentWeekData();
    saveAndRefresh();
}

document.addEventListener('click', function(e) {
    if (!e.target.closest('.class-selector') && !e.target.closest('.master-td')) {
        closeSelector();
    }
    if (!e.target.closest('.subject-selector') && !e.target.closest('.subject-cell')) {
        closeSubjectSelector();
    }
});
init();
</script>

</body>
</html>